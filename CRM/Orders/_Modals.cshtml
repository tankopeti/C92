@using Microsoft.AspNetCore.Mvc.Rendering
@using Cloud9_2.Models
@using System.Globalization
@model Cloud9_2.Pages.CRM.Orders.IndexModel

<!-- Create Order Modal -->
<div class="modal fade" id="newOrderModal" tabindex="-1" aria-labelledby="newOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="max-width: 95%;">
        <div class="modal-content">
            <form asp-page-handler="Create" method="post" id="createOrderForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="newOrderModalLabel">Új rendelés</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="__RequestVerificationToken" value="@ViewData["AntiForgeryToken"]" />

                    <!-- Tabs -->
                    <ul class="nav nav-tabs" id="orderTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab" aria-controls="basic" aria-selected="true">Alapadatok</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="items-tab" data-bs-toggle="tab" data-bs-target="#items" type="button" role="tab" aria-controls="items" aria-selected="false">Tételek</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="orderTabContent">
                        <!-- Tab 1: Basic Order Data -->
                        <div class="tab-pane fade show active" id="basic" role="tabpanel" aria-labelledby="basic-tab">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label asp-for="OrderCreateDTO.OrderNumber" class="form-label">Rendelésszám</label>
                                        <input asp-for="OrderCreateDTO.OrderNumber" class="form-control" required />
                                        <span asp-validation-for="OrderCreateDTO.OrderNumber" class="text-danger"></span>
                                    </div>
                                    <div class="mb-3">
                                        <label asp-for="OrderCreateDTO.OrderDate" class="form-label">Rendelés dátuma</label>
                                        <input asp-for="OrderCreateDTO.OrderDate" type="date" class="form-control" required />
                                        <span asp-validation-for="OrderCreateDTO.OrderDate" class="text-danger"></span>
                                    </div>
                                    <div class="mb-3">
                                        <label asp-for="OrderCreateDTO.Deadline" class="form-label">Határidő</label>
                                        <input asp-for="OrderCreateDTO.Deadline" type="date" class="form-control" />
                                        <span asp-validation-for="OrderCreateDTO.Deadline" class="text-danger"></span>
                                    </div>
                                    <div class="mb-3">
                                        <label asp-for="OrderCreateDTO.DeliveryDate" class="form-label">Kiszállítás dátuma</label>
                                        <input asp-for="OrderCreateDTO.DeliveryDate" type="date" class="form-control" />
                                        <span asp-validation-for="OrderCreateDTO.DeliveryDate" class="text-danger"></span>
                                    </div>
                                    <div class="mb-3">
                                        <label asp-for="OrderCreateDTO.PlannedDelivery" class="form-label">Tervezett kiszállítás</label>
                                        <input asp-for="OrderCreateDTO.PlannedDelivery" type="date" class="form-control" />
                                        <span asp-validation-for="OrderCreateDTO.PlannedDelivery" class="text-danger"></span>
                                    </div>
                                    <div class="mb-3">
                                        <label asp-for="OrderCreateDTO.TotalAmount" class="form-label">Összeg</label>
                                        <input asp-for="OrderCreateDTO.TotalAmount" type="number" step="0.01" class="form-control" required />
                                        <span asp-validation-for="OrderCreateDTO.TotalAmount" class="text-danger"></span>
                                    </div>
                                    <div class="mb-3">
                                        <label asp-for="OrderCreateDTO.DiscountPercentage" class="form-label">Kedvezmény (%)</label>
                                        <input asp-for="OrderCreateDTO.DiscountPercentage" type="number" step="0.01" class="form-control" />
                                        <span asp-validation-for="OrderCreateDTO.DiscountPercentage" class="text-danger"></span>
                                    </div>
                                    <div class="mb-3">
                                        <label asp-for="OrderCreateDTO.DiscountAmount" class="form-label">Kedvezmény összege</label>
                                        <input asp-for="OrderCreateDTO.DiscountAmount" type="number" step="0.01" class="form-control" />
                                        <span asp-validation-for="OrderCreateDTO.DiscountAmount" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label asp-for="OrderCreateDTO.CompanyName" class="form-label">Ügyfél</label>
                                        <input asp-for="OrderCreateDTO.CompanyName" class="form-control" />
                                        <span asp-validation-for="OrderCreateDTO.CompanyName" class="text-danger"></span>
                                    </div>
                                    <div class="mb-3">
                                        <label asp-for="OrderCreateDTO.SalesPerson" class="form-label">Értékesítő</label>
                                        <input asp-for="OrderCreateDTO.SalesPerson" class="form-control" />
                                        <span asp-validation-for="OrderCreateDTO.SalesPerson" class="text-danger"></span>
                                    </div>
                                    <div class="mb-3">
                                        <label asp-for="OrderCreateDTO.Status" class="form-label">Státusz</label>
                                        <select asp-for="OrderCreateDTO.Status" class="form-control">
                                            <option value="Pending">Függőben</option>
                                            <option value="Confirmed">Megerősítve</option>
                                            <option value="Shipped">Kiszállítva</option>
                                            <option value="Delivered">Kiszállítva</option>
                                            <option value="Cancelled">Törölve</option>
                                        </select>
                                        <span asp-validation-for="OrderCreateDTO.Status" class="text-danger"></span>
                                    </div>
                                    <div class="mb-3">
                                        <label asp-for="OrderCreateDTO.PartnerId" class="form-label">Partner</label>
                                        <select asp-for="OrderCreateDTO.PartnerId" class="form-control tomselect-dropdown" name="OrderCreateDTO.PartnerId" id="partnerIdSelect">
                                            <option value="">Válasszon...</option>
                                        </select>
                                        <span asp-validation-for="OrderCreateDTO.PartnerId" class="text-danger"></span>
                                    </div>
                                    <div class="mb-3">
                                        <label asp-for="OrderCreateDTO.ContactId" class="form-label">Kapcsolattartó</label>
                                        <select asp-for="OrderCreateDTO.ContactId" class="form-control tomselect-dropdown" name="OrderCreateDTO.ContactId" id="contactIdSelect">
                                            <option value="">Válasszon...</option>
                                        </select>
                                        <span asp-validation-for="OrderCreateDTO.ContactId" class="text-danger"></span>
                                    </div>
                                    <div class="mb-3">
                                        <label asp-for="OrderCreateDTO.SiteId" class="form-label">Telephely</label>
                                        <select asp-for="OrderCreateDTO.SiteId" class="form-control tomselect-dropdown" name="OrderCreateDTO.SiteId" id="siteIdSelect">
                                            <option value="">Válasszon...</option>
                                        </select>
                                        <span asp-validation-for="OrderCreateDTO.SiteId" class="text-danger"></span>
                                    </div>
                                    <div class="mb-3">
                                        <label asp-for="OrderCreateDTO.CurrencyId" class="form-label">Pénznem</label>
                                        <select asp-for="OrderCreateDTO.CurrencyId" class="form-control tomselect-dropdown" name="OrderCreateDTO.CurrencyId" id="currencyIdSelect">
                                            <option value="">Válasszon...</option>
                                        </select>
                                        <span asp-validation-for="OrderCreateDTO.CurrencyId" class="text-danger"></span>
                                    </div>
                                    <div class="mb-3">
                                        <label asp-for="OrderCreateDTO.ShippingMethodId" class="form-label">Szállítási mód</label>
                                        <select asp-for="OrderCreateDTO.ShippingMethodId" class="form-control tomselect-dropdown" name="OrderCreateDTO.ShippingMethodId" id="shippingMethodIdSelect">
                                            <option value="">Válasszon...</option>
                                        </select>
                                        <span asp-validation-for="OrderCreateDTO.ShippingMethodId" class="text-danger"></span>
                                    </div>
                                    <div class="mb-3">
                                        <label asp-for="OrderCreateDTO.PaymentTermId" class="form-label">Fizetési feltétel</label>
                                        <select asp-for="OrderCreateDTO.PaymentTermId" class="form-control tomselect-dropdown" name="OrderCreateDTO.PaymentTermId" id="paymentTermIdSelect">
                                            <option value="">Válasszon...</option>
                                        </select>
                                        <span asp-validation-for="OrderCreateDTO.PaymentTermId" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label asp-for="OrderCreateDTO.Subject" class="form-label">Tárgy</label>
                                <input asp-for="OrderCreateDTO.Subject" class="form-control" />
                                <span asp-validation-for="OrderCreateDTO.Subject" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="OrderCreateDTO.DetailedDescription" class="form-label">Részletes leírás</label>
                                <textarea asp-for="OrderCreateDTO.DetailedDescription" class="form-control"></textarea>
                                <span asp-validation-for="OrderCreateDTO.DetailedDescription" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="OrderCreateDTO.OrderType" class="form-label">Rendelés típusa</label>
                                <input asp-for="OrderCreateDTO.OrderType" class="form-control" />
                                <span asp-validation-for="OrderCreateDTO.OrderType" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="OrderCreateDTO.ReferenceNumber" class="form-label">Hivatkozási szám</label>
                                <input asp-for="OrderCreateDTO.ReferenceNumber" class="form-control" />
                                <span asp-validation-for="OrderCreateDTO.ReferenceNumber" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="OrderCreateDTO.QuoteId" class="form-label">Árajánlat azonosító</label>
                                <select asp-for="OrderCreateDTO.QuoteId" class="form-control tomselect-dropdown" name="OrderCreateDTO.QuoteId" id="quoteIdSelect">
                                    <option value="">Válasszon...</option>
                                </select>
                                <span asp-validation-for="OrderCreateDTO.QuoteId" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Tab 2: Order Items -->
                        <div class="tab-pane fade" id="items" role="tabpanel" aria-labelledby="items-tab">
                            <div id="orderItemsContainer">
                                <!-- Dynamically added order items will appear here -->
                            </div>
                            <button type="button" class="btn btn-outline-primary mt-3" id="addOrderItemButton">+ Tétel hozzáadása</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Mégse</button>
                    <button type="submit" class="btn btn-primary">Létrehozás</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modals for Each Order -->
@foreach (var order in Model.Orders)
{
    <!-- View Order Modal -->
    <div class="modal fade" id="viewOrderModal_@order.OrderId" tabindex="-1" aria-labelledby="viewOrderModalLabel_@order.OrderId" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewOrderModalLabel_@order.OrderId">Rendelés részletei</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Rendelésszám:</strong> @order.OrderNumber</p>
                    <p><strong>Dátum:</strong> @(order.OrderDate != null ? String.Format(CultureInfo.InvariantCulture, "{0:yyyy-MM-dd}", order.OrderDate) : "-")</p>
                    <p><strong>Határidő:</strong> @(order.Deadline.HasValue ? String.Format(CultureInfo.InvariantCulture, "{0:yyyy-MM-dd}", order.Deadline.Value) : "-")</p>
                    <p><strong>Leírás:</strong> @order.Description</p>
                    <p><strong>Összeg:</strong> @String.Format(CultureInfo.CreateSpecificCulture("hu-HU"), "{0:C}", order.TotalAmount)</p>
                    <p><strong>Ügyfél:</strong> @(order.Partner?.Name ?? order.CompanyName)</p>
                    <p><strong>Státusz:</strong> @order.Status</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bezárás</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Order Modal -->
    <div class="modal fade" id="editOrderModal_@order.OrderId" tabindex="-1" aria-labelledby="editOrderModalLabel_@order.OrderId" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form asp-page-handler="Update" asp-route-id="@order.OrderId" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editOrderModalLabel_@order.OrderId">Rendelés szerkesztése</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="__RequestVerificationToken" value="@ViewData["AntiForgeryToken"]" />
                        <input type="hidden" asp-for="OrderUpdateDTO.OrderId" id="updateOrderId_@order.OrderId" value="@order.OrderId" />
                        <div class="mb-3">
                            <label asp-for="OrderUpdateDTO.OrderNumber" class="form-label">Rendelésszám</label>
                            <input asp-for="OrderUpdateDTO.OrderNumber" class="form-control" id="updateOrderNumber_@order.OrderId" value="@order.OrderNumber" required />
                            <span asp-validation-for="OrderUpdateDTO.OrderNumber" class="text-danger"></span>
                        </div>
                        <div class="mb-3">
                            <label asp-for="OrderUpdateDTO.OrderDate" class="form-label">Rendelés dátuma</label>
                            <input asp-for="OrderUpdateDTO.OrderDate" type="date" class="form-control" id="updateOrderDate_@order.OrderId" value="@(order.OrderDate != null ? String.Format(CultureInfo.InvariantCulture, "{0:yyyy-MM-dd}", order.OrderDate) : "")" required />
                            <span asp-validation-for="OrderUpdateDTO.OrderDate" class="text-danger"></span>
                        </div>
                        <div class="mb-3">
                            <label asp-for="OrderUpdateDTO.Deadline" class="form-label">Határidő</label>
                            <input asp-for="OrderUpdateDTO.Deadline" type="date" class="form-control" id="updateDeadline_@order.OrderId" value="@(order.Deadline.HasValue ? String.Format(CultureInfo.InvariantCulture, "{0:yyyy-MM-dd}", order.Deadline.Value) : "")" />
                            <span asp-validation-for="OrderUpdateDTO.Deadline" class="text-danger"></span>
                        </div>
                        <div class="mb-3">
                            <label asp-for="OrderUpdateDTO.Description" class="form-label">Leírás</label>
                            <textarea asp-for="OrderUpdateDTO.Description" class="form-control" id="updateDescription_@order.OrderId">@order.Description</textarea>
                            <span asp-validation-for="OrderUpdateDTO.Description" class="text-danger"></span>
                        </div>
                        <div class="mb-3">
                            <label asp-for="OrderUpdateDTO.TotalAmount" class="form-label">Összeg</label>
                            <input asp-for="OrderUpdateDTO.TotalAmount" type="number" step="0.01" class="form-control" id="updateTotalAmount_@order.OrderId" value="@order.TotalAmount" required />
                            <span asp-validation-for="OrderUpdateDTO.TotalAmount" class="text-danger"></span>
                        </div>
                        <div class="mb-3">
                            <label asp-for="OrderUpdateDTO.CompanyName" class="form-label">Ügyfél</label>
                            <input asp-for="OrderUpdateDTO.CompanyName" class="form-control" id="updateCompanyName_@order.OrderId" value="@(order.Partner?.Name ?? order.CompanyName)" />
                            <span asp-validation-for="OrderUpdateDTO.CompanyName" class="text-danger"></span>
                        </div>
                        <div class="mb-3">
                            <label asp-for="OrderUpdateDTO.Status" class="form-label">Státusz</label>
                            <select asp-for="OrderUpdateDTO.Status" class="form-control" id="updateStatus_@order.OrderId">
                                <option value="Pending" selected="@(order.Status == "Pending")">Függőben</option>
                                <option value="Confirmed" selected="@(order.Status == "Confirmed")">Megerősítve</option>
                                <option value="Shipped" selected="@(order.Status == "Shipped")">Kiszállítva</option>
                                <option value="Delivered" selected="@(order.Status == "Delivered")">Kiszállítva</option>
                                <option value="Cancelled" selected="@(order.Status == "Cancelled")">Törölve</option>
                            </select>
                            <span asp-validation-for="OrderUpdateDTO.Status" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Mégse</button>
                        <button type="submit" class="btn btn-primary">Mentés</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Order Modal -->
    <div class="modal fade" id="deleteOrderModal_@order.OrderId" tabindex="-1" aria-labelledby="deleteOrderModalLabel_@order.OrderId" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form asp-page-handler="Delete" asp-route-id="@order.OrderId" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteOrderModalLabel_@order.OrderId">Rendelés törlése</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="__RequestVerificationToken" value="@ViewData["AntiForgeryToken"]" />
                        <p>Biztosan törölni szeretné a(z) @order.OrderNumber rendelést?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Mégse</button>
                        <button type="submit" class="btn btn-danger">Törlés</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}