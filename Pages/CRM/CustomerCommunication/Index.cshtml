@page
@using Microsoft.AspNetCore.Mvc.Rendering
@using Cloud9_2.Models
@using Microsoft.AspNetCore.Antiforgery
@model Cloud9_2.Pages.CRM.CustomerCommunication.IndexModel
@using System.Globalization
@functions {
    public string GetAntiForgeryToken()
    {
        var antiForgery = PageContext.HttpContext.RequestServices.GetService<IAntiforgery>();
        var tokenSet = antiForgery?.GetAndStoreTokens(PageContext.HttpContext);
        return tokenSet?.RequestToken ?? string.Empty;
    }
}
@{
    ViewData["Title"] = "√úgyf√©lkommunik√°ci√≥";
    Layout = "_Layout";
}
@await Html.PartialAsync("_CRMSidebar")
<div class="right-content">
    <div class="page-header-fixed-top">
        <!-- Breadcrumb Navigation -->
        <div class="d-flex justify-content-between align-items-center mb-2">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-body-tertiary rounded-3 p-2 mb-0">
                    <li class="breadcrumb-item"><a href="../../">F≈ëoldal</a></li>
                    <li class="breadcrumb-item"><a href="../">CRM Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">√úgyf√©lkommunik√°ci√≥</li>
                    <li class="breadcrumb-item active" aria-current="page">@Model.Communications.Count of @Model.DistinctCommunicationIdCount kommunik√°ci√≥ (Page @Model.CurrentPage of @Model.TotalPages)</li>
                </ol>
            </nav>
        </div>
        <!-- Header with Buttons and Search -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center gap-2">
                <button type="button" id="newCommunicationButton" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newCommunicationModal" aria-label="√öj kommunik√°ci√≥ hozz√°ad√°sa">
                    + √öj kommunik√°ci√≥
                </button>
            </div>
            <div class="d-flex align-items-center gap-2">
                <form method="get" class="input-group input-group-sm" style="width: 250px;">
                    <input type="text" class="form-control" placeholder="Keres√©s..." id="searchInput" name="SearchTerm" value="@Model.SearchTerm" autocomplete="off" aria-label="Keres√©s kommunik√°ci√≥k k√∂z√∂tt">
                    <input type="hidden" name="pageSize" value="@Model.PageSize" />
                    <button class="btn btn-outline-secondary" type="submit" aria-label="Keres√©s ind√≠t√°sa">
                        <i class="bi bi-search"></i>
                    </button>
                    @if (!string.IsNullOrEmpty(Model.SearchTerm))
                    {
                        <a href="@Url.Page("./Index")" class="btn btn-outline-danger btn-sm" aria-label="Keres√©s t√∂rl√©se">
                            <i class="bi bi-x"></i>
                        </a>
                    }
                </form>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Rendez√©si √©s sz≈±r√©si opci√≥k">
                        <i class="bi bi-funnel me-1"></i>Rendez√©s/Sz≈±r√©s
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="?SearchTerm=@Model.SearchTerm&PageSize=@Model.PageSize&TypeFilter=all&SortBy=CommunicationDate">√ñsszes kommunik√°ci√≥ (Leg√∫jabb el√∂l)</a></li>
                        <li><a class="dropdown-item" href="?SearchTerm=@Model.SearchTerm&PageSize=@Model.PageSize&TypeFilter=all&SortBy=CommunicationId">Rendez√©s: Kommunik√°ci√≥ ID (Cs√∂kken≈ë)</a></li>
                        <li><a class="dropdown-item" href="?SearchTerm=@Model.SearchTerm&PageSize=@Model.PageSize&TypeFilter=all&SortBy=PartnerName">Partner neve</a></li>
                        <li><a class="dropdown-item" href="?SearchTerm=@Model.SearchTerm&PageSize=@Model.PageSize&TypeFilter=E-mail">Csak email</a></li>
                        <li><a class="dropdown-item" href="?SearchTerm=@Model.SearchTerm&PageSize=@Model.PageSize&TypeFilter=Telefonh√≠v√°s">Csak telefonh√≠v√°s</a></li>
                        <li><a class="dropdown-item" href="?SearchTerm=@Model.SearchTerm&PageSize=@Model.PageSize&TypeFilter=Tal√°lkoz√≥">Csak tal√°lkoz√≥</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <!-- Table -->
        <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
            <table class="table table-striped table-hover">
<thead class="sticky-top custom-thead">
    <tr>
        @foreach (var column in new[] { "Type", "Partner", "Responsible", "Date", "Subject", "Status" })
        {
            <th class="text-nowrap">
                @(column == "Type" ? "T√≠pus" :
                  column == "Partner" ? "Partner" :
                  column == "Responsible" ? "Felel≈ës" :
                  column == "Date" ? "D√°tum" :
                  column == "Subject" ? "T√°rgy" :
                  column == "Status" ? "St√°tusz" : column)
            </th>
        }
        <th class="text-nowrap">M≈±veletek</th>
    </tr>
</thead>
<tbody>
    @if (Model.Communications.Any())
    {
        @foreach (var communication in Model.Communications)
        {
            <tr data-communication-id="@communication.CustomerCommunicationId">
                <td class="text-nowrap">
                    @if (communication.CommunicationTypeName == "E-mail")
                    {
                        <i class="bi bi-envelope me-1">E-mail</i>
                    }
                    else if (communication.CommunicationTypeName == "Telefonh√≠v√°s")
                    {
                        <i class="bi bi-telephone me-1">Telefon</i>
                    }
                    else if (communication.CommunicationTypeName == "Tal√°lkoz√≥")
                    {
                        <i class="bi bi-calendar-event me-1">Tal√°lkoz√≥</i>
                    }
                    else
                    {
                        <i class="bi bi-chat me-1">Egy√©b</i>
                    }
                </td>
                <td class="text-nowrap">
                    <i class="bi bi-person me-1"></i>@(communication.PartnerName ?? "Nincs partner")
                </td>
                <td class="text-nowrap">
                    <i class="bi bi-person-check me-1"></i>@(communication.CurrentResponsible?.ResponsibleName ?? "Nincs felel≈ës")
                </td>
                <td class="text-nowrap">
                    <i class="bi bi-calendar me-1"></i>@(communication.Date.ToString("yyyy-MM-dd"))
                </td>
                <td class="text-nowrap">@communication.Subject</td>
                <td class="text-nowrap">
                    @{
                        var badgeClass = communication.StatusName switch
                        {
                            "Nyitott" => "badge bg-primary", // üëà add 'flash' class here
                            "Folyamatban" => "badge bg-warning",
                            "Eskal√°lva" => "badge bg-danger flash",
                            "Megoldva" => "badge bg-success",
                            _ => "badge bg-secondary"
                        };

                        string displayName = Model.StatusDisplayNames.TryGetValue(communication.StatusName, out var name)
                            ? name
                            : communication.StatusName ?? "Ismeretlen";
                    }
                    <span class="@badgeClass">@displayName</span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button"
                                class="btn btn-outline-info view-communication-btn"
                                data-bs-toggle="modal"
                                data-bs-target="#viewCommunicationModal_@communication.CustomerCommunicationId"
                                aria-label="Kommunik√°ci√≥ r√©szleteinek megtekint√©se">
                            <i class="bi bi-eye"></i>
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle btn-sm" type="button"
                                    id="actionsDropdown_@communication.CustomerCommunicationId"
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false"
                                    data-bs-toggle="tooltip"
                                    data-bs-placement="top"
                                    data-bs-title="Tov√°bbi m≈±veletek">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="actionsDropdown_@communication.CustomerCommunicationId">
                                <li>
                                    <a class="dropdown-item" href="#"
                                       data-bs-toggle="modal"
                                       data-bs-target="#editCommunicationModal_@communication.CustomerCommunicationId">
                                        <i class="bi bi-pencil-square me-2"></i>Szerkeszt√©s
                                    </a>
                                </li>
                                <li><a class="dropdown-item" href="#" onclick="copyCommunication(@communication.CustomerCommunicationId)"><i class="bi bi-copy me-2"></i>M√°sol√°s</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item text-danger" href="#"
                                       data-bs-toggle="modal"
                                       data-bs-target="#deleteCommunicationModal_@communication.CustomerCommunicationId"
                                       data-communication-id="@communication.CustomerCommunicationId">
                                        <i class="bi bi-trash me-2"></i>T√∂rl√©s
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </td>
            </tr>
        }
    }
    else
    {
        <tr>
            <td colspan="7" class="text-center"> <!-- Updated colspan to 7 -->
                <div class="alert alert-warning" role="alert">
                    @if (!string.IsNullOrEmpty(Model.SearchTerm))
                    {
                        @:Nincs tal√°lat a "@Model.SearchTerm" keres√©sre az @Model.CurrentPage. oldalon.
                    }
                    else if (Model.TotalRecords > 0)
                    {
                        @:Nincs kommunik√°ci√≥ az @Model.CurrentPage. oldalon, de @Model.TotalRecords kommunik√°ci√≥ l√©tezik. Pr√≥b√°ljon m√°sik oldalt vagy sz≈±r≈ët.
                    }
                    else
                    {
                        @:Nincs kommunik√°ci√≥. <button type="button" class="btn btn-link alert-link p-0 align-baseline" data-bs-toggle="modal" data-bs-target="#newCommunicationModal" aria-label="Els≈ë kommunik√°ci√≥ l√©trehoz√°sa">Hozza l√©tre az els≈ët?</button>
                    }
                    <div class="mt-2 small text-muted">
                        Debug: Page=@Model.CurrentPage, PageSize=@Model.PageSize, TotalRecords=@Model.TotalRecords, DistinctCommunicationIdCount=@Model.DistinctCommunicationIdCount, SearchTerm="@Model.SearchTerm"
                    </div>
                </div>
            </td>
        </tr>
    }
</tbody>
            </table>
        </div>
        <!-- Pagination Footer -->
        @await Html.PartialAsync(partialViewName: "_PaginationFooter", new Cloud9_2.Models.PaginationViewModel
        {
            CurrentPage = Model.CurrentPage,
            TotalPages = Model.TotalPages,
            PageSize = Model.PageSize,
            SearchTerm = Model.SearchTerm,
            PageRoute = "./Index",
            EntityName = "Communications"
        })
    </div>

    <!-- Include Modals -->
    @await Html.PartialAsync("_Modals")

    <div id="toastContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055;"></div>
</div>

@section Scripts {
    <script src="~/js/CustomerCommunication.js"></script>
}