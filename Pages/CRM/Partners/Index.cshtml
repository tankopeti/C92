@page
@using System.Security.Claims
@using Microsoft.AspNetCore.Identity
@using Cloud9_2.Models
@model Cloud9_2.Pages.CRM.Partners.IndexModel

@{
    Layout = "_Layout";
    ViewData["Title"] = "Partnerek";
}

@await Html.PartialAsync("_CRMSidebar")

<div class="right-content">
    <div class="page-header-fixed-top">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-body-tertiary rounded-3 p-2 mb-0">
                    <li class="breadcrumb-item"><a href="../../">Főoldal</a></li>
                    <li class="breadcrumb-item"><a href="../">CRM Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Partnerek</li>
                    <li class="breadcrumb-item active" aria-current="page">@Model.Partners.Count of @Model.TotalRecords partner@(Model.TotalRecords != 1 ? "ek" : "") (Oldal @Model.CurrentPage / @Model.TotalPages)</li>
                </ol>
            </nav>
        </div>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#createPartnerModal">
                    + Új Partner
                </button>
            </div>
            <div class="d-flex align-items-center gap-2">
                <form method="get" asp-page="./Index" class="input-group input-group-sm" style="width: 250px;">
                    <input type="text" class="form-control" placeholder="Partnerek keresése..." id="searchInput" name="SearchTerm" value="@Model.SearchTerm">
                    <input type="hidden" name="pageSize" value="@Model.PageSize" />
                    <button class="btn btn-outline-secondary" type="submit">
                        <i class="bi bi-search"></i>
                    </button>
                </form>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-funnel me-1"></i>Szűrő
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" data-filter="all">Minden Partner</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="active">Aktív Partnerek</a></li>
                    </ul>
                </div>
            </div>
        </div>

<div class="table-responsive table-dynamic-height" data-page-size="@Model.PageSize">
    <table class="table table-striped table-hover">
        <thead class="sticky-top custom-thead">
            <tr>
                <th>Név</th>
                <th>Email</th>
                <th>Telefonszám</th>
                <th>Adószám</th>
                <th>Címsor 1</th>
                <th>Címsor 2</th>
                <th>Város</th>
                <th>Megye</th>
                <th>Irányítószám</th>
                <th>Státusz</th>
                <th>Pénznem</th>
                <th>Felelős</th>
                <th class="text-center">Műveletek</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Partners.Any())
            {
                foreach (var item in Model.Partners)
                {
                    <tr>
                        <td>@item.Name</td>
                        <td>@(string.IsNullOrEmpty(item.Email) ? "—" : item.Email)</td>
                        <td>@(string.IsNullOrEmpty(item.PhoneNumber) ? "—" : item.PhoneNumber)</td>
                        <td>@(string.IsNullOrEmpty(item.TaxId) ? "—" : item.TaxId)</td>
                        <td>@item.AddressLine1</td>
                        <td>@item.AddressLine2</td>
                        <td>@item.City</td>
                        <td>@item.State</td>
                        <td>@item.PostalCode</td>
                        <td>
                            <span class="badge" style="background-color: @(item.Status?.Color ?? "#6c757d"); color: @(string.IsNullOrEmpty(item.Status?.Color) || item.Status.Color == "#ffc107" ? "black" : "white")">
                                @(item.Status?.Name ?? "N/A")
                            </span>
                        </td>
                        <td>@item.PreferredCurrency</td>
                        <td>@item.AssignedTo</td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-info view-partner-btn" data-partner-id="@item.PartnerId">
                                    <i class="bi bi-eye"></i>
                                </button>

                                    <div class="dropdown">
                                        <button class="btn btn-outline-secondary dropdown-toggle btn-sm" type="button" data-bs-toggle="dropdown">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item edit-partner-btn" href="#" data-partner-id="@item.PartnerId">Szerkesztés</a></li>
                                            <li><a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deletePartnerModal" data-partner-id="@item.PartnerId" data-partner-name="@item.Name">Törlés</a></li>
                                        </ul>
                                    </div>
                                
                            </div>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="13" class="text-center py-4">
                        <div class="alert alert-warning mb-0">
                            @if (!string.IsNullOrEmpty(Model.SearchTerm))
                            {
                                <text>Nincs találat a "@Model.SearchTerm" keresésre.</text>
                            }
                            else
                            {
                                <text>Nincsenek partnerek.</text>

                                    <text> </text><button type="button" class="btn btn-link p-0 align-baseline" data-bs-toggle="modal" data-bs-target="#createPartnerModal">Hozza létre az elsőt?</button>
                                
                            }
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

        <!-- Pagination Footer -->
        @await Html.PartialAsync("_PaginationFooter", new PaginationViewModel
        {
            CurrentPage = Model.CurrentPage,
            TotalPages = Model.TotalPages,
            PageSize = Model.PageSize,
            SearchTerm = Model.SearchTerm,
            PageRoute = "./Index",
            EntityName = "Partnerek"
        })
    </div>

    <!-- Include Modals -->
    @await Html.PartialAsync("_Modals")

    @section Scripts {
        <script src="/js/Partner/createPartner.js" onerror="alert('Nem sikerült betölteni a createPartner.js fájlt.')"></script>
        <script src="/js/Partner/viewPartner.js" onerror="alert('Nem sikerült betölteni a viewPartner.js fájlt.')"></script>
        <script src="/js/Partner/loadStatuses.js" onerror="alert('Nem sikerült betölteni a loadStatuses.js fájlt.')"></script>
        <script src="/js/Partner/editPartner.js" onerror="alert('Nem sikerült betölteni a editPartner.js fájlt.')"></script>
        <script src="/js/utils.js"></script>
        <script src="/js/tomSelectUtils.js"></script>
        <script src="/js/orderTomSelects.js" onerror="alert('Nem sikerült betölteni az orderTomSelects.js fájlt.')"></script>
    }