@page
@model Cloud9_2.Pages.CRM.Sites.IndexModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Telephelyek";
}

@await Html.PartialAsync("_CRMSidebar")

<div class="right-content">
    <!-- Üzenet Modal (pl. sikeres művelethez) -->
    <div class="modal fade" id="messageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg border-0">
                <div class="modal-header py-2 bg-info text-white">
                    <h5 class="modal-title fs-5 fw-semibold" id="messageModalLabel">
                        <i class="bi bi-info-circle me-2"></i> Értesítés
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Bezárás"></button>
                </div>
                <div class="modal-body py-4" id="messageModalBody">
                    <!-- JS tölt be tartalmat -->
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i> Bezárás
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="page-header-fixed-top">
        <!-- Breadcrumb -->
        <div class="d-flex justify-content-between align-items-center mb-2">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-body-tertiary rounded-3 p-2 mb-0">
                    <li class="breadcrumb-item"><a href="../../">Főoldal</a></li>
                    <li class="breadcrumb-item"><a href="../">CRM Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Telephelyek</li>
                    <li class="breadcrumb-item active" aria-current="page">@Model.Sites.Count of @Model.TotalRecords telephely@(Model.TotalRecords != 1 ? "ek" : "") (Page @Model.CurrentPage of @Model.TotalPages)</li>
                </ol>
            </nav>
        </div>

        <!-- Fejléc gombokkal és kereséssel -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-primary px-4" data-bs-toggle="modal" data-bs-target="#createSiteModal">
                    <i class="bi bi-plus-circle me-1"></i> Új Telephely
                </button>
            </div>

            <div class="d-flex align-items-center gap-2">
                <form method="get" asp-page="./Index" class="input-group input-group-sm" style="width: 250px;">
                    <input type="text" class="form-control" placeholder="Telephely keresése..." name="searchTerm" value="@Model.SearchTerm">
                    <input type="hidden" name="pageSize" value="@Model.PageSize" />
                    <button class="btn btn-outline-secondary" type="submit">
                        <i class="bi bi-search"></i>
                    </button>
                    @if (!string.IsNullOrEmpty(Model.SearchTerm))
                    {
                        <a href="@Url.Page("./Index")" class="btn btn-outline-danger btn-sm">
                            <i class="bi bi-x"></i>
                        </a>
                    }
                </form>

                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-funnel me-1"></i> Szűrő
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" data-filter="all">Összes Telephely</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="primary">Elsődleges Telephelyek</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Tábla -->
    <div class="table-responsive table-dynamic-height" data-page-size="@Model.PageSize">
        <table class="table table-striped table-hover">
            <thead class="sticky-top custom-thead">
                <tr>
                    <th class="text-nowrap">Telephely neve</th>
                    <th class="text-nowrap">Partner</th>
                    <th class="text-nowrap">Cím 1</th>
                    <th class="text-nowrap">Cím 2</th>
                    <th class="text-nowrap">Város</th>
                    <th class="text-nowrap">Irányítószám</th>
                    <th class="text-nowrap">Kapcsolattartó 1</th>
                    <th class="text-nowrap">Kapcsolattartó 2</th>
                    <th class="text-nowrap">Kapcsolattartó 3</th>
                    <th class="text-nowrap">Státusz</th>
                    <th class="text-nowrap">Elsődleges</th>
                    <th class="text-nowrap">Műveletek</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Sites.Any())
                {
                    @foreach (var site in Model.Sites)
                    {
                        <tr>
                            <td class="text-nowrap">
                                <i class="bi bi-building me-1"></i>
                                @if (string.IsNullOrEmpty(site.SiteName))
                                {
                                    <span class="text-danger">(Nincs Név - SiteId: @site.SiteId)</span>
                                }
                                else
                                {
                                    @site.SiteName
                                }
                            </td>
                            <td class="text-nowrap">
                                @if (site.Partner != null && !string.IsNullOrEmpty(site.Partner.Name))
                                {
                                    <a asp-page="/CRM/Partners/Index" asp-route-id="@site.PartnerId" class="text-decoration-none">
                                        <i class="bi bi-person me-1"></i> @site.Partner.Name
                                    </a>
                                }
                                else
                                {
                                    <span class="text-warning">Nincs Partner (PartnerId: @site.PartnerId)</span>
                                }
                            </td>
                            <td class="text-nowrap"><i class="bi bi-geo-alt me-1"></i> @(string.IsNullOrEmpty(site.AddressLine1) ? "-" : site.AddressLine1)</td>
                            <td class="text-nowrap"><i class="bi bi-geo-alt me-1"></i> @(string.IsNullOrEmpty(site.AddressLine2) ? "-" : site.AddressLine2)</td>
                            <td class="text-nowrap"><i class="bi bi-geo-alt me-1"></i> @(string.IsNullOrEmpty(site.City) ? "-" : site.City)</td>
                            <td class="text-nowrap"><i class="bi bi-geo-alt me-1"></i> @(string.IsNullOrEmpty(site.PostalCode) ? "-" : site.PostalCode)</td>
                            <td class="text-nowrap">@(string.IsNullOrEmpty(site.ContactPerson1) ? "-" : site.ContactPerson1)</td>
                            <td class="text-nowrap">@(string.IsNullOrEmpty(site.ContactPerson2) ? "-" : site.ContactPerson2)</td>
                            <td class="text-nowrap">@(string.IsNullOrEmpty(site.ContactPerson3) ? "-" : site.ContactPerson3)</td>
                            <td class="text-nowrap">
                                @if (site.Status != null && !string.IsNullOrEmpty(site.Status.Color))
                                {
                                    <span class="badge" style="background-color: @site.Status.Color; color: white;">@site.Status.Name</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">-</span>
                                }
                            </td>
                            <td class="text-nowrap">
                                @if (site.IsPrimary)
                                {
                                    <span class="badge bg-primary">Elsődleges</span>
                                }
                                else
                                {
                                    <span>-</span>
                                }
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button"
                                            class="btn btn-outline-info"
                                            data-bs-toggle="modal"
                                            data-bs-target="#viewSiteModal_@site.SiteId">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <div class="dropdown">
                                        <button class="btn btn-outline-secondary dropdown-toggle btn-sm" type="button"
                                                data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li>
                                                <a class="dropdown-item" href="#"
                                                   data-bs-toggle="modal"
                                                   data-bs-target="#editSiteModal_@site.SiteId">
                                                    <i class="bi bi-pencil-square me-2"></i> Szerkesztés
                                                </a>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <a class="dropdown-item text-danger" href="#"
                                                   data-bs-toggle="modal"
                                                   data-bs-target="#deleteSiteModal_@site.SiteId">
                                                    <i class="bi bi-trash me-2"></i> Törlés
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="12" class="text-center py-5">
                            <div class="alert alert-warning" role="alert">
                                @if (!string.IsNullOrEmpty(Model.SearchTerm))
                                {
                                    @:Nem található telephely a "@Model.SearchTerm" keresésre.
                                }
                                else
                                {
                                    @:Nem található telephely. 
                                    <button type="button" class="btn btn-link alert-link p-0 align-baseline" data-bs-toggle="modal" data-bs-target="#createSiteModal">
                                        Hozz létre egyet?
                                    </button>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Lapozás -->
    <footer class="fixed-footer">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <nav aria-label="Telephelyek lapozás">
                <ul class="pagination justify-content-center my-0">
                    <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                        <a class="page-link" asp-page="./Index" asp-route-currentPage="@(Model.CurrentPage - 1)" asp-route-pageSize="@Model.PageSize" asp-route-searchTerm="@Model.SearchTerm">Előző</a>
                    </li>
                    @{
                        int startPage = Math.Max(1, Model.CurrentPage - 2);
                        int endPage = Math.Min(Model.TotalPages, startPage + 4);
                        if (endPage - startPage + 1 < 5 && startPage > 1) { startPage = Math.Max(1, endPage - 4); }
                        if (Model.TotalPages > 5 && startPage > 1)
                        {
                            <li class="page-item"><a class="page-link" asp-page="./Index" asp-route-currentPage="1" asp-route-pageSize="@Model.PageSize" asp-route-searchTerm="@Model.SearchTerm">1</a></li>
                            if (startPage > 2) { <li class="page-item disabled"><span class="page-link">...</span></li> }
                        }
                    }
                    @for (int i = startPage; i <= endPage; i++)
                    {
                        <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                            <a class="page-link" asp-page="./Index" asp-route-currentPage="@i" asp-route-pageSize="@Model.PageSize" asp-route-searchTerm="@Model.SearchTerm">@i</a>
                        </li>
                    }
                    @{
                        if (Model.TotalPages > 5 && endPage < Model.TotalPages)
                        {
                            if (endPage < Model.TotalPages - 1) { <li class="page-item disabled"><span class="page-link">...</span></li> }
                            <li class="page-item"><a class="page-link" asp-page="./Index" asp-route-currentPage="@Model.TotalPages" asp-route-pageSize="@Model.PageSize" asp-route-searchTerm="@Model.SearchTerm">@Model.TotalPages</a></li>
                        }
                    }
                    <li class="page-item @(Model.CurrentPage == Model.TotalPages || Model.TotalPages == 0 ? "disabled" : "")">
                        <a class="page-link" asp-page="./Index" asp-route-currentPage="@(Model.CurrentPage + 1)" asp-route-pageSize="@Model.PageSize" asp-route-searchTerm="@Model.SearchTerm">Következő</a>
                    </li>
                </ul>
            </nav>

            <div class="text-center">
                <form method="get" asp-page="./Index" class="d-inline-flex align-items-center gap-1">
                    <label for="pageSize" class="form-label mb-0 small">Oldalanként:</label>
                    <select id="pageSize" name="pageSize" onchange="this.form.submit()" class="form-select form-select-sm">
                        <option value="10" selected="@(Model.PageSize == 10)">10</option>
                        <option value="25" selected="@(Model.PageSize == 25)">25</option>
                        <option value="50" selected="@(Model.PageSize == 50)">50</option>
                        <option value="100" selected="@(Model.PageSize == 100)">100</option>
                    </select>
                    <input type="hidden" name="currentPage" value="1" />
                    <input type="hidden" name="searchTerm" value="@Model.SearchTerm" />
                </form>
            </div>
        </div>
    </footer>

    <!-- ============================================================= -->
    <!-- 1. ÚJ TELEPHELY LÉTREHOZÁSA MODAL -->
    <!-- ============================================================= -->
    <div class="modal fade" id="createSiteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content shadow-lg border-0">
                <form method="post" asp-page-handler="CreateSite" class="needs-validation" novalidate>
                    @Html.AntiForgeryToken()

                    <div class="modal-header py-2 bg-primary text-white">
                        <h5 class="modal-title fs-5 fw-semibold">
                            <i class="bi bi-plus-circle me-2"></i> Új Telephely
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Bezárás"></button>
                    </div>

                    <div class="modal-body py-4">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">Telephely neve <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="siteName" required placeholder="Pl. Központi iroda" />
                                <div class="invalid-feedback">A telephely neve kötelező.</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">Partner <span class="text-danger">*</span></label>
                                <select id="create-partner-select" class="form-select tom-select" name="partnerId" required>
                                    <option value="" disabled selected>-- Válasszon partnert --</option>
                                </select>
                                <div class="invalid-feedback">Partner megadása kötelező.</div>
                            </div>
                        </div>

                        <hr class="my-5">

                        <h6 class="mb-3 text-primary fw-semibold">
                            <i class="bi bi-house-door me-2"></i> Cím adatok
                        </h6>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">Cím 1</label>
                                <input type="text" class="form-control" name="addressLine1" placeholder="Utca, házszám" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">Cím 2</label>
                                <input type="text" class="form-control" name="addressLine2" placeholder="Épület, emelet, ajtó" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">Város</label>
                                <input type="text" class="form-control" name="city" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">Állam/Megye</label>
                                <input type="text" class="form-control" name="state" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">Irányítószám</label>
                                <input type="text" class="form-control" name="postalCode" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">Ország</label>
                                <input type="text" class="form-control" name="country" value="Magyarország" />
                            </div>
                        </div>

                        <hr class="my-5">

                        <h6 class="mb-3 text-primary fw-semibold">
                            <i class="bi bi-person-lines-fill me-2"></i> Kapcsolattartók
                        </h6>

                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-medium">Kapcsolattartó 1</label>
                                <input type="text" class="form-control" name="contactPerson1" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-medium">Kapcsolattartó 2</label>
                                <input type="text" class="form-control" name="contactPerson2" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-medium">Kapcsolattartó 3</label>
                                <input type="text" class="form-control" name="contactPerson3" />
                            </div>
                        </div>

                        <hr class="my-5">

                        <h6 class="mb-3 text-primary fw-semibold">
                            <i class="bi bi-chat-square-text me-2"></i> Megjegyzések
                        </h6>

                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label fw-medium">Megjegyzés 1</label>
                                <textarea class="form-control" name="comment1" rows="3"></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-medium">Megjegyzés 2</label>
                                <textarea class="form-control" name="comment2" rows="3"></textarea>
                            </div>
                        </div>

                        <div class="row g-3 mt-4">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">Státusz <span class="text-danger">*</span></label>
                                <select id="create-status-select" class="form-select tom-select" name="statusId" required>
                                    <option value="" disabled>-- Válasszon státuszt --</option>
                                    @foreach (var status in Model.Statuses)
                                    {
                                        <option value="@status.Id" selected="@(status.Id == 1)">@status.Name</option>
                                    }
                                </select>
                                <div class="invalid-feedback">Státusz megadása kötelező.</div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mt-4">
                                    <input type="checkbox" class="form-check-input" name="isPrimary" value="true" id="create-isPrimary">
                                    <label class="form-check-label fw-medium" for="create-isPrimary">
                                        Elsődleges telephely
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer py-2">
                        <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i> Mégse
                        </button>
                        <button type="submit" class="btn btn-primary px-4">
                            <i class="bi bi-check2-circle me-1"></i> Létrehozás
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ============================================================= -->
    <!-- 2. RÉSZLETEK MODALOK -->
    <!-- ============================================================= -->
    @foreach (var site in Model.Sites)
    {
        <div class="modal fade" id="viewSiteModal_@site.SiteId" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content shadow-lg border-0">
                    <div class="modal-header py-2 bg-info text-white">
                        <h5 class="modal-title fs-5 fw-semibold">
                            <i class="bi bi-eye me-2"></i> @(string.IsNullOrEmpty(site.SiteName) ? "Telephely részletei" : site.SiteName)
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Bezárás"></button>
                    </div>

                    <div class="modal-body py-4">
                        <table class="table table-sm table-borderless">
                            <tbody>
                                <tr><th>Telephely neve</th><td>@(string.IsNullOrEmpty(site.SiteName) ? "-" : site.SiteName)</td></tr>
                                <tr><th>Partner</th><td>@(site.Partner != null ? site.Partner.Name : "-")</td></tr>
                                <tr><th>Cím 1</th><td>@(string.IsNullOrEmpty(site.AddressLine1) ? "-" : site.AddressLine1)</td></tr>
                                <tr><th>Cím 2</th><td>@(string.IsNullOrEmpty(site.AddressLine2) ? "-" : site.AddressLine2)</td></tr>
                                <tr><th>Város</th><td>@(string.IsNullOrEmpty(site.City) ? "-" : site.City)</td></tr>
                                <tr><th>Állam/Megye</th><td>@(string.IsNullOrEmpty(site.State) ? "-" : site.State)</td></tr>
                                <tr><th>Irányítószám</th><td>@(string.IsNullOrEmpty(site.PostalCode) ? "-" : site.PostalCode)</td></tr>
                                <tr><th>Ország</th><td>@(string.IsNullOrEmpty(site.Country) ? "-" : site.Country)</td></tr>
                                <tr><th>Kapcsolattartó 1</th><td>@(string.IsNullOrEmpty(site.ContactPerson1) ? "-" : site.ContactPerson1)</td></tr>
                                <tr><th>Kapcsolattartó 2</th><td>@(string.IsNullOrEmpty(site.ContactPerson2) ? "-" : site.ContactPerson2)</td></tr>
                                <tr><th>Kapcsolattartó 3</th><td>@(string.IsNullOrEmpty(site.ContactPerson3) ? "-" : site.ContactPerson3)</td></tr>
                                <tr><th>Megjegyzés 1</th><td>@(string.IsNullOrEmpty(site.Comment1) ? "-" : site.Comment1)</td></tr>
                                <tr><th>Megjegyzés 2</th><td>@(string.IsNullOrEmpty(site.Comment2) ? "-" : site.Comment2)</td></tr>
                                <tr>
                                    <th>Státusz</th>
                                    <td>
                                        @if (site.Status != null && !string.IsNullOrEmpty(site.Status.Color))
                                        {
                                            <span class="badge" style="background-color: @site.Status.Color; color: white;">@site.Status.Name</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">-</span>
                                        }
                                    </td>
                                </tr>
                                <tr><th>Elsődleges</th><td>@(site.IsPrimary ? "Igen" : "Nem")</td></tr>
                                <tr><th>Létrehozva</th><td>@(site.CreatedDate?.ToString("yyyy-MM-dd") ?? "-")</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="modal-footer py-2">
                        <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i> Bezárás
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- ============================================================= -->
    <!-- 3. SZERKESZTÉS MODALOK -->
    <!-- ============================================================= -->
    @foreach (var site in Model.Sites)
    {
        <div class="modal fade" id="editSiteModal_@site.SiteId" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content shadow-lg border-0">
                    <form method="post" asp-page-handler="EditSite" class="needs-validation" novalidate>
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="siteId" value="@site.SiteId" />

                        <div class="modal-header py-2 bg-warning text-dark">
                            <h5 class="modal-title fs-5 fw-semibold">
                                <i class="bi bi-pencil-square me-2"></i> Telephely szerkesztése
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Bezárás"></button>
                        </div>

                        <div class="modal-body py-4">
                            <!-- Alapadatok -->
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-medium">Telephely neve <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="siteName" value="@site.SiteName" required />
                                    <div class="invalid-feedback">A telephely neve kötelező.</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-medium">Partner <span class="text-danger">*</span></label>
                                    <select id="edit-partner-select-@site.SiteId" class="form-select tom-select" name="partnerId" required data-partner-id="@site.PartnerId">
                                        <option value="" disabled>-- Válasszon partnert --</option>
                                        @if (site.Partner != null)
                                        {
                                            <option value="@site.PartnerId" selected>@site.Partner.Name</option>
                                        }
                                    </select>
                                    <div class="invalid-feedback">Partner megadása kötelező.</div>
                                </div>
                            </div>

                            <hr class="my-5">

                            <h6 class="mb-3 text-primary fw-semibold">
                                <i class="bi bi-house-door me-2"></i> Cím adatok
                            </h6>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-medium">Cím 1</label>
                                    <input type="text" class="form-control" name="addressLine1" value="@site.AddressLine1" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-medium">Cím 2</label>
                                    <input type="text" class="form-control" name="addressLine2" value="@site.AddressLine2" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-medium">Város</label>
                                    <input type="text" class="form-control" name="city" value="@site.City" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-medium">Állam/Megye</label>
                                    <input type="text" class="form-control" name="state" value="@site.State" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-medium">Irányítószám</label>
                                    <input type="text" class="form-control" name="postalCode" value="@site.PostalCode" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-medium">Ország</label>
                                    <input type="text" class="form-control" name="country" value="@site.Country" />
                                </div>
                            </div>

                            <hr class="my-5">

                            <h6 class="mb-3 text-primary fw-semibold">
                                <i class="bi bi-person-lines-fill me-2"></i> Kapcsolattartók
                            </h6>

                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-medium">Kapcsolattartó 1</label>
                                    <input type="text" class="form-control" name="contactPerson1" value="@site.ContactPerson1" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-medium">Kapcsolattartó 2</label>
                                    <input type="text" class="form-control" name="contactPerson2" value="@site.ContactPerson2" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-medium">Kapcsolattartó 3</label>
                                    <input type="text" class="form-control" name="contactPerson3" value="@site.ContactPerson3" />
                                </div>
                            </div>

                            <hr class="my-5">

                            <h6 class="mb-3 text-primary fw-semibold">
                                <i class="bi bi-chat-square-text me-2"></i> Megjegyzések
                            </h6>

                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-medium">Megjegyzés 1</label>
                                    <textarea class="form-control" name="comment1" rows="3">@site.Comment1</textarea>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-medium">Megjegyzés 2</label>
                                    <textarea class="form-control" name="comment2" rows="3">@site.Comment2</textarea>
                                </div>
                            </div>

                            <div class="row g-3 mt-4">
                                <div class="col-md-6">
                                    <label class="form-label fw-medium">Státusz <span class="text-danger">*</span></label>
                                    <select id="edit-status-select-@site.SiteId" class="form-select tom-select" name="statusId" required data-status-id="@site.StatusId">
                                        <option value="" disabled>-- Válasszon státuszt --</option>
                                        @foreach (var status in Model.Statuses)
                                        {
                                            <option value="@status.Id" selected="@(site.StatusId == status.Id)">@status.Name</option>
                                        }
                                    </select>
                                    <div class="invalid-feedback">Státusz megadása kötelező.</div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mt-4">
                                        <input type="checkbox" class="form-check-input" name="isPrimary" value="true" id="edit-isPrimary-@site.SiteId" checked="@site.IsPrimary">
                                        <label class="form-check-label fw-medium" for="edit-isPrimary-@site.SiteId">
                                            Elsődleges telephely
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer py-2">
                            <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">
                                <i class="bi bi-x-circle me-1"></i> Mégse
                            </button>
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="bi bi-check2-circle me-1"></i> Mentés
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    }

    <!-- ============================================================= -->
    <!-- 4. TÖRLÉS MODALOK -->
    <!-- ============================================================= -->
    @foreach (var site in Model.Sites)
    {
        <div class="modal fade" id="deleteSiteModal_@site.SiteId" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content shadow-lg border-0">
                    <div class="modal-header py-2 bg-danger text-white">
                        <h5 class="modal-title fs-5 fw-semibold">
                            <i class="bi bi-trash me-2"></i> Telephely törlése
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Bezárás"></button>
                    </div>

                    <div class="modal-body py-4">
                        <p>Biztosan törölni szeretné a következő telephelyet?</p>
                        <p class="fw-bold mb-0">@(string.IsNullOrEmpty(site.SiteName) ? "Ismeretlen telephely" : site.SiteName)</p>
                        <p class="text-danger mt-3 small">Ez a művelet <strong>végleges</strong> és nem vonható vissza.</p>

                        <form method="post" asp-page-handler="DeleteSite">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="siteId" value="@site.SiteId" />
                        </form>
                    </div>

                    <div class="modal-footer py-2">
                        <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i> Mégse
                        </button>
                        <button type="submit" form="deleteSiteModal_@site.SiteId" class="btn btn-danger px-4">
                            <i class="bi bi-trash me-1"></i> Törlés
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
<script>
$(function () {
    $('[data-bs-toggle="tooltip"]').tooltip();

    // Show message modal for success or error messages
    const successMessage = '@Html.Raw(TempData["SuccessMessage"])';
    const errorMessage = '@Html.Raw(TempData["ErrorMessage"])';
    if (successMessage || errorMessage) {
        const modalEl = document.getElementById('messageModal');
        const modalTitleEl = document.getElementById('messageModalLabel');
        const modalBodyEl = document.getElementById('messageModalBody');
        const modal = new bootstrap.Modal(modalEl, { backdrop: 'static', keyboard: true });

        if (successMessage) {
            modalTitleEl.textContent = 'Siker';
            modalBodyEl.textContent = successMessage;
            modalEl.querySelector('.modal-content').classList.add('text-bg-success');
        } else if (errorMessage) {
            modalTitleEl.textContent = 'Hiba';
            modalBodyEl.textContent = errorMessage;
            modalEl.querySelector('.modal-content').classList.add('text-bg-danger');
        }
        modal.show();
    }

    // Create dictionaries for SiteId to PartnerId and PartnerName mappings
    const sitePartnerMap = @Json.Serialize(Model.Sites.ToDictionary(s => s.SiteId, s => new { partnerId = s.PartnerId, partnerName = s.Partner != null ? s.Partner.Name : $"Partner {s.PartnerId}" }));
    console.log('sitePartnerMap:', sitePartnerMap);

    // TomSelect initialization function
    function initializePartnerTomSelect(element, modalId, context, preselectedId, preselectedText) {
        return new Promise((resolve, reject) => {
            try {
                console.log(`Initializing TomSelect for ${modalId}, context: ${context}, preselectedId: ${preselectedId}, preselectedText: ${preselectedText}`);

                // Prepare fallback options from sitePartnerMap if API fails
                const fallbackOptions = Object.values(sitePartnerMap).map(p => ({
                    id: p.partnerId,
                    text: p.partnerName
                }));

                const tomSelect = new TomSelect(element, {
                    valueField: 'id',
                    labelField: 'text',
                    searchField: ['text'],
                    maxItems: 1,
                    maxOptions: 50,
                    placeholder: '-- Válasszon partnert --',
                    load: function (query, callback) {
                        const url = `/api/partners/select?search=${encodeURIComponent(query)}`;
                        console.log(`Fetching partners from ${url}`);
                        $.ajax({
                            url: url,
                            type: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'Authorization': 'Bearer ' + getAuthToken() // Adjust based on your auth mechanism
                            },
                            success: function (response) {
                                console.log(`API response data for ${url}:`, response);
                                callback(response);
                            },
                            error: function (xhr, status, error) {
                                console.error(`Failed to load partners for ${modalId}:`, error);
                                callback(fallbackOptions); // Fallback to sitePartnerMap options
                            }
                        });
                    },
                    render: {
                        option: function (item, escape) {
                            return `<div>${escape(item.text)}</div>`;
                        },
                        item: function (item, escape) {
                            return `<div>${escape(item.text)}</div>`;
                        }
                    },
                    onInitialize: function () {
                        if (preselectedId && preselectedText) {
                            console.log(`Adding preselected option for ${modalId}: id=${preselectedId}, text=${preselectedText}`);
                            this.addOption({ id: preselectedId, text: preselectedText });
                            this.addItem(preselectedId);
                        }
                    }
                });

                resolve(tomSelect);
            } catch (error) {
                console.error(`Error initializing TomSelect for ${modalId}:`, error);
                element.innerHTML = `<option value="${preselectedId || ''}" selected>${preselectedText || 'Nincs elérhető partner'}</option>`;
                reject(error);
            }
        });
    }

    // Initialize TomSelect for both create and edit modals
    $('.modal').on('shown.bs.modal', function (e) {
        const modal = $(this);
        const partnerSelect = modal.find('select[name="partnerId"]');

        if (partnerSelect.length) {
            let modalId, context, preselectedId, preselectedText;

            if (modal.attr('id') === 'createSiteModal') {
                modalId = 'createSiteModal';
                context = 'site-create';
                preselectedId = null;
                preselectedText = null;
            } else if (partnerSelect.attr('id').startsWith('edit-partner-select-')) {
                const siteId = parseInt(partnerSelect.attr('id').replace('edit-partner-select-', ''), 10);
                const preselectedPartner = sitePartnerMap[siteId] || { partnerId: null, partnerName: null };
                modalId = `editSiteModal_${siteId}`;
                context = 'site-edit';
                preselectedId = preselectedPartner.partnerId;
                preselectedText = preselectedPartner.partnerName;
            } else {
                return; // Skip if not a partner select modal
            }

            console.log(`Modal shown for ${modalId}, PreselectedId: ${preselectedId}, PreselectedText: ${preselectedText}`);

            if (partnerSelect[0].tomselect) {
                partnerSelect[0].tomselect.destroy();
                console.log(`Destroyed existing Partner TomSelect for ${modalId}`);
            }

            initializePartnerTomSelect(
                partnerSelect[0],
                modalId,
                context,
                preselectedId,
                preselectedText
            ).then(tomSelect => {
                console.log(`Partner select initialized for ${modalId}`);
            }).catch(err => {
                console.error(`Failed to initialize partner select for ${modalId}:`, err);
                partnerSelect.html(`<option value="${preselectedId || ''}" selected>${preselectedText || 'Nincs partner'}</option>`);
            });
        }

        // Ensure status selects remain native
        const statusSelect = modal.find('select[name="statusId"]');
        if (statusSelect.length && statusSelect.attr('id').startsWith('edit-status-select-')) {
            const siteId = parseInt(statusSelect.attr('id').replace('edit-status-select-', ''), 10);
            console.log(`Native status select for SiteId: ${siteId}`);
            if (statusSelect[0].tomselect) {
                statusSelect[0].tomselect.destroy();
                console.log(`Destroyed stray TomSelect on status select for SiteId: ${siteId}`);
            }
        }
    });

    // Form validation for modals
    document.querySelectorAll('.modal form').forEach(form => {
        form.addEventListener('submit', function (event) {
            const formData = new FormData(this);
            console.log('Form data:', Object.fromEntries(formData));
            if (!this.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            this.classList.add('was-validated');
        }, false);
    });

    // Search form handling
    document.addEventListener('DOMContentLoaded', function () {
        const searchForm = document.querySelector('form[method="get"]');
        if (searchForm) {
            searchForm.addEventListener('submit', function (e) {
                const searchInput = document.getElementById('searchInput');
                if (searchInput.value.trim() === '') {
                    e.preventDefault();
                    window.location.href = window.location.pathname;
                }
            });
        }

        document.querySelectorAll('[data-filter]').forEach(item => {
            item.addEventListener('click', function (e) {
                e.preventDefault();
                const filter = this.getAttribute('data-filter');
                console.log('Filter by:', filter);
                // Add actual filter logic here if needed
            });
        });
    });

    // Debug clicks on status selects
    $('select[id="create-status-select"], select[id^="edit-status-select-"]').on('click', function (e) {
        console.log('Native status select clicked:', this.id);
    });

    // Function to get auth token (implement based on your auth setup)
    function getAuthToken() {
        // Replace with your method to retrieve the JWT token (e.g., from localStorage, session, or cookie)
        // Example: return localStorage.getItem('jwtToken');
        return ''; // Placeholder
    }
});
</script>
    }