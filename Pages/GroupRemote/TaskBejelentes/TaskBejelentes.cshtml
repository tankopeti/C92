@page
@model Cloud9_2.Pages.GroupRemote.TaskBejelentes.TaskBejelentesModel
@using Cloud9_2.Models
@using System.Globalization
@using System.Web

@{
    var filteredTasks = Model.TaskBejelentes.Items
        .Where(t => t.TaskStatusPMId > 1000)
        .ToList();
}

@{
    ViewData["Title"] = "Bejelentések";
    Layout = "_Layout";
}

@await Html.PartialAsync("_GroupRemoteSidebar")

<div class="right-content">
    <div class="page-header-fixed-top">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-body-tertiary rounded-3 p-2 mb-0">
                    <li class="breadcrumb-item"><a href="../../">Főoldal</a></li>
                    <li class="breadcrumb-item"><a href="/GroupRemote/Dashboard">Táv és csoportmunka</a></li>
                    <li class="breadcrumb-item active">Bejelentések</li>
                </ol>
            </nav>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newTaskModal">
                + Új bejelentés
            </button>

            <div class="d-flex gap-2">
                <form method="get" asp-page="./Index" class="input-group input-group-sm" style="width: 250px;">
                    <input type="text" class="form-control" placeholder="Keresés..." name="SearchTerm" value="@Model.SearchTerm">
                    <input type="hidden" name="pageSize" value="@Model.PageSize" />
                    <button class="btn btn-outline-secondary" type="submit"><i class="bi bi-search"></i></button>
                    @if (!string.IsNullOrEmpty(Model.SearchTerm))
                    {
                        <a href="@Url.Page("./Index")" class="btn btn-outline-danger btn-sm"><i class="bi bi-x"></i></a>
                    }
                </form>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-funnel"></i> Rendezés
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" asp-page="./Index" asp-route-sort="CreatedDate" asp-route-order="desc">Legújabb</a></li>
                        <li><a class="dropdown-item" asp-page="./Index" asp-route-sort="Title" asp-route-order="asc">Cím A-Z</a></li>
                        <li><a class="dropdown-item" asp-page="./Index" asp-route-sort="DueDate" asp-route-order="asc">Határidő</a></li>
                        <li><a class="dropdown-item" asp-page="./Index" asp-route-sort="TaskStatusPMName" asp-route-order="asc">Státusz</a></li>
                        <li><a class="dropdown-item" asp-page="./Index" asp-route-sort="TaskPriorityPMName" asp-route-order="asc">Prioritás</a></li>
                    </ul>
                </div>
            </div>
        </div>

<div class="table-responsive table-dynamic-height" data-page-size="@Model.PageSize">
    <table class="table table-striped table-hover">
<thead class="sticky-top custom-thead">
    <tr>
        <th>Th. Azon.</th>
        <th>Telephely</th>
        <th>Cím</th>
        <th>Partner</th>
        <th>Tárgy</th>
        <th>Priorítás</th>
        <th>Esedékesség</th>
        <th>Státusz</th>
        <th>Bejelentés dátuma</th>
        <th>Utolsó módosítás</th>
        <th>Ügyintéző</th>
    </tr>
</thead>

<tbody>
    @if (filteredTasks.Any())
    {
        @foreach (var t in filteredTasks)
        {
            var shortDesc = string.IsNullOrWhiteSpace(t.Description)
                ? "n/a"
                : (t.Description.Length > 40 ? t.Description.Substring(0, 40) + "..." : t.Description);

            <tr data-task-id="@t.Id">
                <td class="text-nowrap" onclick="Tasks.openViewModal(@t.Id)">@t.Id</td>
                <td class="text-nowrap" onclick="Tasks.openViewModal(@t.Id)">@t.SiteName</td>
                <td class="text-nowrap" onclick="Tasks.openViewModal(@t.Id)">@t.City</td>
                <td class="text-nowrap" onclick="Tasks.openViewModal(@t.Id)">@t.PartnerName</td>
                <td class="text-nowrap" onclick="Tasks.openViewModal(@t.Id)">@t.Title</td>
                <td class="text-nowrap">@t.TaskPriorityPMName</td>
                <td class="text-nowrap" onclick="Tasks.openViewModal(@t.Id)">@t.DueDate</td>                
                <td class="text-nowrap">
                    <span class="badge text-white" style="background-color:@(string.IsNullOrWhiteSpace(t.ColorCode) ? "#6c757d" : t.ColorCode)">
                        @t.TaskStatusPMName
                    </span>
                </td>
                <td class="text-nowrap" onclick="Tasks.openViewModal(@t.Id)">@t.CreatedDate</td>
                <td class="text-nowrap" onclick="Tasks.openViewModal(@t.Id)">@t.UpdatedDate</td>
                <td class="text-nowrap" onclick="Tasks.openViewModal(@t.Id)">@t.AssignedToName</td>

                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-info" onclick="Tasks.openViewModal(@t.Id)">
                            <i class="bi bi-eye"></i>
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle btn-sm" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" onclick="Tasks.openEditModal(@t.Id)">Szerkesztés</a></li>
                                <li><a class="dropdown-item btn-show-history" data-task-id="@t.Id">Előzmények</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" onclick="Tasks.openDeleteModal(@t.Id)">Törlés</a></li>
                            </ul>
                        </div>
                    </div>
                </td>
            </tr>
        }
    }
    else
    {
        <tr>
            <td colspan="13" class="text-center py-5">
                <div class="alert alert-info">
                    Nincs megjeleníthető intézkedés.
                </div>
            </td>
        </tr>
    }
</tbody>

            </table>
        </div>

        @await Html.PartialAsync("~/Pages/Shared/_PaginationFooter.cshtml", new PaginationViewModel
        {
            CurrentPage = Model.CurrentPage,
            TotalPages = Model.TotalPages,
            PageSize = Model.PageSize,
            SearchTerm = Model.SearchTerm,
            PageRoute = "./Index",
            EntityName = "Intézkedések"
        })
    </div>

    <div id="toastContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100;"></div>
</div>

<!-- SMS MODAL -->
<div class="modal fade" id="sendSmsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-chat-dots me-2"></i>SMS küldése a járőrnek</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" asp-page-handler="SendSms" id="smsForm">
                @Html.AntiForgeryToken()
                <input type="hidden" name="TaskId" id="smsTaskId" />

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Járőr</label>
                        <div class="form-control-plaintext" id="smsRecipient">-</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Telefonszám</label>
                        <div class="form-control-plaintext text-success fw-bold" id="smsPhoneNumber">-</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Telephely</label>
                        <div class="form-control-plaintext" id="smsSite">-</div>
                    </div>
                    <div class="mb-3">
                        <label for="smsMessage" class="form-label">Üzenet <small class="text-muted">(max 160 karakter)</small></label>
                        <textarea class="form-control" name="Message" id="smsMessage" rows="5" maxlength="160" required></textarea>
                        <div class="text-end text-muted small mt-1"><span id="smsCharCount">0</span>/160</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Mégse</button>
                    <button type="submit" class="btn btn-success"><i class="bi bi-send"></i> Küldés</button>
                </div>
            </form>
        </div>
    </div>
</div>

@await Html.PartialAsync("_TaskModals")

@section Scripts {
    <script src="~/js/Task/tasks.js"></script>
    <script src="~/js/Task/fileattach.js"></script>
    <script src="~/js/Task/tasks_nyugalom.js" defer></script>
}