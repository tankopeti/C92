@page
@model Cloud9_2.Pages.GroupRemote.Tasks.IndexModel
@using Cloud9_2.Models
@using System.Globalization
@{
    ViewData["Title"] = "Feladatok";
    Layout = "_Layout";
}

@await Html.PartialAsync("_GroupRemoteSidebar")

<div class="right-content">
    <div class="page-header-fixed-top">
        <!-- Breadcrumb -->
        <div class="d-flex justify-content-between align-items-center mb-2">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-body-tertiary rounded-3 p-2 mb-0">
                    <li class="breadcrumb-item"><a href="../../">Főoldal</a></li>
                    <li class="breadcrumb-item"><a href="../">Group Remote</a></li>
                    <li class="breadcrumb-item active">Feladatok</li>
                </ol>
            </nav>
        </div>

        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newTaskModal">
                + Új feladat
            </button>

            <div class="d-flex gap-2">
                <form method="get" asp-page="./Index" class="input-group input-group-sm" style="width: 250px;">
                    <input type="text" class="form-control" placeholder="Keresés..." name="SearchTerm" value="@Model.SearchTerm">
                    <input type="hidden" name="pageSize" value="@Model.PageSize" />
                    <button class="btn btn-outline-secondary" type="submit"><i class="bi bi-search"></i></button>
                    @if (!string.IsNullOrEmpty(Model.SearchTerm))
                    {
                        <a href="@Url.Page("./Index")" class="btn btn-outline-danger btn-sm"><i class="bi bi-x"></i></a>
                    }
                </form>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-funnel"></i> Rendezés
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" asp-page="./Index" asp-route-sort="CreatedDate" asp-route-order="desc">Legújabb</a></li>
                        <li><a class="dropdown-item" asp-page="./Index" asp-route-sort="Title" asp-route-order="asc">Cím A-Z</a></li>
                        <li><a class="dropdown-item" asp-page="./Index" asp-route-sort="DueDate" asp-route-order="asc">Határidő</a></li>
                        <li><a class="dropdown-item" asp-page="./Index" asp-route-sort="TaskStatusPMName" asp-route-order="asc">Státusz</a></li>
                        <li><a class="dropdown-item" asp-page="./Index" asp-route-sort="TaskPriorityPMName" asp-route-order="asc">Prioritás</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
            <table class="table table-striped table-hover">
                <thead class="sticky-top custom-thead">
                    <tr>
                        @foreach (var column in new[] { "Title", "Project", "Status", "Priority", "AssignedTo", "DueDate", "Created", "Actions" })
                        {
                            <th class="text-nowrap">
                                @(column == "Title" ? "Cím" :
                                  column == "Project" ? "Projekt" :
                                  column == "Status" ? "Státusz" :
                                  column == "Priority" ? "Prioritás" :
                                  column == "AssignedTo" ? "Felelős" :
                                  column == "DueDate" ? "Határidő" :
                                  column == "Created" ? "Létrehozva" :
                                  column == "Actions" ? "Műveletek" : column)
                            </th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Tasks.Items.Any())
                    {
                        @foreach (var t in Model.Tasks.Items)
                        {
                            <tr data-task-id="@t.Id">
                                <td class="text-nowrap">
                                    <i class="bi bi-list-check me-1"></i>
                                    <a href="#" onclick="Tasks.openViewModal(@t.Id)">@t.Title</a>
                                </td>
                                @* <td class="text-nowrap">@(t.ProjectPMName ?? "-")</td> *@
                                <td class="text-nowrap">
                                    @{
                                        var statusColor = t.TaskStatusPMName switch
                                        {
                                            "Open" => "#007bff",
                                            "In Progress" => "#ffc107",
                                            "Completed" => "#28a745",
                                            "Cancelled" => "#dc3545",
                                            _ => "#6c757d"
                                        };
                                    }
                                    <span class="badge" style="background-color:@statusColor">
                                        @t.TaskStatusPMName
                                    </span>
                                </td>
                                <td class="text-nowrap">
                                    <span class="badge bg-secondary">@t.TaskPriorityPMName</span>
                                </td>
                                <td class="text-nowrap">
                                    <i class="bi bi-person me-1"></i>
                                    @(t.AssignedToName ?? "-")
                                </td>
                                <td class="text-nowrap">
                                    @if (t.DueDate.HasValue)
                                    {
                                        <i class="bi bi-calendar me-1"></i>
                                        @t.DueDate.Value.ToString("yyyy-MM-dd")
                                    }
                                    else { <text>-</text> }
                                </td>
                                <td class="text-nowrap">
                                    <small>@t.CreatedDate?.ToString("yy-MM-dd HH:mm")</small><br />
                                    <small class="text-muted">@t.CreatedByName</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <!-- VIEW -->
                                        <button type="button"
                                                class="btn btn-outline-info"
                                                onclick="Tasks.openViewModal(@t.Id)">
                                            <i class="bi bi-eye"></i>
                                        </button>

                                        <!-- ACTIONS DROPDOWN -->
                                        <div class="dropdown">
                                            <button class="btn btn-outline-secondary dropdown-toggle btn-sm"
                                                    type="button"
                                                    id="actionsDropdown_@t.Id"
                                                    data-bs-toggle="dropdown">
                                                <i class="bi bi-three-dots-vertical"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="actionsDropdown_@t.Id">
                                                <li>
                                                    <a class="dropdown-item" onclick="Tasks.openEditModal(@t.Id)">
                                                        <i class="bi bi-pencil-square me-2"></i>Szerkesztés
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item btn-show-history" data-task-id="@t.Id">
                                                        <i class="bi bi-clock-history me-2"></i>Előzmények
                                                    </a>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <a class="dropdown-item text-danger" onclick="Tasks.openDeleteModal(@t.Id)">
                                                        <i class="bi bi-trash me-2"></i>Törlés
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <div class="alert alert-warning" role="alert">
                                    @if (!string.IsNullOrEmpty(Model.SearchTerm))
                                    {
                                        @:Nincs találat a "@Model.SearchTerm" keresésre az @Model.CurrentPage. oldalon.
                                    }
                                    else if (Model.TotalRecords > 0)
                                    {
                                        @:Nincs feladat az @Model.CurrentPage. oldalon, de @Model.TotalRecords feladat létezik.
                                    }
                                    else
                                    {
                                        @:Nincs feladat. 
                                        <button type="button" class="btn btn-link alert-link p-0 align-baseline" 
                                                data-bs-toggle="modal" data-bs-target="#newTaskModal">
                                            Hozza létre az elsőt?
                                        </button>
                                    }
                                    <div class="mt-2 small text-muted">
                                        Debug: Page=@Model.CurrentPage, PageSize=@Model.PageSize, TotalRecords=@Model.TotalRecords
                                    </div>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        @await Html.PartialAsync("~/Pages/Shared/_PaginationFooter.cshtml", new PaginationViewModel
        {
            CurrentPage = Model.CurrentPage,
            TotalPages = Model.TotalPages,
            PageSize = Model.PageSize,
            SearchTerm = Model.SearchTerm,
            PageRoute = "./Index",
            EntityName = "Feladatok"
        })
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100;"></div>
</div>

<!-- Include Modals -->
@await Html.PartialAsync("_TaskModals")

@section Scripts {
    <script src="~/js/tasks.js"></script>
}