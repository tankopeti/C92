
@page
@using Microsoft.AspNetCore.Mvc.Rendering
@using Cloud9_2.Models
@using System.Globalization
@model Cloud9_2.Pages.CRM.Quotes.IndexModel

@{
    Layout = "_Layout";
}

@await Html.PartialAsync("_CRMSidebar")

<div class="right-content">
    <div class="page-header-fixed-top">
        <!-- Breadcrumb Navigation -->
        <div class="d-flex justify-content-between align-items-center mb-2">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-body-tertiary rounded-3 p-2 mb-0">
                    <li class="breadcrumb-item"><a href="../../">Főoldal</a></li>
                    <li class="breadcrumb-item"><a href="../">CRM Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Quotes</li>
                    <li class="breadcrumb-item active" aria-current="page">@Model.Quotes.Count of @Model.TotalRecords quote@(Model.TotalRecords != 1 ? "s" : "") (Page @Model.CurrentPage of @Model.TotalPages)</li>
                </ol>
            </nav>
        </div>

        <!-- Header with Buttons and Search -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center gap-2">
                <button type="button" id="newQuoteButton" class="btn-new" data-bs-toggle="modal" data-bs-target="#newQuoteModal" aria-label="Új árajánlat létrehozása">
                    <i class="bi bi-plus-circle me-1"></i>Új árajánlat
                </button>
            </div>
            <div class="d-flex align-items-center gap-2">
                <form method="get" asp-page="./Index" class="input-group input-group-sm" style="width: 250px;">
                    <input type="text" class="form-control" placeholder="Keresés..." id="searchInput" name="SearchTerm" value="@Model.SearchTerm" autocomplete="off" aria-label="Keresés árajánlatok között">
                    <input type="hidden" name="pageSize" value="@Model.PageSize" />
                    <button class="btn btn-outline-secondary" type="submit" aria-label="Keresés indítása">
                        <i class="bi bi-search"></i>
                    </button>
                </form>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Szűrési opciók">
                        <i class="bi bi-funnel me-1"></i>Szűrés
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" data-filter="all">All Quotes</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="Draft">Draft</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="Sent">Sent</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="Accepted">Accepted</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="Rejected">Rejected</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Card Grid Header -->
        <div class="card-grid-header">
            <div class="card-grid-row">
                <div class="card-grid-column quote-number-col">Ajánlat szám</div>
                <div class="card-grid-column quote-partner-col">Partner</div>
                <div class="card-grid-column quote-date-col">Dátum</div>
                <div class="card-grid-column quote-status-col">Státusz</div>
                <div class="card-grid-column quote-amount-col">Ajánlat összege</div>
                <div class="card-grid-column actions-column">Műveletek</div>
            </div>
        </div>
    </div>

    <!-- Card Grid Body -->
    <div class="scrollable-card-container">
        <div class="card-grid-body">
            @if (Model.Quotes.Any())
            {
                @foreach (var quote in Model.Quotes)
                {
                    <div class="card partner-card mb-3" data-quote-id="@quote.QuoteId">
                        <div class="card-body p-2">
                            <div class="card-grid-row align-items-center">
                                <div class="card-grid-cell quote-number-col">
                                    <div class="quote-info">
                                        <div class="fw-bold">@quote.QuoteNumber</div>
                                    </div>
                                </div>
                                <div class="card-grid-cell quote-partner-col">
                                    <div class="quote-partner text-muted small">
                                        <i class="bi bi-person me-1"></i>@quote.Partner.Name
                                    </div>
                                </div>
                                <div class="card-grid-cell quote-date-col">
                                    <div class="quote-date text-muted small">
                                        <i class="bi bi-calendar me-1"></i>@quote.QuoteDate?.ToString("yyyy-MM-dd")
                                    </div>
                                </div>
                                <div class="card-grid-cell quote-status-col">
                                    @{
                                        var badgeClass = "badge bg-secondary";
                                        if (quote.Status == "Tervezet") badgeClass = "badge badge-draft";
                                        else if (quote.Status == "Elküldve") badgeClass = "badge badge-sent";
                                        else if (quote.Status == "Elfogadva") badgeClass = "badge badge-accepted";
                                        else if (quote.Status == "Elutasítva") badgeClass = "badge badge-rejected";
                                    }
                                    <span class="@badgeClass">@quote.Status</span>
                                </div>
                                <div class="card-grid-cell quote-amount-col">
                                    <div class="quote-amount text-muted small">
                                        <i class="bi bi-currency-dollar me-1"></i>@quote.TotalAmount?.ToString("C")
                                    </div>
                                </div>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-info btn-sm view-quote-btn"
                                            data-bs-toggle="modal"
                                            data-bs-target="#viewQuoteModal_@quote.QuoteId"
                                            aria-label="Árajánlat részleteinek megtekintése">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <div class="dropdown">
                                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button"
                                                id="actionsDropdown_@quote.QuoteId"
                                                data-bs-toggle="dropdown" 
                                                aria-expanded="false"
                                                aria-label="További műveletek">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="actionsDropdown_@quote.QuoteId">
                                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editQuoteModal_@quote.QuoteId"><i class="bi bi-pencil-square me-2"></i>Szerkesztés</a></li>
                                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#quoteItemsModal_@quote.QuoteId"><i class="bi bi-list-ul me-2"></i>Tételek szerkesztése</a></li>
                                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#viewQuoteModal_@quote.QuoteId"><i class="bi bi-eye me-2"></i>Megtekintés</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="copyQuote(@quote.QuoteId)"><i class="bi bi-copy me-2"></i>Másolás</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deleteQuoteModal_@quote.QuoteId"><i class="bi bi-trash me-2"></i>Törlés</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="alert alert-warning text-center mt-3" role="alert">
                    @if (!string.IsNullOrEmpty(Model.SearchTerm))
                    {
                        @:No quotes found matching "@Model.SearchTerm" on page @Model.CurrentPage.
                    }
                    else if (Model.TotalRecords > 0)
                    {
                        @:No quotes found on page @Model.CurrentPage, but @Model.TotalRecords quotes exist. Try changing the page or adjusting filters.
                    }
                    else
                    {
                        @:No quotes found. <button type="button" class="btn btn-link alert-link p-0 align-baseline" data-bs-toggle="modal" data-bs-target="#newQuoteModal" aria-label="Első árajánlat létrehozása">Create the first one?</button>
                    }
                    <!-- Debug Info -->
                    <div class="mt-2 small text-muted">
                        Debug: Page=@Model.CurrentPage, PageSize=@Model.PageSize, TotalRecords=@Model.TotalRecords, SearchTerm="@Model.SearchTerm"
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Pagination Footer -->
    @await Html.PartialAsync("_PaginationFooter", new PaginationViewModel
    {
        CurrentPage = Model.CurrentPage,
        TotalPages = Model.TotalPages,
        PageSize = Model.PageSize,
        SearchTerm = Model.SearchTerm,
        PageRoute = "./Index",
        EntityName = "Quotes"
    })

    <!-- New Quote Modal -->
    <div class="modal fade" id="newQuoteModal" tabindex="-1" aria-labelledby="newQuoteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newQuoteModalLabel">Új árajánlat</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Bezárás"></button>
                </div>
                <div class="modal-body">
                    <form id="quoteForm" method="post" class="needs-validation" novalidate>
                        @Html.AntiForgeryToken()
                        <input type="hidden" id="quoteId" name="QuoteId" value="0">
                        <!-- Tabs -->
                        <ul class="nav nav-tabs" id="quoteTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="true">Részletek</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="items-tab" data-bs-toggle="tab" data-bs-target="#items" type="button" role="tab" aria-controls="items" aria-selected="false">Tételek</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="discounts-tab" data-bs-toggle="tab" data-bs-target="#discounts" type="button" role="tab" aria-controls="discounts" aria-selected="false">Kedvezmények</button>
                            </li>
                        </ul>
                        <div class="tab-content" id="quoteTabContent">
                            <!-- Quote Details Tab -->
                            <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
                                <div class="mb-3">
                                    <label for="partnerId" class="form-label">Partner <span class="text-danger">*</span></label>
                                    <select id="partnerId" name="PartnerId" class="form-control select2-partner" required aria-label="Partner kiválasztása">
                                        <option value="">Válasszon partnert...</option>
                                    </select>
                                    <div class="invalid-feedback">Kérjük, válasszon partnert.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="currencyId" class="form-label">Pénznem <span class="text-danger">*</span></label>
                                    <select id="currencyId" name="CurrencyId" class="form-control select2-currency" required aria-label="Pénznem kiválasztása">
                                        <option value="">Válasszon pénznemet...</option>
                                    </select>
                                    <div class="invalid-feedback">Kérjük, válasszon pénznemet.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="salesPerson" class="form-label">Értékesítő <span class="text-danger">*</span></label>
                                    <input id="salesPerson" name="SalesPerson" type="text" class="form-control" required aria-label="Értékesítő neve">
                                    <div class="invalid-feedback">Kérjük, adja meg az értékesítő nevét.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="quoteDate" class="form-label required">Dátum <span class="text-danger">*</span></label>
                                    <input id="quoteDate" name="QuoteDate" type="date" class="form-control" required aria-label="Árajánlat dátuma">
                                    <div class="invalid-feedback">Kérjük, adja meg az árajánlat dátumát.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="validityDate" class="form-label">Érvényességi dátum</label>
                                    <input id="validityDate" name="ValidityDate" type="date" class="form-control" aria-label="Érvényességi dátum">
                                </div>
                                <div class="mb-3">
                                    <label for="subject" class="form-label">Tárgy <span class="text-danger">*</span></label>
                                    <input id="subject" name="Subject" type="text" maxlength="200" class="form-control" required aria-label="Árajánlat tárgya">
                                    <div class="invalid-feedback">Kérjük, adja meg az árajánlat tárgyát.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="description" class="form-label">Leírás</label>
                                    <input id="description" name="Description" type="text" maxlength="200" class="form-control" aria-label="Leírás">
                                </div>
                                <div class="mb-3">
                                    <label for="detailedDescription" class="form-label">Részletes leírás</label>
                                    <textarea id="detailedDescription" name="DetailedDescription" class="form-control" rows="5" aria-label="Részletes leírás"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="status" class="form-label">Státusz</label>
                                    <select id="status" name="Status" class="form-control" aria-label="Státusz kiválasztása">
                                        <option value="Draft" selected>Kész</option>
                                        <option value="Sent">Küldött</option>
                                        <option value="Approved">Elfogadott</option>
                                        <option value="Rejected">Elutasított</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Items Tab -->
                            <div class="tab-pane fade" id="items" role="tabpanel" aria-labelledby="items-tab">
                                <table id="quoteItemsTable" class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th>Termék</th>
                                            <th>Leírás</th>
                                            <th>Mennyiség</th>
                                            <th>Egységár</th>
                                            <th>Kedvezmény</th>
                                            <th>Összeg</th>
                                            <th>Műveletek</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                                <button type="button" class="btn btn-outline-primary btn-sm mb-3 toggle-item-form" aria-label="Új tétel hozzáadása"><i class="fas fa-plus"></i> Tétel hozzáadása</button>
                                <div class="item-form" style="display: none;">
                                    <div class="mb-3">
                                        <label for="newProductId" class="form-label">Termék <span class="text-danger">*</span></label>
                                        <select id="newProductId" class="form-control select2-product" required aria-label="Termék kiválasztása">
                                            <option value="">Válasszon terméket...</option>
                                        </select>
                                        <div class="invalid-feedback">Kérjük, válasszon terméket.</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="newItemDescription" class="form-label">Leírás</label>
                                        <input id="newItemDescription" class="form-control" aria-label="Tétel leírása">
                                    </div>
                                    <div class="mb-3">
                                        <label for="newQuantity" class="form-label">Mennyiség <span class="text-danger">*</span></label>
                                        <input id="newQuantity" type="number" min="1" class="form-control" required aria-label="Mennyiség">
                                        <div class="invalid-feedback">Kérjük, adja meg a mennyiséget (minimum 1).</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="newUnitPrice" class="form-label">Egységár <span class="text-danger">*</span></label>
                                        <input id="newUnitPrice" type="number" step="0.01" min="0.01" class="form-control" required aria-label="Egységár">
                                        <div class="invalid-feedback">Kérjük, adja meg az egységárat (minimum 0.01).</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="newDiscountPercentage" class="form-label">Kedvezmény (%)</label>
                                        <input id="newDiscountPercentage" type="number" step="0.01" min="0" max="100" class="form-control" value="0" aria-label="Kedvezmény százaléka">
                                    </div>
                                    <div class="mb-3">
                                        <label for="newDiscountAmount" class="form-label">Kedvezmény összege</label>
                                        <input id="newDiscountAmount" type="number" step="0.01" min="0" class="form-control" value="0" aria-label="Kedvezmény összege">
                                    </div>
                                    <div class="mb-3">
                                        <label for="newTotalPrice" class="form-label">Összeg</label>
                                        <input id="newTotalPrice" class="form-control" readonly aria-label="Tétel összege">
                                    </div>
                                    <button type="button" class="btn btn-primary btn-sm add-item" aria-label="Tétel hozzáadása">Tétel hozzáadása</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm cancel-item" aria-label="Mégse">Mégse</button>
                                </div>
                            </div>
                            <!-- Discounts Tab -->
                            <div class="tab-pane fade" id="discounts" role="tabpanel" aria-labelledby="discounts-tab">
                                <div class="mb-3">
                                    <label for="discountPercentage" class="form-label">Kedvezmény (%)</label>
                                    <input id="discountPercentage" name="DiscountPercentage" type="number" step="0.01" min="0" max="100" class="form-control" value="0.00" aria-label="Kedvezmény százaléka">
                                </div>
                                <div class="mb-3">
                                    <label for="discountAmount" class="form-label">Kedvezmény összege</label>
                                    <input id="discountAmount" name="DiscountAmount" type="number" step="0.01" min="0" class="form-control" value="0.00" aria-label="Kedvezmény összege">
                                </div>
                                <div class="mb-3">
                                    <label for="totalAmount" class="form-label">Végösszeg</label>
                                    <input id="totalAmount" name="TotalAmount" class="form-control" readonly value="0.00" aria-label="Végösszeg">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" aria-label="Mégse">Mégse</button>
                    <button type="button" class="btn btn-primary" id="saveQuoteButton" aria-label="Árajánlat mentése">Mentés</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Consolidated Edit Quote Modal -->
    <div class="modal fade" id="editQuoteModal" tabindex="-1" aria-labelledby="editQuoteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editQuoteModalLabel">Árajánlat szerkesztése</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Bezárás"></button>
                </div>
                <div class="modal-body">
                    <form id="editQuoteForm" method="post" asp-page-handler="EditQuote" class="needs-validation" novalidate>
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="QuoteId" id="editQuoteId" autocomplete="off" />
                        <ul class="nav nav-tabs" id="editQuoteTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab" aria-controls="basic" aria-selected="true">Alapadatok</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="false">Részletek</button>
                            </li>
                        </ul>
                        <div class="tab-content mt-3">
                            <!-- Basic Info Tab -->
                            <div class="tab-pane fade show active" id="basic" role="tabpanel" aria-labelledby="basic-tab">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="editQuoteNumber" class="form-label">Árajánlat száma</label>
                                        <input type="text" class="form-control" id="editQuoteNumber" name="QuoteNumber" maxlength="100" autocomplete="off">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="editQuoteDate" class="form-label">Dátum <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control" id="editQuoteDate" name="QuoteDate" required autocomplete="off">
                                        <div class="invalid-feedback">Dátum megadása kötelező.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="editPartnerId" class="form-label">Partner <span class="text-danger">*</span></label>
                                        <select class="form-select select2-partner" id="editPartnerId" name="PartnerId" required autocomplete="off">
                                            <option value="">Válasszon partnert...</option>
                                        </select>
                                        <div class="invalid-feedback">Partner kiválasztása kötelező.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="editSalesPerson" class="form-label">Értékesítő</label>
                                        <input type="text" class="form-control" id="editSalesPerson" name="SalesPerson" maxlength="100" autocomplete="off">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="editValidityDate" class="form-label">Érvényesség dátuma</label>
                                        <input type="date" class="form-control" id="editValidityDate" name="ValidityDate" autocomplete="off">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="editStatus" class="form-label">Státusz</label>
                                        <select class="form-select" id="editStatus" name="Status" autocomplete="off">
                                            <option value="Draft">Kész</option>
                                            <option value="Sent">Küldött</option>
                                            <option value="Accepted">Elfogadott</option>
                                            <option value="Rejected">Elutasított</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <!-- Details Tab -->
                            <div class="tab-pane fade" id="details" role="tabpanel" aria-labelledby="details-tab">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label for="editSubject" class="form-label">Tárgy</label>
                                        <input type="text" class="form-control" id="editSubject" name="Subject" maxlength="200" autocomplete="off">
                                    </div>
                                    <div class="col-12">
                                        <label for="editDescription" class="form-label">Leírás</label>
                                        <textarea class="form-control" id="editDescription" name="Description" maxlength="500" rows="3" autocomplete="off"></textarea>
                                    </div>
                                    <div class="col-12">
                                        <label for="editDetailedDescription" class="form-label">Részletes leírás</label>
                                        <textarea class="form-control" id="editDetailedDescription" name="DetailedDescription" rows="5" autocomplete="off"></textarea>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="editDiscountPercentage" class="form-label">Kedvezmény %</label>
                                        <input type="number" step="0.01" min="0" max="100" class="form-control" id="editDiscountPercentage" name="DiscountPercentage" autocomplete="off">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="editDiscountAmount" class="form-label">Kedvezmény összeg</label>
                                        <input type="number" step="0.01" min="0" class="form-control" id="editDiscountAmount" name="DiscountAmount" autocomplete="off">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="editTotalAmount" class="form-label">Összesen</label>
                                        <input type="text" class="form-control" id="editTotalAmount" name="TotalAmount" readonly autocomplete="off">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary" aria-label="Változtatások mentése">Változtatások mentése</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Mégse">Mégse</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Quote Items Modal -->
    @foreach (var quote in Model.Quotes)
    {
        <div class="modal fade" id="quoteItemsModal_@quote.QuoteId" tabindex="-1" aria-labelledby="quoteItemsModalLabel_@quote.QuoteId" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="quoteItemsModalLabel_@quote.QuoteId">Tételek: @(quote.Description ?? "N/A")</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Bezárás"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newQuoteItemModal_@quote.QuoteId" aria-label="Új tétel hozzáadása">
                                <i class="bi bi-plus-circle me-1"></i> Új tétel
                            </button>
                        </div>
                        <table class="table table-hover" id="quoteItemsTable_@quote.QuoteId">
                            <thead>
                                <tr>
                                    <th scope="col">Termék</th>
                                    <th scope="col">Leírás</th>
                                    <th scope="col">Mennyiség</th>
                                    <th scope="col">Egységár</th>
                                    <th scope="col">Kedvezmény</th>
                                    <th scope="col">Összeg</th>
                                    <th scope="col">Műveletek</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (!quote.QuoteItems.Any())
                                {
                                    <tr>
                                        <td colspan="7">Nincsenek tételek az árajánlathoz.</td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var quoteItem in quote.QuoteItems)
                                    {
                                        <tr data-item-id="@quoteItem.QuoteItemId">
                                            <td>@(quoteItem.Product?.Name ?? "N/A")</td>
                                            <td>@quoteItem.ItemDescription</td>
                                            <td>@quoteItem.Quantity</td>
                                            <td>@quoteItem.UnitPrice.ToString("F2", CultureInfo.GetCultureInfo("hu-HU"))</td>
                                            <td>
                                                @(quoteItem.DiscountPercentage.HasValue && quoteItem.DiscountPercentage.Value > 0
                                                    ? $"{quoteItem.DiscountPercentage.Value:F2}%"
                                                    : quoteItem.DiscountAmount.HasValue && quoteItem.DiscountAmount.Value > 0
                                                        ? $"{quoteItem.DiscountAmount.Value:F2}"
                                                        : "0,00")
                                            </td>
                                            <td>
                                                @((quoteItem.Quantity * quoteItem.UnitPrice - (quoteItem.DiscountAmount ?? (quoteItem.DiscountPercentage.HasValue ? (quoteItem.Quantity * quoteItem.UnitPrice * quoteItem.DiscountPercentage.Value / 100) : 0))).ToString("F2", CultureInfo.GetCultureInfo("hu-HU")))
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <button class="btn btn-primary btn-sm edit-quote-item"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#editQuoteItemModal"
                                                            data-quote-id="@quote.QuoteId"
                                                            data-item-id="@quoteItem.QuoteItemId"
                                                            data-product-id="@quoteItem.ProductId"
                                                            data-product-name="@(quoteItem.Product?.Name ?? "")"
                                                            data-quantity="@quoteItem.Quantity"
                                                            data-unit-price="@quoteItem.UnitPrice.ToString("F2", CultureInfo.GetCultureInfo("hu-HU"))"
                                                            data-discount="@(quoteItem.DiscountPercentage.HasValue && quoteItem.DiscountPercentage.Value > 0 ? quoteItem.DiscountPercentage.Value.ToString("F2", CultureInfo.GetCultureInfo("hu-HU")) : quoteItem.DiscountAmount.HasValue && quoteItem.DiscountAmount.Value > 0 ? quoteItem.DiscountAmount.Value.ToString("F2", CultureInfo.GetCultureInfo("hu-HU")) : "")"
                                                            data-discount-type="@(quoteItem.DiscountPercentage.HasValue && quoteItem.DiscountPercentage.Value > 0 ? "percentage" : "amount")"
                                                            data-description="@quoteItem.ItemDescription"
                                                            data-total-price="@((quoteItem.Quantity * quoteItem.UnitPrice - (quoteItem.DiscountAmount ?? (quoteItem.DiscountPercentage.HasValue ? (quoteItem.Quantity * quoteItem.UnitPrice * quoteItem.DiscountPercentage.Value / 100) : 0))).ToString("F2", CultureInfo.GetCultureInfo("hu-HU")))"
                                                            aria-label="Tétel szerkesztése">
                                                        <i class="bi bi-pencil-square me-1"></i>Szerkesztés
                                                    </button>
                                                    <button class="btn btn-danger btn-sm delete-item"
                                                            data-quote-id="@quote.QuoteId"
                                                            data-item-id="@quoteItem.QuoteItemId"
                                                            aria-label="Tétel törlése">
                                                        <i class="bi bi-trash me-2"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Bezárás">Bezárás</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Quote Item Modal -->
        <div class="modal fade" id="newQuoteItemModal_@quote.QuoteId" tabindex="-1" aria-labelledby="newQuoteItemModalLabel_@quote.QuoteId" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="newQuoteItemModalLabel_@quote.QuoteId">Új tétel</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Bezárás"></button>
                    </div>
                    <div class="modal-body">
                        <form id="newQuoteItemForm_@quote.QuoteId" class="needs-validation" novalidate>
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="QuoteId" value="@quote.QuoteId" autocomplete="off" />
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="productId_@quote.QuoteId" class="form-label">Termék <span class="text-danger">*</span></label>
                                    <select class="form-select select2-product" id="productId_@quote.QuoteId" name="ProductId" required autocomplete="off">
                                        <option value="">Válasszon terméket...</option>
                                    </select>
                                    <div class="invalid-feedback">Termék kiválasztása kötelező.</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="newQuantity_@quote.QuoteId" class="form-label">Mennyiség <span class="text-danger">*</span></label>
                                    <input type="number" min="1" step="1" class="form-control quantity" id="newQuantity_@quote.QuoteId" name="Quantity" value="1" required autocomplete="off">
                                    <div class="invalid-feedback">Mennyiség megadása kötelező.</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="newUnitPrice_@quote.QuoteId" class="form-label">Egységár <span class="text-danger">*</span></label>
                                    <input type="number" step="0.01" min="0.01" class="form-control unitPrice" id="newUnitPrice_@quote.QuoteId" name="UnitPrice" value="0.00" required autocomplete="off">
                                    <div class="invalid-feedback">Egységár megadása kötelező.</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="newItemDiscount_@quote.QuoteId" class="form-label">Kedvezmény</label>
                                    <div class="input-group">
                                        <input type="number" step="0.01" min="0" class="form-control itemDiscount" id="newItemDiscount_@quote.QuoteId" name="Discount" value="0.00" placeholder="0.00" autocomplete="off">
                                        <select class="form-select" id="newItemDiscountType_@quote.QuoteId" name="DiscountType" style="width: auto;">
                                            <option value="percentage" selected>Százalék (%)</option>
                                            <option value="amount">Összeg (HUF)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label for="newItemDescription_@quote.QuoteId" class="form-label">Tétel leírása</label>
                                    <textarea class="form-control" id="newItemDescription_@quote.QuoteId" name="ItemDescription" maxlength="200" rows="3" autocomplete="off"></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label for="newTotalPrice_@quote.QuoteId" class="form-label">Összeg</label>
                                    <input type="text" class="form-control" id="newTotalPrice_@quote.QuoteId" value="0.00" readonly autocomplete="off">
                                </div>
                            </div>
                            <div class="mt-3">
                                <button type="button" class="btn btn-primary save-quote-item" data-quote-id="@quote.QuoteId" aria-label="Tétel mentése">Tétel mentése</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Mégse">Mégse</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- View Quote Modal -->
        <div class="modal fade" id="viewQuoteModal_@quote.QuoteId" tabindex="-1" aria-labelledby="viewQuoteModalLabel_@quote.QuoteId" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="viewQuoteModalLabel_@quote.QuoteId">Részletek: @quote.QuoteNumber</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Bezárás"></button>
                    </div>
                    <div class="modal-body">
                        <table class="table table-sm">
                            <tbody>
                                <tr><th>Árajánlat száma</th><td>@quote.QuoteNumber</td></tr>
                                <tr><th>Dátum</th><td>@quote.QuoteDate?.ToString("yyyy-MM-dd")</td></tr>
                                <tr><th>Partner</th><td>@quote.Partner.Name</td></tr>
                                <tr><th>Értékesítő</th><td>@quote.SalesPerson</td></tr>
                                <tr><th>Érvényesség dátuma</th><td>@(quote.ValidityDate?.ToString("yyyy-MM-dd"))</td></tr>
                                <tr><th>Státusz</th><td>@quote.Status</td></tr>
                                <tr><th>Tárgy</th><td>@quote.Subject</td></tr>
                                <tr><th>Leírás</th><td>@quote.Description</td></tr>
                                <tr><th>Részletes leírás</th><td>@quote.DetailedDescription</td></tr>
                                <tr><th>Kedvezmény %</th><td>@(quote.DiscountPercentage.HasValue ? quote.DiscountPercentage.Value.ToString("F2", CultureInfo.GetCultureInfo("hu-HU")) : "0,00")</td></tr>
                                <tr><th>Kedvezmény összeg</th><td>@(quote.DiscountAmount.HasValue ? quote.DiscountAmount.Value.ToString("F2", CultureInfo.GetCultureInfo("hu-HU")) : "0,00")</td></tr>
                                <tr><th>Összesen</th><td>@(quote.TotalAmount.HasValue ? quote.TotalAmount.Value.ToString("F2", CultureInfo.GetCultureInfo("hu-HU")) : "0,00")</td></tr>
                            </tbody>
                        </table>
                        <h5 class="mt-4">Tételek</h5>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Termék</th>
                                    <th>Leírás</th>
                                    <th>Mennyiség</th>
                                    <th>Egységár</th>
                                    <th>Kedvezmény</th>
                                    <th>Összesen</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (quote.QuoteItems != null && quote.QuoteItems.Any())
                                {
                                    @foreach (var quoteItem in quote.QuoteItems)
                                    {
                                        <tr data-item-id="@quoteItem.QuoteItemId">
                                            <td>@(quoteItem.Product?.Name ?? "N/A")</td>
                                            <td>@quoteItem.ItemDescription</td>
                                            <td>@quoteItem.Quantity</td>
                                            <td>@quoteItem.UnitPrice.ToString("F2", CultureInfo.GetCultureInfo("hu-HU"))</td>
                                            <td>
                                                @(quoteItem.DiscountPercentage.HasValue && quoteItem.DiscountPercentage.Value > 0
                                                    ? $"{quoteItem.DiscountPercentage.Value:F2}%"
                                                    : quoteItem.DiscountAmount.HasValue && quoteItem.DiscountAmount.Value > 0
                                                        ? $"{quoteItem.DiscountAmount.Value:F2}"
                                                        : "0,00")
                                            </td>
                                            <td>
                                                @((quoteItem.Quantity * quoteItem.UnitPrice - (quoteItem.DiscountAmount ?? (quoteItem.DiscountPercentage.HasValue ? (quoteItem.Quantity * quoteItem.UnitPrice * quoteItem.DiscountPercentage.Value / 100) : 0))).ToString("F2", CultureInfo.GetCultureInfo("hu-HU")))
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="6">Nincsenek tételek.</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Bezárás">Bezárás</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete Quote Modal -->
        <div class="modal fade" id="deleteQuoteModal_@quote.QuoteId" tabindex="-1" aria-labelledby="deleteQuoteModalLabel_@quote.QuoteId" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteQuoteModalLabel_@quote.QuoteId">Árajánlat törlése</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Bezárás"></button>
                    </div>
                    <div class="modal-body">
                        <form id="deleteQuoteForm_@quote.QuoteId" method="post" asp-page-handler="DeleteQuote">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="QuoteId" value="@quote.QuoteId" autocomplete="off" />
                            <p>Biztosan törölni szeretné a következő árajánlatot: <strong>@quote.QuoteNumber</strong>?</p>
                            <div id="deleteWarning_@quote.QuoteId" class="alert alert-warning" style="display: none;">
                                Ez az árajánlat nem törölhető, mert kapcsolódó rekordok léteznek.
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Mégse">Mégse</button>
                        <button type="button" class="btn btn-danger confirm-delete-quote" data-quote-id="@quote.QuoteId" aria-label="Árajánlat törlése">Törlés</button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Single Edit Quote Item Modal -->
    <div class="modal fade" id="editQuoteItemModal" tabindex="-1" aria-labelledby="editQuoteItemModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editQuoteItemModalLabel">Tétel szerkesztése</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Bezárás"></button>
                </div>
                <div class="modal-body">
                    <form id="editQuoteItemForm" class="needs-validation" novalidate>
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="QuoteId" id="editQuoteId" autocomplete="off" />
                        <input type="hidden" name="QuoteItemId" id="editQuoteItemId" autocomplete="off" />
                        <input type="hidden" name="ProductId" id="editProductId" autocomplete="off" />
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="editProductName" class="form-label">Termék <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editProductName" readonly autocomplete="off" required />
                                <div class="invalid-feedback">Termék kiválasztása kötelező.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="editQuantity" class="form-label">Mennyiség <span class="text-danger">*</span></label>
                                <input type="number" step="1" min="1" class="form-control quantity" id="editQuantity" name="Quantity" required autocomplete="off" />
                                <div class="invalid-feedback">Mennyiség megadása kötelező.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="editUnitPrice" class="form-label">Egységár <span class="text-danger">*</span></label>
                                <input type="number" step="0.01" min="0.01" class="form-control unitPrice" id="editUnitPrice" name="UnitPrice" required autocomplete="off" />
                                <div class="invalid-feedback">Egységár megadása kötelező.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="editItemDiscount" class="form-label">Kedvezmény</label>
                                <div class="input-group">
                                    <input type="number" step="0.01" min="0" class="form-control itemDiscount" id="editItemDiscount" name="Discount" placeholder="0.00" autocomplete="off" />
                                    <select class="form-select" id="editItemDiscountType" name="DiscountType" style="width: auto;">
                                        <option value="percentage">Százalék (%)</option>
                                        <option value="amount">Összeg (HUF)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-12">
                                <label for="editItemDescription" class="form-label">Tétel leírása</label>
                                <textarea class="form-control" id="editItemDescription" name="ItemDescription" maxlength="200" rows="3" autocomplete="off"></textarea>
                            </div>
                            <div class="col-md-6">
                                <label for="editTotalPrice" class="form-label">Összeg</label>
                                <input type="text" class="form-control" id="editTotalPrice" readonly autocomplete="off" />
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="button" class="btn btn-primary save-quote-item" id="saveQuoteItemBtn" aria-label="Tétel mentése">Tétel mentése</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Mégse">Mégse</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="toastContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055;"></div>

@section Scripts {
    <script>
        $(document).ready(function () {
            const debug = true;
            function log(message, ...args) {
                if (debug) console.log(`[DEBUG] ${message}`, ...args);
            }

            function showToast(type, message) {
                // Create the toast element
                const toast = $(`
                    <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">${message}</div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                `);

                // Append toast to the container
                $('#toastContainer').append(toast);

                // Initialize and show the toast
                const bsToast = new bootstrap.Toast(toast[0]);
                bsToast.show();

                // Remove the toast after 5 seconds
                setTimeout(() => toast.remove(), 5500); // Includes 500ms fade-out
            }

            function getTodayDate() {
                const today = new Date();
                return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            }

            function initializeSelect2(selector, type, dropdownParent = null) {
                log(`[Select2] Initializing for ${selector}, type: ${type}`);
                const $select = $(selector);
                if (!$select.length) {
                    log(`[Select2] ERROR: Element not found: ${selector}`);
                    showToast('error', `Select2 inicializációs hiba: ${selector} nem található`);
                    return;
                }

                if ($select.hasClass('select2-hidden-accessible')) {
                    $select.select2('destroy');
                    log(`[Select2] Destroyed existing Select2 instance for ${selector}`);
                }

                $select.select2({
                    ajax: {
                        url: type === 'product' ? '/api/Product' : type === 'currency' ? '/CRM/Quotes?handler=Currencies' : '/CRM/Quotes?handler=Partners',
                        dataType: 'json',
                        delay: 250,
                        data: params => ({ search: params.term || '' }),
                        processResults: (data) => {
                            log(`[Select2] ${type} response:`, data);
                            return {
                                results: data.map(item => ({
                                    id: item.id || item.CurrencyId || item.PartnerId,
                                    text: item.name || item.CurrencyName || item.text
                                }))
                            };
                        },
                        cache: true
                    },
                    minimumInputLength: 0,
                    placeholder: type === 'product' ? 'Válasszon terméket...' : type === 'currency' ? 'Válasszon pénznemet...' : 'Válasszon partnert...',
                    allowClear: true,
                    theme: 'bootstrap-5',
                    dropdownParent: dropdownParent ? $(dropdownParent) : undefined
                });
            }

            function calculateTotalPrice(formPrefix = 'new') {
                const quantity = parseFloat($(`#${formPrefix}Quantity`).val()) || 0;
                const unitPrice = parseFloat($(`#${formPrefix}UnitPrice`).val()) || 0;
                const discount = parseFloat($(`#${formPrefix}ItemDiscount`).val()) || 0;
                const discountType = $(`#${formPrefix}ItemDiscountType`).val();

                let total = quantity * unitPrice;
                if (discount > 0) {
                    total -= discountType === 'percentage' ? (total * discount / 100) : discount;
                }
                $(`#${formPrefix}TotalPrice`).val(total.toFixed(2).replace('.', ','));
                log(`[Calc] Total: Quantity=${quantity}, UnitPrice=${unitPrice}, Discount=${discount}, Type=${discountType}, Total=${total}`);
            }

            function updateTotalAmount(quoteId = null) {
                let subtotal = 0;
                if (quoteId) {
                    $(`#quoteItemsTable_${quoteId} tbody tr`).each(function() {
                        const quantity = parseFloat($(this).find('td:nth-child(3)').text()) || 0;
                        const unitPrice = parseFloat($(this).find('td:nth-child(4)').text().replace(',', '.')) || 0;
                        const discountText = $(this).find('td:nth-child(5)').text();
                        let discount = 0;
                        if (discountText.includes('%')) {
                            discount = quantity * unitPrice * parseFloat(discountText.replace('%', '').replace(',', '.')) / 100;
                        } else {
                            discount = parseFloat(discountText.replace(',', '.')) || 0;
                        }
                        subtotal += Math.max(0, (quantity * unitPrice) - discount);
                    });
                } else {
                    itemsData.forEach(item => subtotal += Math.max(0, item.totalPrice));
                }

                const discountPercentage = parseFloat($('#discountPercentage').val()) || 0;
                const discountAmount = parseFloat($('#discountAmount').val()) || 0;
                let total = subtotal;

                if (discountPercentage > 0) {
                    if (discountPercentage > 100) {
                        showToast('error', 'A kedvezmény százaléka nem lehet nagyobb 100%-nál!');
                        $('#discountPercentage').val('').addClass('is-invalid');
                        total = subtotal;
                    } else {
                        total *= (1 - discountPercentage / 100);
                    }
                } else if (discountAmount > 0) {
                    if (discountAmount > subtotal) {
                        showToast('error', 'A kedvezmény összege nem lehet nagyobb az részösszegnél!');
                        $('#discountAmount').val('').addClass('is-invalid');
                        total = subtotal;
                    } else {
                        total -= discountAmount;
                    }
                }

                total = Math.max(0, total);
                $('#totalAmount').val(total.toFixed(2).replace('.', ','));
                if (total === 0 && (subtotal > 0 || discountAmount > 0 || discountPercentage > 0)) {
                    $('#totalAmount').addClass('is-invalid');
                    showToast('warning', 'A teljes összeg nem lehet negatív, 0-ra lett állítva.');
                } else {
                    $('#totalAmount').removeClass('is-invalid');
                }
                return total;
            }

            let itemsData = [];

            $('#newQuoteButton').on('click', function () {
                log('[Quote] New Quote button clicked');
                const $modal = $('#newQuoteModal');
                $modal.modal('show');
                $modal.on('shown.bs.modal', function () {
                    initializeSelect2('#partnerId', 'partner', '#newQuoteModal');
                    initializeSelect2('#currencyId', 'currency', '#newQuoteModal');
                    initializeSelect2('#newProductId', 'product', '#newQuoteModal');
                    $('#quoteDate').val(getTodayDate());
                    $('#quoteItemsTable tbody').empty();
                    itemsData = [];
                    $('#details-tab').tab('show');
                });
            });

            $('#newQuoteModal').on('hidden.bs.modal', function () {
                log('[Modal] New Quote Modal hidden');
                const $form = $('#quoteForm');
                $form[0].reset();
                $form.find('select').val(null).trigger('change');
                $('#quoteItemsTable tbody').empty();
                $('.item-form').hide();
                itemsData = [];
            });

            $(document).on('click', '.toggle-item-form', function () {
                log('[Item] Toggle item form');
                const $itemForm = $('.item-form');
                $itemForm.toggleClass('active').slideToggle();
                if ($itemForm.hasClass('active')) {
                    initializeSelect2('#newProductId', 'product', '#newQuoteModal');
                    $itemForm.find('#newQuantity').val(1);
                    $itemForm.find('#newUnitPrice').val('0.00');
                    $itemForm.find('#newDiscountPercentage').val('0');
                    $itemForm.find('#newDiscountAmount').val('0');
                    $itemForm.find('#newTotalPrice').val('0.00');
                    $itemForm.find('#newItemDescription').val('');
                    $itemForm.find('#newProductId').val(null).trigger('change');
                }
            });

            $(document).on('click', '.add-item', function () {
                log('[Item] Add item clicked');
                const $itemForm = $('.item-form');
                const productData = $itemForm.find('#newProductId').select2('data')[0];
                const productId = productData ? parseInt(productData.id) : 0;
                const productText = productData ? productData.text : '';
                const description = $itemForm.find('#newItemDescription').val().trim();
                const quantity = parseFloat($itemForm.find('#newQuantity').val()) || 0;
                const unitPrice = parseFloat($itemForm.find('#newUnitPrice').val()) || 0;
                const discountPercentage = parseFloat($itemForm.find('#newDiscountPercentage').val()) || 0;
                const discountAmount = parseFloat($itemForm.find('#newDiscountAmount').val()) || 0;

                if (!productId || quantity < 1 || unitPrice <= 0) {
                    showToast('error', 'Kérjük, töltse ki az összes kötelező tételmezőt!');
                    return;
                }

                let itemTotal = quantity * unitPrice;
                let discountText = '0,00';
                if (discountPercentage > 0) {
                    itemTotal *= (1 - discountPercentage / 100);
                    discountText = `${discountPercentage.toFixed(2)}%`;
                } else if (discountAmount > 0) {
                    itemTotal -= discountAmount;
                    discountText = `${discountAmount.toFixed(2)}`;
                }

                const item = {
                    productId: productId,
                    productText: productText,
                    itemDescription: description,
                    quantity: quantity,
                    unitPrice: unitPrice,
                    discountPercentage: discountPercentage > 0 ? discountPercentage : null,
                    discountAmount: discountAmount > 0 ? discountAmount : null,
                    totalPrice: itemTotal
                };

                itemsData.push(item);
                const $tbody = $('#quoteItemsTable tbody');
                $tbody.append(`
                    <tr id="item_${itemsData.length - 1}">
                        <td class="drag-handle"><i class="bi bi-grip-vertical"></i></td>
                        <td>${productText}</td>
                        <td>${description || ''}</td>
                        <td>${quantity}</td>
                        <td>${unitPrice.toFixed(2)}</td>
                        <td>${discountText}</td>
                        <td>${itemTotal.toFixed(2)}</td>
                        <td><button class="btn btn-sm btn-danger delete-item" data-row-id="item_${itemsData.length - 1}"><i class="bi bi-trash me-2"></i></button></td>
                    </tr>
                `);

                updateTotalAmount();
                $itemForm.removeClass('active').slideUp();
                $itemForm.find('input, select').val('');
                $itemForm.find('#newQuantity').val(1);
                $itemForm.find('#newDiscountPercentage').val('0');
                $itemForm.find('#newDiscountAmount').val('0');
            });

            $(document).on('input', '#newQuantity, #newUnitPrice, #newItemDiscount, #newItemDiscountType', () => calculateTotalPrice('new'));

            $(document).on('click', '.edit-quote-item', function () {
                const $button = $(this);
                // Explicitly read data attributes to avoid jQuery .data() caching issues
                const quoteId = $(this).attr('data-quote-id');
                const quoteItemId = $button.attr('data-item-id');
                const productId = $button.attr('data-product-id');
                const productName = $button.attr('data-product-name');
                const quantity = $button.attr('data-quantity');
                const unitPrice = $button.attr('data-unit-price');
                const discount = $button.attr('data-discount');
                const discountType = $button.attr('data-discount-type');
                const description = $button.attr('data-description');
                const totalPrice = $button.attr('data-total-price');

                log('[EditQuoteItem] Button data attributes:', {
                    quoteId, quoteItemId, productId, productName, quantity, unitPrice, discount, discountType, description, totalPrice
                });

                if (!quoteId || isNaN(parseInt(quoteId))) {
                    log('[EditQuoteItem] ERROR: quoteId is missing or invalid:', quoteId);
                    showToast('error', 'Hiba: Az árajánlat azonosító hiányzik vagy érvénytelen. Kérjük, frissítse az oldalt és próbálja újra.');
                    return;
                }

                $('#editQuoteId').val(quoteId);
                $('#editQuoteItemId').val(quoteItemId || '');
                $('#editProductId').val(productId || '');
                $('#editProductName').val(productName || 'N/A');
                $('#editQuantity').val(quantity && !isNaN(parseInt(quantity)) ? parseInt(quantity) : 1);
                $('#editUnitPrice').val(unitPrice && !isNaN(parseFloat(unitPrice)) ? parseFloat(unitPrice).toFixed(2) : '0.00');
                $('#editItemDiscount').val(discount && !isNaN(parseFloat(discount)) ? parseFloat(discount).toFixed(2) : '0.00');
                $('#editItemDiscountType').val(discountType || 'percentage');
                $('#editItemDescription').val(description || '');
                $('#editTotalPrice').val(totalPrice && !isNaN(parseFloat(totalPrice)) ? totalPrice.replace('.', ',') : '0,00');
                $('#editQuoteItemModalLabel').text(`Tétel szerkesztése: ${productName || 'N/A'}`);

                log('[EditQuoteItem] Populated modal form:', {
                    quoteId: $('#editQuoteId').val(),
                    quoteItemId: $('#editQuoteItemId').val(),
                    productId: $('#editProductId').val(),
                    productName: $('#editProductName').val(),
                    quantity: $('#editQuantity').val(),
                    unitPrice: $('#editUnitPrice').val(),
                    discount: $('#editItemDiscount').val(),
                    discountType: $('#editItemDiscountType').val(),
                    description: $('#editItemDescription').val(),
                    totalPrice: $('#editTotalPrice').val()
                });

                calculateTotalPrice('edit');
                $('#editQuoteItemModal').modal('show');
            });

            $(document).on('input', '#editQuantity, #editUnitPrice, #editItemDiscount, #editItemDiscountType', () => calculateTotalPrice('edit'));

            $(document).on('click', '.save-quote-item', function () {
                const $button = $(this);
                const $form = $('#editQuoteItemForm'); // Explicitly target the editQuoteItemForm
                const quoteIdInput = $form.find('#editQuoteId'); // Explicitly target the quoteId input
                const quoteId = $('#editQuoteId').val();
                const quoteItemId = $form.find('#editQuoteItemId').val() || 0;
                const productId = $form.find('#editProductId').val() || $form.find('select[name="ProductId"]').val();
                const quantity = parseFloat($form.find('#editQuantity').val()) || 0;
                const unitPrice = parseFloat($form.find('#editUnitPrice').val()) || 0;
                const discount = parseFloat($form.find('#editItemDiscount').val()) || 0;
                const discountType = $form.find('#editItemDiscountType').val();
                const description = $form.find('#editItemDescription').val().trim();

                log('[SaveQuoteItem] Form DOM context:', {
                    formId: $form.attr('id'),
                    quoteIdInputExists: quoteIdInput.length > 0,
                    quoteIdInputValue: quoteIdInput.val()
                });

                log('[SaveQuoteItem] Form data:', {
                    quoteId, quoteItemId, productId, quantity, unitPrice, discount, discountType, description
                });

                if (!$form[0].checkValidity() || !quoteId || !productId || quantity < 1 || unitPrice <= 0) {
                    $form.addClass('was-validated');
                    showToast('error', 'Kérjük, töltse ki az összes kötelező mezőt (Árajánlat ID, Termék, Mennyiség, Egységár)!');
                    log('[SaveQuoteItem] Validation failed:', { quoteId, productId, quantity, unitPrice });
                    return;
                }

                const payload = {
                    productId: parseInt(productId),
                    quantity: parseInt(quantity),
                    unitPrice: parseFloat(unitPrice.toFixed(2)),
                    itemDescription: description,
                    discountPercentage: discountType === 'percentage' ? parseFloat(discount.toFixed(2)) : null,
                    discountAmount: discountType === 'amount' ? parseFloat(discount.toFixed(2)) : null
                };

                log('[SaveQuoteItem] Sending payload:', payload);

                const url = quoteItemId ? `/api/Quotes/${quoteId}/items/${quoteItemId}` : `/api/Quotes/${quoteId}/items`;
                const method = quoteItemId ? 'PUT' : 'POST';

                $.ajax({
                    url: url,
                    method: method,
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() },
                    beforeSend: function () {
                        $button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status"></span> Mentés...');
                        log('[SaveQuoteItem] Sending AJAX request to:', url);
                    },
                    success: function (response) {
                        log('[SaveQuoteItem] Response:', response);
                        showToast('success', 'Tétel sikeresen mentve!');
                        $form.closest('.modal').modal('hide');
                        setTimeout(() => location.reload(), 500);
                    },
                    error: function (xhr) {
                        const errorMessage = xhr.responseJSON?.error || 'Hiba történt a mentés során.';
                        showToast('error', errorMessage);
                        log('[SaveQuoteItem] AJAX error:', xhr.status, xhr.responseText);
                    },
                    complete: function () {
                        $button.prop('disabled', false).html('Tétel mentése');
                    }
                });
            });

            $(document).on('click', '.confirm-delete-quote', function () {
                const quoteId = $(this).data('quote-id'); // Get the quote ID from the button

                $.ajax({
                    url: `/api/Quotes/${quoteId}`, // Use the correct API endpoint
                    method: 'DELETE', // Use DELETE as the method
                    success: function (response) {
                        // Show a success notification
                        showToast('success', 'Árajánlat sikeresen törölve!');

                        // Hide the modal
                        $(`#deleteQuoteModal_${quoteId}`).modal('hide');

                        // Remove the deleted quote from the UI
                        $(`.partner-card[data-quote-id="${quoteId}"]`).remove();
                    },
                    error: function (xhr) {
                        // Show error notification
                        console.error('Error deleting quote:', xhr.responseText);
                        showToast('error', 'Hiba történt a törlés során.');
                    }
                });
            });
        });
    </script>

    <script>
        // Ajánlat másolása. csak külön script-ben működik, ezért kell ide is a showtoast.
            function showToast(type, message) {
                // Create the toast element
                const toast = $(`
                    <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">${message}</div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                `);

                // Append toast to the container
                $('#toastContainer').append(toast);

                // Initialize and show the toast
                const bsToast = new bootstrap.Toast(toast[0]);
                bsToast.show();

                // Remove the toast after 5 seconds
                setTimeout(() => toast.remove(), 5500); // Includes 500ms fade-out
            }

            async function copyQuote(quoteId) {
                try {
                    const response = await fetch(`/api/Quotes/${quoteId}/copy`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        }
                    });

                    const result = await response.json();
                    if (response.ok && result) {
                        showToast('success', `Árajánlat sikeresen másolva! Új szám: ${result.quoteNumber}`);
                        
                        // Delay the reload to let the toast be visible
                        setTimeout(() => location.reload(), 3000); // Reload after 3 seconds
                    } else {
                        showToast('error', result.error || 'Másolás sikertelen.');
                    }
                } catch (error) {
                    showToast('error', 'Hiba történt a másolás során.');
                    console.error('[Error] Copy quote error:', error);
                }
            }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.copy-quote-btn').forEach(button => {
                button.addEventListener('click', function (e) {
                    e.preventDefault();
                    const quoteId = this.getAttribute('data-quote-id');
                    copyQuote(quoteId);
                });
            });
        });
    </script>

}

<style>

.drag-handle {
    cursor: move;
    width: 30px;
    text-align: center;
    vertical-align: middle;
}

.drag-handle .bi-grip-vertical {
    font-size: 1.2rem;
    color: #6c757d;
}

#quoteItemsTable tbody tr:hover .drag-handle .bi-grip-vertical {
    color: #007bff;
}

#quoteItemsTable .placeholder {
    background-color: #f8f9fa;
    border: 2px dashed #007bff;
    height: 50px;
}



[data-theme="dark"] .partner-card {
        background-color: #2a2a2a;
        border: 1px solid #444;
    }


/* Badge styling */
.badge-draft { background-color: #6c757d; }
.badge-sent { background-color: #007bff; }
.badge-accepted { background-color: #28a745; }
.badge-rejected { background-color: #dc3545; }

    /* Ensure textarea in Leírás column is wider and readable */
    #quoteItemsTable .itemDescription {
        width: 100%;
        min-width: 200px;
        height: 60px;
        resize: vertical;
    }
    /* Adjust table column widths */
    #quoteItemsTable th:nth-child(2), #quoteItemsTable td:nth-child(2) {
        width: 30%;
    }

        /* Card-based layout matching Leads page */
        .card-grid-header {
            padding: 0 15px 2px 15px;
            margin-top: 0px;
            background-color: #F1EFEC;
            border-bottom: 1px solid #dee2e6;
        }

        .card-grid-row {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
        }

        .card-grid-column {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .card-grid-cell {
            padding: 0 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Column widths */
        .quote-number-col { flex: 1 1 15%; min-width: 120px; }
        .quote-partner-col { flex: 1 1 25%; min-width: 150px; }
        .quote-date-col { flex: 1 1 15%; min-width: 100px; }
        .quote-status-col { flex: 1 1 15%; min-width: 100px; }
        .quote-amount-col { flex: 1 1 15%; min-width: 120px; }
        .actions-column, .actions-cell { flex: 0 0 auto; width: auto; text-align: right; padding-right: 10px; }

        /* Button group styling */
        .btn-group-sm .btn {
            padding: 0.2rem 0.5rem;
            font-size: 0.875rem;
        }

        /* Badge styling */
        .badge-draft { background-color: #6c757d; }
        .badge-sent { background-color: #007bff; }
        .badge-accepted { background-color: #28a745; }
        .badge-rejected { background-color: #dc3545; }

        /* Ensure pagination is centered */
        .fixed-footer .pagination {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-bottom: 0;
        }

        .fixed-footer nav {
            flex-grow: 1;
            text-align: center;
        }

        /* Modal Sizing */
        .modal-lg { max-width: 1000px !important; }

        /* Consistent Tab Content Styling */
        #newQuoteModal .tab-content,
        #newQuoteItemModal .tab-content,
        [id^="editQuoteModal_"] .tab-content,
        [id^="newQuoteItemModal_"] .tab-content,
        [id^="viewQuoteModal_"] .tab-content {
            min-width: 0;
            width: 100%;
            min-height: 450px;
            max-height: 65vh;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 1rem;
            background-color: #fff;
        }

        /* Consistent Tab Pane Styling */
        #newQuoteModal .tab-pane,
        #newQuoteItemModal .tab-pane,
        [id^="editQuoteModal_"] .tab-pane,
        [id^="newQuoteItemModal_"] .tab-pane,
        [id^="viewQuoteModal_"] .tab-pane {
            width: 100%;
        }

        /* Adjust Modal Body Padding */
        #newQuoteModal .modal-body,
        #newQuoteItemModal .modal-body,
        [id^="editQuoteModal_"] .modal-body,
        [id^="newQuoteItemModal_"] .modal-body,
        [id^="viewQuoteModal_"] .modal-body {
            padding: 1rem 1rem 0 1rem;
        }

        /* Remove margin below tabs */
        #newQuoteModal .nav-tabs,
        [id^="editQuoteModal_"] .nav-tabs,
        [id^="viewQuoteModal_"] .nav-tabs {
            margin-bottom: 0 !important;
        }

        /* General Table Cell Styling */
        .table tbody tr td {
            vertical-align: middle;
        }

        /* View Modal Specific Content Styling */
        [id^="viewQuoteModal_"] .table {
            margin-bottom: 0;
        }

        [id^="viewQuoteModal_"] .tab-pane > p {
            padding: 1.5rem;
            text-align: center;
            color: #6c757d;
        }

        /* Select2 styling */
.select2-container {
            width: 100% !important;
        }

        .select2-container--bootstrap-5 .select2-selection--single {
            height: 38px;
            padding: 0.375rem 2.25rem 0.375rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            background-color: #fff;
        }

        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
            line-height: 1.5;
            padding-top: 0;
            padding-bottom: 0;
            color: #495057;
        }

        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__arrow {
            height: 38px;
            right: 0.75rem;
        }

        .select2-container--bootstrap-5 .select2-dropdown {
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
        }

        .select2-container-wrapper {
            position: relative;
        }

        [data-theme="dark"] .select2-container--bootstrap-5 .select2-selection--single {
            background-color: #3a3a3a;
            border-color: #666;
            color: #e0e0e0;
        }

        [data-theme="dark"] .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
            color: #e0e0e0;
        }

        [data-theme="dark"] .select2-container--bootstrap-5 .select2-dropdown {
            background-color: #2a2a2a;
            border-color: #666;
            color: #e0e0e0;
        }

        [data-theme="dark"] .select2-container--bootstrap-5 .select2-results__option {
            color: #e0e0e0;
        }

        [data-theme="dark"] .select2-container--bootstrap-5 .select2-results__option--highlighted {
            background-color: #357abd;
            color: #ffffff;
        }

        /* Dark mode overrides */
        [data-theme="dark"] .card-grid-header {
            background-color: #2a2a2a;
            border-bottom: 1px solid #444;
        }

        [data-theme="dark"] .card-grid-column {
            color: #b0b0b0;
        }

        [data-theme="dark"] .quote-card {
            background-color: #2a2a2a;
            border: 1px solid #444;
        }

        [data-theme="dark"] .fixed-footer {
            background-color: #2a2a2a;
            border-top: 1px solid #444;
        }

        [data-theme="dark"] .alert-success {
            background-color: #2e7d32;
            border-color: #1b5e20;
            color: #e0e0e0;
        }

        [data-theme="dark"] .alert-danger {
            background-color: #d32f2f;
            border-color: #b71c1c;
            color: #e0e0e0;
        }

        [data-theme="dark"] #newQuoteModal .tab-content,
        [data-theme="dark"] #newQuoteItemModal .tab-content,
        [data-theme="dark"] [id^="editQuoteModal_"] .tab-content,
        [data-theme="dark"] [id^="newQuoteItemModal_"] .tab-content,
        [data-theme="dark"] [id^="viewQuoteModal_"] .tab-content,
        [data-theme="dark"] [id^="deleteQuoteModal_"] .tab-content {
            background-color: #2a2a2a !important;
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] #newQuoteModal .tab-pane,
        [data-theme="dark"] #newQuoteItemModal .tab-pane,
        [data-theme="dark"] [id^="editQuoteModal_"] .tab-pane,
        [data-theme="dark"] [id^="newQuoteItemModal_"] .tab-pane,
        [data-theme="dark"] [id^="viewQuoteModal_"] .tab-pane,
        [data-theme="dark"] [id^="deleteQuoteModal_"] .tab-pane {
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] #newQuoteModal .modal-body,
        [data-theme="dark"] #newQuoteItemModal .modal-body,
        [data-theme="dark"] [id^="editQuoteModal_"] .modal-body,
        [data-theme="dark"] [id^="newQuoteItemModal_"] .modal-body,
        [data-theme="dark"] [id^="viewQuoteModal_"] .modal-body,
        [data-theme="dark"] [id^="deleteQuoteModal_"] .modal-body {
            background-color: #2a2a2a !important;
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] .form-control {
            background-color: #333333 !important;
            border-color: #666 !important;
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] .form-control:focus {
            background-color: #333333 !important;
            border-color: #888 !important;
            color: #e0e0e0 !important;
            box-shadow: 0 0 0 0.2rem rgba(100, 100, 100, 0.25) !important;
        }

        [data-theme="dark"] .form-control::placeholder {
            color: #aaaaaa !important;
        }

        [data-theme="dark"] .form-label {
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] .modal-title {
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] #newQuoteModal .nav-tabs,
        [data-theme="dark"] [id^="editQuoteModal_"] .nav-tabs,
        [data-theme="dark"] [id^="viewQuoteModal_"] .nav-tabs {
            background-color: #2a2a2a !important;
            border-bottom: 1px solid #444 !important;
        }

        [data-theme="dark"] #newQuoteModal .nav-tabs .nav-link,
        [data-theme="dark"] [id^="editQuoteModal_"] .nav-tabs .nav-link,
        [data-theme="dark"] [id^="viewQuoteModal_"] .nav-tabs .nav-link {
            color: #b0b0b0 !important;
        }

        [data-theme="dark"] #newQuoteModal .nav-tabs .nav-link:hover,
        [data-theme="dark"] [id^="editQuoteModal_"] .nav-tabs .nav-link:hover,
        [data-theme="dark"] [id^="viewQuoteModal_"] .nav-tabs .nav-link:hover {
            color: #e0e0e0 !important;
            background-color: #3a3a3a !important;
        }

        [data-theme="dark"] #newQuoteModal .nav-tabs .nav-link.active,
        [data-theme="dark"] [id^="editQuoteModal_"] .nav-tabs .nav-link.active,
        [data-theme="dark"] [id^="viewQuoteModal_"] .nav-tabs .nav-link.active {
            color: #e0e0e0 !important;
            background-color: #3a3a3a !important;
            border-color: #444 #444 #2a2a2a !important;
        }

        [data-theme="dark"] [id^="viewQuoteModal_"] .tab-pane > p {
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] [id^="viewQuoteModal_"] .table {
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] [id^="viewQuoteModal_"] .table th,
        [data-theme="dark"] [id^="viewQuoteModal_"] .table td {
            border-color: #444 !important;
            color: #e0e0e0 !important;
        }
    </style>
