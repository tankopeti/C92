
@page
@using Microsoft.AspNetCore.Mvc.Rendering
@using Cloud9_2.Models
@using System.Globalization
@model Cloud9_2.Pages.CRM.Quotes.IndexModel

@{
    Layout = "_Layout";
}

@await Html.PartialAsync("_CRMSidebar")

<div class="right-content">
    <div class="page-header-fixed-top">
        <!-- Breadcrumb Navigation -->
        <div class="d-flex justify-content-between align-items-center mb-2">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-body-tertiary rounded-3 p-2 mb-0">
                    <li class="breadcrumb-item"><a href="../../">Főoldal</a></li>
                    <li class="breadcrumb-item"><a href="../">CRM Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Quotes</li>
                    <li class="breadcrumb-item active" aria-current="page">@Model.Quotes.Count of @Model.TotalRecords quote@(Model.TotalRecords != 1 ? "s" : "") (Page @Model.CurrentPage of @Model.TotalPages)</li>
                </ol>
            </nav>
        </div>

        <!-- Header with Buttons and Search -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center gap-2">
                <button type="button" id="newQuoteButton" class="btn-new" data-bs-toggle="modal" data-bs-target="#newQuoteModal" aria-label="Új árajánlat létrehozása">
                    <i class="bi bi-plus-circle me-1"></i>Új árajánlat
                </button>
            </div>
            <div class="d-flex align-items-center gap-2">
                <form method="get" asp-page="./Index" class="input-group input-group-sm" style="width: 250px;">
                    <input type="text" class="form-control" placeholder="Keresés..." id="searchInput" name="SearchTerm" value="@Model.SearchTerm" autocomplete="off" aria-label="Keresés árajánlatok között">
                    <input type="hidden" name="pageSize" value="@Model.PageSize" />
                    <button class="btn btn-outline-secondary" type="submit" aria-label="Keresés indítása">
                        <i class="bi bi-search"></i>
                    </button>
                </form>
        <!-- Filter/Sort Dropdown -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Rendezési és szűrési opciók">
                        <i class="bi bi-funnel me-1"></i>Rendezés/Szűrés
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" data-filter="all" data-sort="QuoteDate">Összes árajánlat (Legújabb elöl)</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="all" data-sort="QuoteId">Rendezés: Árajánlat ID (Csökkenő)</a></li>
                        <li><a class="dropdown-item" href="#" data-filter="all" data-sort="ValidityDate">Érvényességi dátum</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Card Grid Header -->
        <div class="card-grid-header">
            <div class="card-grid-row">
                <div class="card-grid-column quote-number-col">Ajánlat szám</div>
                <div class="card-grid-column quote-partner-col">Partner</div>
                <div class="card-grid-column quote-date-col">Dátum</div>
                <div class="card-grid-column quote-status-col">Státusz</div>
                <div class="card-grid-column quote-amount-col">Ajánlat összege</div>
                <div class="card-grid-column actions-column">Műveletek</div>
            </div>
        </div>
    </div>

    <!-- Card Grid Body -->
    <div class="scrollable-card-container">
        <div class="card-grid-body">
            @if (Model.Quotes.Any())
            {
                @foreach (var quote in Model.Quotes)
                {
                    <div class="card partner-card mb-3" data-quote-id="@quote.QuoteId">
                        <div class="card-body p-2">
                            <div class="card-grid-row align-items-center">
                                <div class="card-grid-cell quote-number-col">
                                    <div class="quote-info">
                                        <div class="fw-bold">@quote.QuoteNumber</div>
                                    </div>
                                </div>
                                <div class="card-grid-cell quote-partner-col">
                                    <div class="quote-partner text-muted small">
                                        <i class="bi bi-person me-1"></i>@quote.Partner.Name
                                    </div>
                                </div>
                                <div class="card-grid-cell quote-date-col">
                                    <div class="quote-date text-muted small">
                                        <i class="bi bi-calendar me-1"></i>@quote.QuoteDate?.ToString("yyyy-MM-dd")
                                    </div>
                                </div>
                                <div class="card-grid-cell quote-status-col">
                                    @{
                                        var badgeClass = "badge bg-secondary";
                                        if (quote.Status == "Tervezet") badgeClass = "badge badge-draft";
                                        else if (quote.Status == "Elküldve") badgeClass = "badge badge-sent";
                                        else if (quote.Status == "Elfogadva") badgeClass = "badge badge-accepted";
                                        else if (quote.Status == "Elutasítva") badgeClass = "badge badge-rejected";
                                    }
                                    <span class="@badgeClass">@quote.Status</span>
                                </div>
                                <div class="card-grid-cell quote-amount-col">
                                    <div class="quote-amount text-muted small">
                                        <i class="bi bi-currency-dollar me-1"></i>@quote.TotalAmount?.ToString("C")
                                    </div>
                                </div>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-info btn-sm view-quote-btn"
                                            data-bs-toggle="modal"
                                            data-bs-target="#viewQuoteModal_@quote.QuoteId"
                                            aria-label="Árajánlat részleteinek megtekintése">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <div class="dropdown">
                                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button"
                                                id="actionsDropdown_@quote.QuoteId"
                                                data-bs-toggle="dropdown" 
                                                aria-expanded="false"
                                                aria-label="További műveletek">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="actionsDropdown_@quote.QuoteId">
                                            <li>
                                            <a 
                                                class="dropdown-item" 
                                                href="#" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editQuoteModal_@quote.QuoteId">
                                                <i class="bi bi-pencil-square me-2"></i>Szerkesztés
                                            </a>
                                            </li>
                                            <li><a class="dropdown-item" href="#" onclick="copyQuote(@quote.QuoteId)"><i class="bi bi-copy me-2"></i>Másolás</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deleteQuoteModal_@quote.QuoteId"><i class="bi bi-trash me-2"></i>Törlés</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- edit modal -->
                    <div class="modal fade" id="editQuoteModal_@quote.QuoteId" tabindex="-1" aria-labelledby="editQuoteModalLabel_@quote.QuoteId" aria-hidden="true">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="editQuoteModalLabel_@quote.QuoteId">Árajánlat szerkesztése: @quote.QuoteNumber</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <!-- Tabs -->
                                    <ul class="nav nav-tabs" id="quoteTabs_@quote.QuoteId" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="base-info-tab_@quote.QuoteId" data-bs-toggle="tab" data-bs-target="#base-info_@quote.QuoteId" type="button" role="tab" aria-controls="base-info_@quote.QuoteId" aria-selected="true">Alapadatok</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="items-tab_@quote.QuoteId" data-bs-toggle="tab" data-bs-target="#items_@quote.QuoteId" type="button" role="tab" aria-controls="items_@quote.QuoteId" aria-selected="false">Tételek</button>
                                        </li>
                                    </ul>

                                    <!-- Tab Content -->
                                    <div class="tab-content" id="quoteTabContent_@quote.QuoteId">
                                        <!-- Base Info Tab -->
                                        <div class="tab-pane fade show active" id="base-info_@quote.QuoteId" role="tabpanel" aria-labelledby="base-info-tab_@quote.QuoteId">
                                            <form id="quoteBaseInfoForm_@quote.QuoteId">
                                                <table class="table table-sm mt-3">
                                                    <tbody>
                                                        <tr>
                                                            <th>Árajánlat száma</th>
                                                            <td><input type="text" class="form-control" name="quoteNumber" value="@quote.QuoteNumber" readonly></td>
                                                        </tr>
                                                        <tr>
                                                            <th>Dátum</th>
                                                            <td><input type="date" class="form-control" name="quoteDate" value="@quote.QuoteDate?.ToString("yyyy-MM-dd")" required></td>
                                                        </tr>
                                                        <tr>
                                                            <th>Partner</th>
                                                            <td>
                                                                <select name="partnerId" class="form-select tom-select" data-selected-id="@quote.PartnerId" data-selected-text="@(quote.Partner?.CompanyName ?? "Unknown")" autocomplete="off" required>
                                                                    <option value=""></option>
                                                                </select>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <th>Értékesítő</th>
                                                            <td><input type="text" class="form-control" name="salesPerson" value="@(quote.SalesPerson ?? "")"></td>
                                                        </tr>
                                                        <tr>
                                                            <th>Érvényességi dátum</th>
                                                            <td><input type="date" class="form-control" name="validityDate" value="@(quote.ValidityDate?.ToString("yyyy-MM-dd") ?? "")"></td>
                                                        </tr>
                                                        <tr>
                                                            <th>Tárgy</th>
                                                            <td><input type="text" class="form-control" name="subject" value="@(quote.Subject ?? "")" required></td>
                                                        </tr>
                                                        <tr>
                                                            <th>Leírás</th>
                                                            <td><textarea class="form-control" name="description" >@(quote.Description ?? "")</textarea></td>
                                                        </tr>
                                                        <tr>
                                                            <th>Részletes leírás</th>
                                                            <td><textarea class="form-control" name="detailedDescription" >@(quote.DetailedDescription ?? "")</textarea></td>
                                                        </tr>
                                                        <tr>
                                                            <th>Státusz</th>
                                                            <td>
                                                                @{
                                                                    var statusDisplay = new Dictionary<string, string>
                                                                    {
                                                                        { "InProgress", "Folyamatban" },
                                                                        { "Accepted", "Elfogadva" },
                                                                        { "Rejected", "Elutasítva" },
                                                                        { "Draft", "Piszkozat" }
                                                                        // Add more based on QuoteStatus enum
                                                                    };
                                                                }
                                                                <select class="form-select" name="status" required>
                                                                    @foreach (var status in Enum.GetValues(typeof(Cloud9_2.Pages.CRM.Quotes.QuoteStatus)))
                                                                    {
                                                                        var displayText = statusDisplay.ContainsKey(status.ToString()) ? statusDisplay[status.ToString()] : status.ToString();
                                                                        <option value="@status" selected="@(quote.Status == status.ToString())">@displayText</option>
                                                                    }
                                                                </select>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </form>
                                        </div>

                                        <!-- Items Tab -->
                                        <div class="tab-pane fade" id="items_@quote.QuoteId" role="tabpanel" aria-labelledby="items-tab_@quote.QuoteId">
                                            <button type="button" class="btn btn-primary mb-3 add-item-row" data-quote-id="@quote.QuoteId">Tétel hozzáadása</button>
                                            <form id="quoteItemsForm_@quote.QuoteId" data-quote-id="@quote.QuoteId">
                                                <table class="table table-sm table-bordered">
                                                    <thead>
                                                        <tr>
                                                            <th style="width: 30%;">Termék</th>
                                                            <th style="width: 15%;">Mennyiség</th>
                                                            <th style="width: 15%;">Egységár</th>
                                                            <th style="width: 20%;">Kedvezmény</th>
                                                            <th style="width: 15%;">Összesen</th>
                                                            <th style="width: 5%;"></th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="items-tbody_@quote.QuoteId">
                                                        @foreach (var item in quote.QuoteItems)
                                                        {
                                                            <script>console.log('Server-side item ID:', '@item.QuoteItemId', 'ProductId:', '@item.ProductId');</script>
                                                            <tr class="quote-item-row" data-item-id="@item.QuoteItemId">
                                                                <td>
                                                                    <select name="quoteItems[@item.QuoteItemId].ProductId" class="form-select tom-select-product" data-selected-id="@item.ProductId" data-selected-text="@(item.Product.Name ?? "Unknown")" autocomplete="off" required>
                                                                        <option value="" disabled selected>-- Válasszon terméket --</option>
                                                                    </select>
                                                                </td>
                                                                <td>
                                                                    <input type="number" name="quoteItems[@item.QuoteItemId].Quantity" class="form-control form-control-sm quantity" value="@item.Quantity.ToString(CultureInfo.InvariantCulture)" min="0" step="1" required>
                                                                </td>
                                                                <td>
                                                                    <input type="number" name="quoteItems[@item.QuoteItemId].UnitPrice" class="form-control form-control-sm unit-price" value="@item.UnitPrice.ToString(CultureInfo.InvariantCulture)" min="0" step="0.01" required>
                                                                </td>
                                                                <td>
                                                                    <div class="input-group input-group-sm">
                                                                        <input type="text" name="@(item.DiscountPercentage != null ? "quoteItems[" + item.QuoteItemId + "].DiscountPercentage" : "quoteItems[" + item.QuoteItemId + "].DiscountAmount")" class="form-control discount-value" value="@(item.DiscountPercentage != null ? item.DiscountPercentage : item.DiscountAmount)" placeholder="pl. 10">
                                                                        <select class="form-select discount-type" data-discount-name-prefix="quoteItems[@item.QuoteItemId]">
                                                                            @if (item.DiscountPercentage != null)
                                                                            {
                                                                                <option value="Percentage" selected>%</option>
                                                                                <option value="Amount">Összeg</option>
                                                                            }
                                                                            else
                                                                            {
                                                                                <option value="Percentage">%</option>
                                                                                <option value="Amount" selected>Összeg</option>
                                                                            }
                                                                        </select>
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <span class="total-price">@item.TotalPrice.ToString("F2")</span>
                                                                    <input type="hidden" name="quoteItems[@item.QuoteItemId].ItemDescription" class="item-description" value="@(item.ItemDescription ?? "")">
                                                                </td>
                                                                <td>
                                                                    <button type="button" class="btn btn-outline-secondary btn-sm edit-description" data-item-id="@item.QuoteItemId"><i class="bi bi-pencil"></i></button>
                                                                    <button type="button" class="btn btn-danger btn-sm remove-item-row"><i class="bi bi-trash"></i></button>
                                                                </td>
                                                            </tr>
                                                            <tr class="description-row" data-item-id="@item.QuoteItemId" style="display: none;">
                                                                <td colspan="6">
                                                                    <div class="mb-2">
                                                                        <label class="form-label">Leírás (max 200 karakter)</label>
                                                                        <textarea name="quoteItems[@item.QuoteItemId].ItemDescriptionInput" class="form-control form-control-sm item-description-input" maxlength="200" rows="2">@(item.ItemDescription ?? "")</textarea>
                                                                        <div class="form-text">Karakterek: <span class="char-count">@((item.ItemDescription?.Length ?? 0))</span>/200</div>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        }
                                                        <!-- Quote Total Row -->
                                                        <tr class="quote-total-row">
                                                            <td colspan="3"></td>
                                                            <td>
                                                                <strong>Összesen:</strong>
                                                            </td>
                                                            <td>
                                                                <span class="quote-total-amount">0.00</span>
                                                            </td>
                                                            <td></td>
                                                        </tr>
                                                        <tr class="quote-discount-row">
                                                            <td colspan="3"></td>
                                                            <td>
                                                                <div class="input-group input-group-sm">
                                                                    <input type="text" name="@(quote.DiscountPercentage != null ? "DiscountPercentage" : "DiscountAmount")" class="form-control quote-discount-value" value="@(quote.DiscountPercentage != null ? quote.DiscountPercentage : quote.DiscountAmount)" placeholder="pl. 10">
                                                                    <select class="form-select quote-discount-type" data-discount-name-prefix="">
                                                                        @if (quote.DiscountPercentage != null)
                                                                        {
                                                                            <option value="Percentage" selected>%</option>
                                                                            <option value="Amount">Összeg</option>
                                                                        }
                                                                        else
                                                                        {
                                                                            <option value="Percentage">%</option>
                                                                            <option value="Amount" selected>Összeg</option>
                                                                        }
                                                                    </select>
                                                                </div>

                                                                <strong>Kedvezményes ár:</strong>
                                                            </td>
                                                            <td>
                                                                <span class="quote-final-total">0.00</span>
                                                            </td>
                                                            <td></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bezár</button>
                                    <button type="button" class="btn btn-primary save-quote" data-quote-id="@quote.QuoteId">Mentés</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- New Quote Modal -->
            <div class="modal fade" id="newQuoteModal" tabindex="-1" aria-labelledby="newQuoteModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="newQuoteModalLabel">Új árajánlat létrehozása</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Tabs -->
                            <ul class="nav nav-tabs" id="quoteTabs_new" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="base-info-tab_new" data-bs-toggle="tab" data-bs-target="#base-info_new" type="button" role="tab" aria-controls="base-info_new" aria-selected="true">Alapadatok</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="items-tab_new" data-bs-toggle="tab" data-bs-target="#items_new" type="button" role="tab" aria-controls="items_new" aria-selected="false">Tételek</button>
                                </li>
                            </ul>

                            <!-- Tab Content -->
                            <div class="tab-content" id="quoteTabContent_new">
                                <!-- Base Info Tab -->
                                <div class="tab-pane fade show active" id="base-info_new" role="tabpanel" aria-labelledby="base-info-tab_new">
                                    <form id="quoteBaseInfoForm_new">
                                        <table class="table table-sm mt-3">
                                            <tbody>
                                                <tr>
                                                    <th>Árajánlat száma</th>
                                                    <td><input type="text" class="form-control" name="quoteNumber" value="" placeholder="Automatikusan generálódik" readonly></td>
                                                </tr>
                                                <tr>
                                                    <th>Dátum</th>
                                                    <td><input type="date" class="form-control" name="quoteDate" value="@DateTime.Today.ToString("yyyy-MM-dd")" required></td>
                                                </tr>
                                                <tr>
                                                    <th>Partner</th>
                                                    <td>
                                                        <select name="partnerId" class="form-select tom-select" data-selected-id="" data-selected-text="" autocomplete="off" required>
                                                            <option value="" disabled selected>-- Válasszon partnert --</option>
                                                        </select>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>Értékesítő</th>
                                                    <td><input type="text" class="form-control" name="salesPerson" value=""></td>
                                                </tr>
                                                <tr>
                                                    <th>Érvényességi dátum</th>
                                                    <td><input type="date" class="form-control" name="validityDate" value="@DateTime.Today.AddDays(30).ToString("yyyy-MM-dd")"></td>
                                                </tr>
                                                <tr>
                                                    <th>Tárgy</th>
                                                    <td><input type="text" class="form-control" name="subject" value="" required></td>
                                                </tr>
                                                <tr>
                                                    <th>Leírás</th>
                                                    <td><textarea class="form-control" name="description" ></textarea></td>
                                                </tr>
                                                <tr>
                                                    <th>Részletes leírás</th>
                                                    <td><textarea class="form-control" name="detailedDescription" ></textarea></td>
                                                </tr>
                                                <tr>
                                                    <th>Státusz</th>
                                                    <td>
                                                        <select class="form-select" name="status" required>
                                                            @foreach (var status in Enum.GetValues(typeof(Cloud9_2.Pages.CRM.Quotes.QuoteStatus)))
                                                            {
                                                                var displayText = new Dictionary<string, string>
                                                                {
                                                                    { "InProgress", "Folyamatban" },
                                                                    { "Accepted", "Elfogadva" },
                                                                    { "Rejected", "Elutasítva" },
                                                                    { "Draft", "Piszkozat" }
                                                                }.GetValueOrDefault(status.ToString(), status.ToString());
                                                                <option value="@status" selected="@(status.ToString() == "Draft")">@displayText</option>
                                                            }
                                                        </select>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </form>
                                </div>

                                <!-- Items Tab -->
                                <div class="tab-pane fade" id="items_new" role="tabpanel" aria-labelledby="items-tab_new">
                                    <button type="button" class="btn btn-primary mb-3 add-item-row" data-quote-id="new">Tétel hozzáadása</button>
                                    <form id="quoteItemsForm_new" data-quote-id="new">
                                        <table class="table table-sm table-bordered">
                                            <thead>
                                                <tr>
                                                    <th style="width: 30%;">Termék</th>
                                                    <th style="width: 15%;">Mennyiség</th>
                                                    <th style="width: 15%;">Egységár</th>
                                                    <th style="width: 20%;">Kedvezmény</th>
                                                    <th style="width: 15%;">Összesen</th>
                                                    <th style="width: 5%;"></th>
                                                </tr>
                                            </thead>
                                            <tbody id="items-tbody_new">
                                                <!-- Quote Total Row -->
                                                <tr class="quote-total-row">
                                                    <td colspan="3"></td>
                                                    <td><strong>Összesen:</strong></td>
                                                    <td><span class="quote-total-amount">0.00</span></td>
                                                    <td></td>
                                                </tr>
                                                <tr class="quote-discount-row">
                                                    <td colspan="3"></td>
                                                    <td>
                                                        <div class="input-group input-group-sm">
                                                            <input type="text" name="DiscountPercentage" class="form-control quote-discount-value" value="" placeholder="pl. 10">
                                                            <select class="form-select quote-discount-type" data-discount-name-prefix="">
                                                                <option value="Percentage" selected>%</option>
                                                                <option value="Amount">Összeg</option>
                                                            </select>
                                                        </div>
                                                        <strong>Kedvezményes ár:</strong>
                                                    </td>
                                                    <td><span class="quote-final-total">0.00</span></td>
                                                    <td></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bezár</button>
                            <button type="button" class="btn btn-primary save-quote" data-quote-id="new">Mentés</button>
                        </div>
                    </div>
                </div>
            </div>
                }
            }
            else
            {
                <div class="alert alert-warning text-center mt-3" role="alert">
                    @if (!string.IsNullOrEmpty(Model.SearchTerm))
                    {
                        @:No quotes found matching "@Model.SearchTerm" on page @Model.CurrentPage.
                    }
                    else if (Model.TotalRecords > 0)
                    {
                        @:No quotes found on page @Model.CurrentPage, but @Model.TotalRecords quotes exist. Try changing the page or adjusting filters.
                    }
                    else
                    {
                        @:No quotes found. <button type="button" class="btn btn-link alert-link p-0 align-baseline" data-bs-toggle="modal" data-bs-target="#newQuoteModal" aria-label="Első árajánlat létrehozása">Create the first one?</button>
                    }
                    <!-- Debug Info -->
                    <div class="mt-2 small text-muted">
                        Debug: Page=@Model.CurrentPage, PageSize=@Model.PageSize, TotalRecords=@Model.TotalRecords, SearchTerm="@Model.SearchTerm"
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Pagination Footer -->
    @await Html.PartialAsync("_PaginationFooter", new PaginationViewModel
    {
        CurrentPage = Model.CurrentPage,
        TotalPages = Model.TotalPages,
        PageSize = Model.PageSize,
        SearchTerm = Model.SearchTerm,
        PageRoute = "./Index",
        EntityName = "Quotes"
    })



    <!-- Quote Items Modal -->
    @foreach (var quote in Model.Quotes)
    {
        <!-- View Quote Modal -->
        <div class="modal fade" id="viewQuoteModal_@quote.QuoteId" tabindex="-1" aria-labelledby="viewQuoteModalLabel_@quote.QuoteId" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="viewQuoteModalLabel_@quote.QuoteId">Részletek: @quote.QuoteNumber</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Bezárás"></button>
                    </div>
                    <div class="modal-body">
                        <table class="table table-sm">
                            <tbody>
                                <tr><th>Árajánlat száma</th><td>@quote.QuoteNumber</td></tr>
                                <tr><th>Dátum</th><td>@quote.QuoteDate?.ToString("yyyy-MM-dd")</td></tr>
                                <tr><th>Partner</th><td>@quote.Partner.Name</td></tr>
                                <tr><th>Értékesítő</th><td>@quote.SalesPerson</td></tr>
                                <tr><th>Érvényesség dátuma</th><td>@(quote.ValidityDate?.ToString("yyyy-MM-dd"))</td></tr>
                                <tr><th>Státusz</th><td>@quote.Status</td></tr>
                                <tr><th>Tárgy</th><td>@quote.Subject</td></tr>
                                <tr><th>Leírás</th><td>@quote.Description</td></tr>
                                <tr><th>Részletes leírás</th><td>@quote.DetailedDescription</td></tr>
                                <tr><th>Kedvezmény %</th><td>@(quote.DiscountPercentage.HasValue ? quote.DiscountPercentage.Value.ToString("F2", CultureInfo.GetCultureInfo("hu-HU")) : "0,00")</td></tr>
                                <tr><th>Kedvezmény összeg</th><td>@(quote.DiscountAmount.HasValue ? quote.DiscountAmount.Value.ToString("F2", CultureInfo.GetCultureInfo("hu-HU")) : "0,00")</td></tr>
                                <tr><th>Összesen</th><td>@(quote.TotalAmount.HasValue ? quote.TotalAmount.Value.ToString("F2", CultureInfo.GetCultureInfo("hu-HU")) : "0,00")</td></tr>
                            </tbody>
                        </table>
                        <h5 class="mt-4">Tételek</h5>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Termék</th>
                                    <th>Leírás</th>
                                    <th>Mennyiség</th>
                                    <th>Egységár</th>
                                    <th>Kedvezmény</th>
                                    <th>Összesen</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (quote.QuoteItems != null && quote.QuoteItems.Any())
                                {
                                    @foreach (var quoteItem in quote.QuoteItems)
                                    {
                                        <tr data-item-id="@quoteItem.QuoteItemId">
                                            <td>@(quoteItem.Product?.Name ?? "N/A")</td>
                                            <td>@quoteItem.ItemDescription</td>
                                            <td>@quoteItem.Quantity</td>
                                            <td>@quoteItem.UnitPrice.ToString("F2", CultureInfo.GetCultureInfo("hu-HU"))</td>
                                            <td>
                                                @(quoteItem.DiscountPercentage.HasValue && quoteItem.DiscountPercentage.Value > 0
                                                    ? $"{quoteItem.DiscountPercentage.Value:F2}%"
                                                    : quoteItem.DiscountAmount.HasValue && quoteItem.DiscountAmount.Value > 0
                                                        ? $"{quoteItem.DiscountAmount.Value:F2}"
                                                        : "0,00")
                                            </td>
                                            <td>
                                                @((quoteItem.Quantity * quoteItem.UnitPrice - (quoteItem.DiscountAmount ?? (quoteItem.DiscountPercentage.HasValue ? (quoteItem.Quantity * quoteItem.UnitPrice * quoteItem.DiscountPercentage.Value / 100) : 0))).ToString("F2", CultureInfo.GetCultureInfo("hu-HU")))
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="6">Nincsenek tételek.</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Bezárás">Bezárás</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete Quote Modal -->
        <div class="modal fade" id="deleteQuoteModal_@quote.QuoteId" tabindex="-1" aria-labelledby="deleteQuoteModalLabel_@quote.QuoteId" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteQuoteModalLabel_@quote.QuoteId">Árajánlat törlése</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Bezárás"></button>
                    </div>
                    <div class="modal-body">
                        <form id="deleteQuoteForm_@quote.QuoteId" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="QuoteId" value="@quote.QuoteId" autocomplete="off" />
                            <p>Biztosan törölni szeretné a következő árajánlatot: <strong>@quote.QuoteNumber</strong>?</p>
                            <div id="deleteWarning_@quote.QuoteId" class="alert alert-warning" style="display: none;">
                                Ez az árajánlat nem törölhető, mert kapcsolódó rekordok léteznek.
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Mégse">Mégse</button>
                        <button type="button" class="btn btn-danger confirm-delete-quote" data-quote-id="@quote.QuoteId" aria-label="Árajánlat törlése">Törlés</button>
                    </div>
                </div>
            </div>
        </div>
    }


    <div id="toastContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055;"></div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script>
    // Ensure jQuery is loaded
        if (typeof jQuery === 'undefined') {
            console.error('jQuery is not loaded!');
        } else {
            console.log('jQuery loaded successfully');
        }

    $(document).ready(function () {
        const debug = true;

// Use event delegation for dynamic buttons
            $(document).on('click', '.confirm-delete-quote', function (e) {
                e.preventDefault();
                const $button = $(this);
                const quoteId = $button.data('quote-id');
                console.log('Delete button clicked for QuoteId:', quoteId); // Debug

                if (!quoteId) {
                    console.error('QuoteId is missing from button data-quote-id');
                    return;
                }

                const $form = $(`#deleteQuoteForm_${quoteId}`);
                const $warningDiv = $(`#deleteWarning_${quoteId}`);

                if ($form.length) {
                    console.log('Form found for QuoteId:', quoteId); // Debug
                    const token = $form.find('input[name="__RequestVerificationToken"]').val();
                    if (!token) {
                        console.error('Anti-forgery token not found in form');
                        $warningDiv.text('Hiba: Biztonsági token hiányzik.');
                        $warningDiv.show();
                        return;
                    }

                    $.ajax({
                        url: `/api/quotes/${quoteId}`, // Adjust if endpoint differs
                        type: 'DELETE',
                        headers: {
                            'RequestVerificationToken': token
                        },
                        beforeSend: function () {
                            console.log('Sending DELETE request for QuoteId:', quoteId); // Debug
                        },
                        success: function (data, status, xhr) {
                            console.log('Delete response:', { status: xhr.status, data }); // Debug
                            if (xhr.status === 204) {
                                console.log('Quote deleted successfully, reloading page');
                                $(`#deleteQuoteModal_${quoteId}`).modal('hide');
                                window.location.reload();
                            } else {
                                console.warn('Unexpected status code:', xhr.status);
                                $warningDiv.text('Sikeres törlés, de váratlan válasz: ' + xhr.status);
                                $warningDiv.show();
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('Delete error:', { status: xhr.status, response: xhr.responseText }); // Debug
                            let message = 'Hiba történt a törlés során.';
                            if (xhr.status === 404) {
                                message = xhr.responseJSON?.error || 'Az árajánlat nem található.';
                            } else if (xhr.status === 500) {
                                message = xhr.responseJSON?.error || 'Szerver hiba történt a törlés során.';
                            } else if (xhr.status === 403) {
                                message = 'Hozzáférés megtagadva: bejelentkezés szükséges.';
                            }
                            $warningDiv.text(message);
                            $warningDiv.show();
                        }
                    });
                } else {
                    console.error('Form not found for QuoteId:', quoteId);
                    $warningDiv.text('Hiba: Törlési űrlap nem található.');
                    $warningDiv.show();
                }
            });

        function showToast(type, message) {
            const toast = $(`
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `);
            $('#toastContainer').append(toast);
            const bsToast = new bootstrap.Toast(toast[0]);
            bsToast.show();
            setTimeout(() => toast.remove(), 5500);
        }

        function getTodayDate() {
            const today = new Date();
            return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        }


        $(document).on('click', '.confirm-delete-quote', function () {
            const quoteId = $(this).data('quote-id');
            $.ajax({
                url: `/api/Quotes/${quoteId}`,
                method: 'DELETE',
                success: function (response) {
                    showToast('success', 'Árajánlat sikeresen törölve!');
                    $(`#deleteQuoteModal_${quoteId}`).modal('hide');
                    $(`.partner-card[data-quote-id="${quoteId}"]`).remove();
                },
                error: function (xhr) {
                    console.error('Error deleting quote:', xhr.responseText);
                    showToast('error', 'Hiba történt a törlés során.');
                }
            });
        });
    });
</script>


<!-- Tom Select Dependencies -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.4.3/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.4.3/dist/js/tom-select.complete.min.js"></script>

<!-- CSS Fix for Tom Select Placeholder and Layout -->
<style>

    .bg-success-dark {
    background-color: #146c43 !important;
    color: white;
    }
    .bg-primary-dark {
        background-color: #0a58ca !important;
        color: white;
    }
    .bg-info-dark {
        background-color: #087990 !important;
        color: white;
    }
    .ts-wrapper .ts-control > .placeholder {
        color: #6c757d !important; /* Bootstrap secondary color */
        opacity: 1 !important;
    }
    .ts-wrapper .ts-control {
        min-height: calc(1.5em + 0.5rem + 2px); /* Smaller for clarity */
    }
    .table {
        border-collapse: separate;
    }
    .table th, .table td {
        padding: 12px 10px; /* More padding for breathing room */
        vertical-align: middle;
    }
    .table thead th {
        background-color: #e9ecef; /* Subtle header background */
        font-weight: 600;
    }
    .quote-item-row {
        background-color: #fff; /* White background for rows */
        box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* Subtle shadow for separation */
    }
    .form-control-sm, .form-select-sm {
        font-size: 0.85rem; /* Smaller font for inputs */
        padding: 0.25rem 0.5rem; /* Compact padding */
    }
    .input-group-sm .form-control, .input-group-sm .form-select {
        height: 30px; /* Compact input group */
    }
    .input-group .form-control.discount-value, .input-group .form-control.quote-discount-value {
        width: 80px; /* Smaller discount input */
    }
    .input-group .form-select.discount-type, .input-group .form-select.quote-discount-type {
        width: 60px; /* Smaller discount type select */
    }
    .total-price, .quote-total-amount, .quote-final-total {
        display: inline-block;
        min-width: 80px;
        text-align: right;
        font-weight: 500;
    }
    .btn-sm {
        padding: 0.2rem 0.4rem; /* Smaller buttons */
        font-size: 0.8rem;
    }
    .edit-description, .remove-item-row {
        margin-right: 6px;
    }
    .char-count {
        font-weight: bold;
    }
    .description-row {
        background-color: #f8f9fa; /* Light background for contrast */
    }
    .description-row .form-label {
        font-weight: 500;
        font-size: 0.9rem;
    }
    .description-row .mb-2 {
        padding: 8px 10px; /* Reduced padding */
    }
    .description-row .form-control-sm {
        font-size: 0.85rem;
        resize: vertical; /* Allow vertical resize only */
    }
    .quote-total-row, .quote-discount-row {
        font-weight: bold;
        background-color: #f1f3f5; /* Slightly darker for totals */
    }
</style>


<!-- JavaScript for Tom Select, Add Row, Total Price Calculation, and Save -->
@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Dropdown script loaded'); // Debug

            const filterItems = document.querySelectorAll('.dropdown-menu [data-filter]');
            console.log('Found filter items:', filterItems.length); // Debug

            filterItems.forEach(item => {
                item.addEventListener('click', function (e) {
                    e.preventDefault();
                    const filter = this.getAttribute('data-filter');
                    const sort = this.getAttribute('data-sort');
                    console.log('Clicked item:', { filter, sort }); // Debug

                    // Try multiple selectors to find the form
                    let form = document.querySelector('form[asp-page="./Index"]') ||
                               document.querySelector('form[action="/CRM/Quotes"]') ||
                               document.querySelector('form[action="/CRM/Quotes/Index"]');

                    if (form) {
                        console.log('Form found, submitting:', { filter, sort }); // Debug

                        // Clear previous hidden inputs
                        form.querySelectorAll('input[name="StatusFilter"], input[name="SortBy"]').forEach(input => input.remove());

                        // Add StatusFilter
                        const statusInput = document.createElement('input');
                        statusInput.type = 'hidden';
                        statusInput.name = 'StatusFilter';
                        statusInput.value = filter === 'all' ? '' : filter;
                        form.appendChild(statusInput);

                        // Add SortBy
                        const sortInput = document.createElement('input');
                        sortInput.type = 'hidden';
                        sortInput.name = 'SortBy';
                        sortInput.value = sort;
                        form.appendChild(sortInput);

                        form.submit();
                    } else {
                        console.error('Form not found. Available forms:', document.querySelectorAll('form').length);
                        document.querySelectorAll('form').forEach(f => console.log('Form action:', f.getAttribute('action')));
                    }
                });
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Status mapping
            const statusMapping = {
                'Folyamatban': 'InProgress',
                'Felfüggesztve': 'Suspended',
                'Jóváhagyásra_vár': 'PendingApproval',
                'Jóváhagyva': 'Approved',
                'Kiküldve': 'Sent',
                'Elfogadva': 'Accepted',
                'Megrendelve': 'Ordered',
                'Teljesítve': 'Fulfilled',
                'Lezárva': 'Closed',
                'InProgress': 'InProgress',
                'Accepted': 'Accepted',
                'Rejected': 'Rejected',
                'Draft': 'Draft'
            };
            // Handle filter/sort dropdown
            document.querySelectorAll('.dropdown-menu [data-filter]').forEach(filterItem => {
                filterItem.addEventListener('click', function (e) {
                    e.preventDefault();
                    const filter = this.getAttribute('data-filter');
                    const sort = this.getAttribute('data-sort');
                    const form = document.querySelector('form[action="./Index"]');
                    if (form) {
                        // Add StatusFilter
                        const statusInput = document.createElement('input');
                        statusInput.type = 'hidden';
                        statusInput.name = 'StatusFilter';
                        statusInput.value = filter === 'all' ? '' : filter;
                        form.appendChild(statusInput);

                        // Add SortBy
                        const sortInput = document.createElement('input');
                        sortInput.type = 'hidden';
                        sortInput.name = 'SortBy';
                        sortInput.value = sort;
                        form.appendChild(sortInput);

                        form.submit();
                    }
                });
            });

            // Calculate Total Price for a Row
            function calculateTotalPrice(row, forceRecalculate = false) {
                try {
                    console.log('Calculating total price for row:', row.dataset.itemId);
                    const quantityInput = row.querySelector('.quantity');
                    const unitPriceInput = row.querySelector('.unit-price');
                    const discountValueInput = row.querySelector('.discount-value');
                    const discountTypeSelect = row.querySelector('.discount-type');
                    const totalPriceSpan = row.querySelector('.total-price');

                    if (!quantityInput || !unitPriceInput || !discountValueInput || !discountTypeSelect || !totalPriceSpan) {
                        console.error('Missing elements in row:', row.dataset.itemId, {
                            quantity: !!quantityInput,
                            unitPrice: !!unitPriceInput,
                            discountValue: !!discountValueInput,
                            discountType: !!discountTypeSelect,
                            totalPrice: !!totalPriceSpan
                        });
                        return 0;
                    }

                    if (forceRecalculate || row.dataset.initialized !== 'true') {
                        const quantity = parseFloat(quantityInput.value) || 0;
                        const unitPrice = parseFloat(unitPriceInput.value) || 0;
                        const discountValue = parseFloat(discountValueInput.value) || 0;
                        const discountType = discountTypeSelect.value;

                        let total = quantity * unitPrice;
                        let discount = 0;

                        if (discountValue > 0) {
                            if (discountType === 'Percentage') {
                                discount = total * (discountValue / 100);
                            } else {
                                discount = discountValue;
                            }
                        }

                        total = total - discount;
                        total = total < 0 ? 0 : total;
                        totalPriceSpan.textContent = total.toFixed(2);
                        row.dataset.initialized = 'true';
                        console.log('Total price set to:', total.toFixed(2), 'for item:', row.dataset.itemId);
                        return total;
                    } else {
                        const currentTotal = parseFloat(totalPriceSpan.textContent) || 0;
                        console.log('Using existing total price:', currentTotal, 'for item:', row.dataset.itemId);
                        return currentTotal;
                    }
                } catch (error) {
                    console.error('Error calculating total price for row:', row.dataset.itemId, error);
                    return 0;
                }
            }

            // Calculate Quote Totals
            function calculateQuoteTotals(quoteId, retryCount = 0) {
                try {
                    const tbody = document.querySelector(`#items-tbody_${quoteId}`);
                    const totalAmountSpan = document.querySelector(`#items-tbody_${quoteId} .quote-total-amount`);
                    const finalTotalSpan = document.querySelector(`#items-tbody_${quoteId} .quote-final-total`);
                    const discountValueInput = document.querySelector(`#items-tbody_${quoteId} .quote-discount-value`);
                    const discountTypeSelect = document.querySelector(`#items-tbody_${quoteId} .quote-discount-type`);

                    if (!tbody || !totalAmountSpan || !finalTotalSpan) {
                        console.error('Missing quote total elements for quoteId:', quoteId, {
                            tbody: !!tbody,
                            totalAmountSpan: !!totalAmountSpan,
                            finalTotalSpan: !!finalTotalSpan,
                            discountValueInput: !!discountValueInput,
                            discountTypeSelect: !!discountTypeSelect
                        });
                        return 0;
                    }

                    const rows = tbody.querySelectorAll('.quote-item-row');
                    console.log('Found rows for quote totals:', rows.length, 'IDs:', Array.from(rows).map(r => r.dataset.itemId));
                    if (rows.length === 0 && retryCount < 5) {
                        console.warn('No rows found for quoteId:', quoteId, 'retrying in 100ms, attempt:', retryCount + 1);
                        setTimeout(() => calculateQuoteTotals(quoteId, retryCount + 1), 100);
                        return 0;
                    }

                    let totalAmount = 0;
                    rows.forEach(row => {
                        const price = parseFloat(row.querySelector('.total-price').textContent) || 0;
                        console.log('Row price:', price, 'for item:', row.dataset.itemId);
                        totalAmount += price;
                    });

                    const discountValue = parseFloat(discountValueInput?.value) || 0;
                    const discountType = discountTypeSelect?.value;
                    let quoteDiscount = 0;

                    if (discountValue > 0 && discountType) {
                        if (discountType === 'Percentage') {
                            quoteDiscount = totalAmount * (discountValue / 100);
                        } else {
                            quoteDiscount = discountValue;
                        }
                    }

                    const finalTotal = totalAmount - quoteDiscount;
                    console.log('Total Amount:', totalAmount.toFixed(2), 'Final Total:', finalTotal.toFixed(2));
                    totalAmountSpan.textContent = totalAmount.toFixed(2);
                    finalTotalSpan.textContent = finalTotal < 0 ? '0.00' : finalTotal.toFixed(2);
                    return finalTotal;
                } catch (error) {
                    console.error('Error calculating quote totals for quoteId:', quoteId, error);
                    return 0;
                }
            }

            // Update Discount Input Name Based on Type
            function updateDiscountInputName(row) {
                const discountInput = row.querySelector('.discount-value');
                const discountType = row.querySelector('.discount-type');
                if (discountInput && discountType) {
                    const prefix = discountType.dataset.discountNamePrefix;
                    discountInput.name = `${prefix}.${discountType.value === 'Percentage' ? 'DiscountPercentage' : 'DiscountAmount'}`;
                }
            }

            // Update Quote-Level Discount Input Name
            function updateQuoteDiscountInputName(quoteId) {
                const discountInput = document.querySelector(`#items-tbody_${quoteId} .quote-discount-value`);
                const discountType = document.querySelector(`#items-tbody_${quoteId} .quote-discount-type`);
                if (discountInput && discountType) {
                    discountInput.name = discountType.value === 'Percentage' ? 'DiscountPercentage' : 'DiscountAmount';
                }
            }

            // Initialize Row Calculations
            function initializeRowCalculations(row) {
                const inputs = row.querySelectorAll('.quantity, .unit-price, .discount-value, .discount-type');
                console.log('Initializing row:', row.dataset.itemId, 'Found inputs:', inputs.length);
                inputs.forEach(input => {
                    input.addEventListener('input', () => {
                        console.log('Input changed:', input.name, 'Value:', input.value);
                        updateDiscountInputName(row);
                        calculateTotalPrice(row, true);
                        calculateQuoteTotals(row.closest('tbody').id.replace('items-tbody_', ''));
                    });
                });
                updateDiscountInputName(row);
                calculateTotalPrice(row);
            }

            // Initialize Description Toggle
            function initializeDescriptionToggle(row) {
                const itemId = row.dataset.itemId;
                const descriptionRow = document.querySelector(`.description-row[data-item-id="${itemId}"]`);
                const editButton = row.querySelector('.edit-description');
                if (!descriptionRow || !editButton) {
                    console.warn('Description row or edit button missing for item:', itemId);
                    return;
                }
                const textarea = descriptionRow.querySelector('.item-description-input');
                const charCount = descriptionRow.querySelector('.char-count');
                const hiddenInput = row.querySelector('.item-description');

                textarea.addEventListener('input', () => {
                    const length = textarea.value.length;
                    charCount.textContent = `${length}/200`;
                    hiddenInput.value = textarea.value;
                    console.log('Description updated for item:', itemId, 'Value:', textarea.value);
                });

                editButton.addEventListener('click', () => {
                    const isHidden = descriptionRow.style.display === 'none';
                    descriptionRow.style.display = isHidden ? 'table-row' : 'none';
                    console.log('Toggled description for item:', itemId, 'Visible:', isHidden);
                });
            }

            // Initialize Quote-Level Discount Calculations
            function initializeQuoteDiscountCalculations(quoteId) {
                const tbody = document.querySelector(`#items-tbody_${quoteId}`);
                const inputs = tbody.querySelectorAll('.quote-discount-value, .quote-discount-type');
                inputs.forEach(input => {
                    input.addEventListener('input', () => {
                        updateQuoteDiscountInputName(quoteId);
                        calculateQuoteTotals(quoteId);
                    });
                });
                updateQuoteDiscountInputName(quoteId);
            }

            // Initialize Delete Functionality
            function initializeDeleteButtons(quoteId) {
                const tbody = document.querySelector(`#items-tbody_${quoteId}`);
                if (!tbody) {
                    console.error('Tbody not found for quoteId:', quoteId);
                    return;
                }
                tbody.addEventListener('click', function(event) {
                    if (event.target.closest('.remove-item-row')) {
                        const button = event.target.closest('.remove-item-row');
                        const row = button.closest('.quote-item-row');
                        const itemId = row.dataset.itemId;
                        const descriptionRow = document.querySelector(`.description-row[data-item-id="${itemId}"]`);

                        console.log('Delete clicked for item:', itemId);
                        row.remove();
                        if (descriptionRow) {
                            descriptionRow.remove();
                        }
                        calculateQuoteTotals(quoteId);
                    }
                });
            }

            // Initialize Tom Select for Partners
            function initializePartnerTomSelect(select, quoteId) {
                const selectedId = select.dataset.selectedId;
                const selectedText = select.dataset.selectedText;
                console.log('Tom Select Partner Init for quoteId:', quoteId, 'selectedId:', selectedId, 'selectedText:', selectedText);

                const control = new TomSelect(select, {
                    valueField: 'id',
                    labelField: 'text',
                    searchField: 'text',
                    placeholder: '-- Válasszon partnert --',
                    allowEmptyOption: true,
                    maxOptions: 100,
                    load: function(query, callback) {
                        const url = `/api/partners?term=${encodeURIComponent(query)}`;
                        console.log('Partner Search Query:', url);
                        fetch(url)
                            .then(response => {
                                if (!response.ok) {
                                    return response.text().then(text => {
                                        throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                                    });
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log('API /api/partners Response:', data);
                                if (Array.isArray(data)) {
                                    callback(data);
                                } else {
                                    console.warn('Invalid response format for partners:', data);
                                    callback([]);
                                }
                            })
                            .catch(error => {
                                console.error('Partner Search Error:', error);
                                callback([{ id: 0, text: 'Hiba: Nem sikerült betölteni a partnereket' }]);
                            });
                    },
                    shouldLoad: function(query) {
                        return query.length > 0;
                    },
                    render: {
                        option: function(data, escape) {
                            return `<div>${escape(data.text)}</div>`;
                        },
                        item: function(data, escape) {
                            return `<div>${escape(data.text)}</div>`;
                        },
                        no_results: function(data, escape) {
                            return `<div class="no-results">Nincs találat "${escape(data.input)}"</div>`;
                        }
                    }
                });

                if (selectedId && selectedId !== '0') {
                    control.addOption({ id: selectedId, text: selectedText });
                    control.setValue(selectedId);
                    const url = `/api/partners/${selectedId}`;
                    fetch(url)
                        .then(response => {
                            if (!response.ok) {
                                return response.text().then(text => {
                                    throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data && data.text) {
                                control.addOption({ id: data.id, text: data.text });
                                control.setValue(data.id);
                            }
                        })
                        .catch(error => {
                            console.error('Failed to preload partner for ID:', selectedId, 'quoteId:', quoteId, error);
                        });
                }
            }

            // Initialize Tom Select for Products
            function initializeProductTomSelect(select, quoteId) {
                const selectedId = select.dataset.selectedId;
                const selectedText = select.dataset.selectedText;
                console.log('Tom Select Product Init for quoteId:', quoteId, 'selectedId:', selectedId, 'selectedText:', selectedText);

                const control = new TomSelect(select, {
                    valueField: 'id',
                    labelField: 'name',
                    searchField: 'name',
                    placeholder: '-- Válasszon terméket --',
                    allowEmptyOption: true,
                    maxOptions: 100,
                    load: function(query, callback) {
                        const url = `/api/Product?search=${encodeURIComponent(query)}`;
                        console.log('Product Search Query:', url);
                        fetch(url)
                            .then(response => {
                                if (!response.ok) {
                                    return response.text().then(text => {
                                        throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                                    });
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log('API /api/Product Response:', data);
                                if (Array.isArray(data)) {
                                    callback(data);
                                } else {
                                    console.warn('Invalid response format for products:', data);
                                    callback([]);
                                }
                            })
                            .catch(error => {
                                console.error('Product Search Error:', error);
                                callback([{ id: 0, name: 'Hiba: Nem sikerült betölteni a termékeket' }]);
                            });
                    },
                    shouldLoad: function(query) {
                        return query.length > 0;
                    },
                    render: {
                        option: function(data, escape) {
                            return `<div>${escape(data.name)}</div>`;
                        },
                        item: function(data, escape) {
                            return `<div>${escape(data.name)}</div>`;
                        },
                        no_results: function(data, escape) {
                            return `<div class="no-results">Nincs találat "${escape(data.input)}"</div>`;
                        }
                    }
                });

                if (selectedId && selectedId !== '0' && selectedText) {
                    control.addOption({ id: selectedId, name: selectedText });
                    control.setValue(selectedId);
                    console.log('Set initial product:', selectedText, 'for ID:', selectedId, 'quoteId:', quoteId);
                    const url = `/api/Product/${selectedId}`;
                    fetch(url)
                        .then(response => {
                            if (!response.ok) {
                                return response.text().then(text => {
                                    throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data && data.name) {
                                control.addOption({ id: data.id, name: data.name });
                                control.setValue(data.id);
                            }
                        })
                        .catch(error => {
                            console.error('Failed to preload product for ID:', selectedId, 'quoteId:', quoteId, error);
                        });
                }
            }

            // Add Row Functionality
            function addItemRow(quoteId) {
                const tbody = document.querySelector(`#items-tbody_${quoteId}`);
                if (!tbody) {
                    console.error('Items tbody not found for quoteId:', quoteId);
                    return;
                }
                const newItemId = 'new_' + Date.now();
                console.log('Adding new item row for quoteId:', quoteId, 'NewItemId:', newItemId);

                const itemRow = document.createElement('tr');
                itemRow.className = 'quote-item-row';
                itemRow.dataset.itemId = newItemId;
                itemRow.innerHTML = `
                    <td>
                        <select name="quoteItems[${newItemId}].ProductId" class="form-select tom-select-product" data-selected-id="" data-selected-text="" autocomplete="off" required>
                            <option value="" disabled selected>-- Válasszon terméket --</option>
                        </select>
                    </td>
                    <td>
                        <input type="number" name="quoteItems[${newItemId}].Quantity" class="form-control form-control-sm quantity" value="1" min="0" step="1" required>
                    </td>
                    <td>
                        <input type="number" name="quoteItems[${newItemId}].UnitPrice" class="form-control form-control-sm unit-price" value="0" min="0" step="0.01" required>
                    </td>
                    <td>
                        <div class="input-group input-group-sm">
                            <input type="number" name="quoteItems[${newItemId}].DiscountPercentage" class="form-control discount-value" value="" placeholder="pl. 10" min="0" step="0.01">
                            <select class="form-select discount-type" data-discount-name-prefix="quoteItems[${newItemId}]">
                                <option value="Percentage" selected>%</option>
                                <option value="Amount">Összeg</option>
                            </select>
                        </div>
                    </td>
                    <td>
                        <span class="total-price">0.00</span>
                        <input type="hidden" name="quoteItems[${newItemId}].ItemDescription" class="item-description" value="">
                    </td>
                    <td>
                        <button type="button" class="btn btn-outline-secondary btn-sm edit-description" data-item-id="${newItemId}"><i class="bi bi-pencil"></i></button>
                        <button type="button" class="btn btn-danger btn-sm remove-item-row"><i class="bi bi-trash"></i></button>
                    </td>
                `;

                const descriptionRow = document.createElement('tr');
                descriptionRow.className = 'description-row';
                descriptionRow.dataset.itemId = newItemId;
                descriptionRow.style.display = 'none';
                descriptionRow.innerHTML = `
                    <td colspan="6">
                        <div class="mb-2">
                            <label class="form-label">Leírás (max 200 karakter)</label>
                            <textarea name="quoteItems[${newItemId}].ItemDescriptionInput" class="form-control form-control-sm item-description-input" maxlength="200" rows="2"></textarea>
                            <div class="form-text">Karakterek: <span class="char-count">0</span>/200</div>
                        </div>
                    </td>
                `;

                tbody.insertBefore(itemRow, tbody.querySelector('.quote-total-row'));
                tbody.insertBefore(descriptionRow, tbody.querySelector('.quote-total-row'));

                initializeRowCalculations(itemRow);
                initializeDescriptionToggle(itemRow);
                const newSelect = itemRow.querySelector('.tom-select-product');
                initializeProductTomSelect(newSelect, quoteId);
                calculateQuoteTotals(quoteId);
                console.log('Added new item row:', newItemId, 'Row HTML:', itemRow.outerHTML);
            }

            // Validate Form
            function validateForm(form, quoteId) {
                const errors = [];
                const requiredFields = form.querySelectorAll('[required]');
                requiredFields.forEach(field => {
                    const value = field.value.trim();
                    if (!value) {
                        const label = field.closest('tr')?.querySelector('th')?.textContent || field.name;
                        errors.push(`${label} mező kitöltése kötelező`);
                    }
                    if (['subject'].includes(field.name)) {
                        if (!value || value === '1' || value === 'x') {
                            const label = field.closest('tr')?.querySelector('th')?.textContent || field.name;
                            errors.push(`${label} mező nem lehet üres, "1" vagy "x"`);
                            console.warn(`Invalid value for ${field.name}: ${value}`);
                        }
                    }
                    if (field.name.includes('.Quantity') || field.name.includes('.UnitPrice')) {
                        const numValue = parseFloat(value);
                        if (isNaN(numValue) || numValue <= 0) {
                            const label = field.closest('tr')?.querySelector('th')?.textContent || field.name;
                            errors.push(`${label} mező pozitív szám kell legyen`);
                        }
                    }
                    console.log('Validating field:', field.name, 'Value:', value);
                });
                return errors;
            }

            // Save Quote
            function saveQuote(quoteId) {
                const baseForm = document.querySelector(`#quoteBaseInfoForm_${quoteId}`);
                const itemsForm = document.querySelector(`#quoteItemsForm_${quoteId}`);
                const totalAmount = calculateQuoteTotals(quoteId);

                // Switch to base-info tab
                const baseInfoTab = document.querySelector(`#base-info-tab_${quoteId}`);
                if (baseInfoTab) {
                    baseInfoTab.click();
                    console.log('Switched to base-info tab for quoteId:', quoteId);
                }

                // Validate forms
                const baseErrors = validateForm(baseForm, quoteId);
                const itemErrors = validateForm(itemsForm, quoteId);
                if (baseErrors.length > 0 || itemErrors.length > 0) {
                    const allErrors = [...baseErrors, ...itemErrors];
                    console.log('Validation errors for quoteId:', quoteId, allErrors);
                    alert('Kérjük, töltse ki az összes kötelező mezőt megfelelően:\n' + allErrors.join('\n'));
                    return;
                }

                const baseData = new FormData(baseForm);
                const itemsData = new FormData(itemsForm);

                // Get quote-level discount
                const discountValue = parseFloat(itemsData.get('DiscountPercentage') || itemsData.get('DiscountAmount')) || 0;
                const discountType = document.querySelector(`#items-tbody_${quoteId} .quote-discount-type`)?.value;
                const discountPercentage = discountType === 'Percentage' && discountValue > 0 ? discountValue : null;
                const discountAmount = discountType === 'Amount' && discountValue > 0 ? discountValue : null;

                console.log('Base form data for quoteId:', quoteId, Object.fromEntries(baseData));
                console.log('Items form data for quoteId:', quoteId, Object.fromEntries(itemsData));

                const quoteDto = {
                    QuoteNumber: baseData.get('quoteNumber') || '',
                    PartnerId: parseInt(baseData.get('partnerId')) || null,
                    QuoteDate: baseData.get('quoteDate') || null,
                    Status: statusMapping[baseData.get('status')] || baseData.get('status'),
                    TotalAmount: totalAmount,
                    SalesPerson: baseData.get('salesPerson') || '',
                    ValidityDate: baseData.get('validityDate') || null,
                    Subject: baseData.get('subject') || '',
                    Description: baseData.get('description') || '',
                    DetailedDescription: baseData.get('detailedDescription') || '',
                    DiscountPercentage: discountPercentage,
                    DiscountAmount: discountAmount
                };

                const quoteItems = [];
                const rows = document.querySelectorAll(`#items-tbody_${quoteId} .quote-item-row`);
                console.log('Found rows for saving:', rows.length, 'IDs:', Array.from(rows).map(r => r.dataset.itemId));
                rows.forEach(row => {
                    const itemId = row.dataset.itemId;
                    const isNew = itemId.startsWith('new_');
                    const productId = itemsData.get(`quoteItems[${itemId}].ProductId`);
                    if (!productId) {
                        console.warn('Skipping item with no ProductId:', itemId);
                        return;
                    }
                    const itemDescription = itemsData.get(`quoteItems[${itemId}].ItemDescription`) || "";
                    const discountValue = itemsData.get(`quoteItems[${itemId}].DiscountPercentage`) || itemsData.get(`quoteItems[${itemId}].DiscountAmount`);
                    const discountType = row.querySelector('.discount-type')?.value;
                    const productSelect = row.querySelector('.tom-select-product');
                    const productName = productSelect?.dataset.selectedText || row.querySelector('.ts-control .item')?.textContent || '';
                    const item = {
                        QuoteItemId: isNew ? null : parseInt(itemId),
                        QuoteId: parseInt(quoteId) || null,
                        ProductId: parseInt(productId),
                        ProductName: productName,
                        Quantity: parseFloat(itemsData.get(`quoteItems[${itemId}].Quantity`)) || 0,
                        UnitPrice: parseFloat(itemsData.get(`quoteItems[${itemId}].UnitPrice`)) || 0,
                        ItemDescription: itemDescription,
                        DiscountPercentage: discountType === 'Percentage' && discountValue ? parseFloat(discountValue) : null,
                        DiscountAmount: discountType === 'Amount' && discountValue ? parseFloat(discountValue) : null
                    };
                    quoteItems.push({ item, isNew });
                });

                if (quoteItems.length === 0) {
                    console.log('No quote items found for quoteId:', quoteId);
                    alert('Legalább egy tétel szükséges az árajánlathoz.');
                    return;
                }

                console.log('Saving quote for quoteId:', quoteId, { quoteDto, quoteItems });

                // Handle new quote creation differently
                if (quoteId === 'new') {
                    // Create Quote
                    console.log('Creating new quote: /api/Quotes, Payload:', quoteDto);
                    fetch('/api/Quotes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(quoteDto)
                    })
                    .then(response => {
                        console.log(`Quote create response for quoteId: ${quoteId}, Status ${response.status}, Headers:`, Object.fromEntries(response.headers));
                        if (!response.ok) {
                            return response.json().then(err => {
                                console.error(`Quote error details:`, err);
                                throw new Error(`Failed to create quote: ${response.status} "${err.title || JSON.stringify(err.errors) || 'Request failed'}"`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        const newQuoteId = data.quoteId || data.QuoteId;
                        console.log('Quote created successfully, QuoteId:', newQuoteId);

                        // Save Quote Items
                        const itemPromises = quoteItems.map(({ item }) => {
                            const url = `/api/Quotes/${newQuoteId}/Items`;
                            const payload = {
                                QuoteId: newQuoteId,
                                ProductId: item.ProductId,
                                ProductName: item.ProductName,
                                Quantity: item.Quantity,
                                UnitPrice: item.UnitPrice,
                                ItemDescription: item.ItemDescription,
                                DiscountPercentage: item.DiscountPercentage,
                                DiscountAmount: item.DiscountAmount
                            };
                            console.log(`Saving item: new, Method: POST, URL: ${url}, Payload:`, payload);
                            return fetch(url, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            })
                            .then(response => {
                                console.log(`Item response for new: Status ${response.status}, Headers:`, Object.fromEntries(response.headers));
                                if (!response.ok) {
                                    return response.json().then(err => {
                                        console.error(`Error details for new:`, err);
                                        throw new Error(`Failed to create item: ${response.status} "${err.title || JSON.stringify(err.errors) || 'Request failed'}"`);
                                    });
                                }
                                return response.json();
                            });
                        });

                        return Promise.all(itemPromises).then(savedItems => {
                            console.log('All items saved for quoteId:', newQuoteId, savedItems.map(i => ({ QuoteItemId: i.quoteItemId || i.QuoteItemId, ProductId: i.productId || i.ProductId })));
                            return newQuoteId;
                        });
                    })
                    .then(newQuoteId => {
                        console.log('Quote and items saved successfully for quoteId:', newQuoteId);
                        alert('Árajánlat sikeresen létrehozva!');
                        const modal = document.getElementById('newQuoteModal');
                        bootstrap.Modal.getInstance(modal).hide();
                        window.location.reload();
                    })
                    .catch(error => {
                        console.error('Save error for quoteId:', quoteId, error);
                        alert('Hiba történt az árajánlat létrehozása közben: ' + error.message);
                    });
                } else {
                    // Existing quote update logic
                    const itemPromises = quoteItems.map(({ item, isNew }) => {
                        const url = isNew ? `/api/Quotes/${quoteId}/Items` : `/api/Quotes/${quoteId}/Items/${item.QuoteItemId}`;
                        const method = isNew ? 'POST' : 'PUT';
                        const payload = {
                            QuoteId: item.QuoteId,
                            ProductId: item.ProductId,
                            ProductName: item.ProductName,
                            Quantity: item.Quantity,
                            UnitPrice: item.UnitPrice,
                            ItemDescription: item.ItemDescription,
                            DiscountPercentage: item.DiscountPercentage,
                            DiscountAmount: item.DiscountAmount
                        };
                        console.log(`Saving item: ${item.QuoteItemId || 'new'}, Method: ${method}, URL: ${url}, Payload:`, payload);
                        return fetch(url, {
                            method: method,
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        })
                        .then(response => {
                            console.log(`Item response for ${item.QuoteItemId || 'new'}: Status ${response.status}, Headers:`, Object.fromEntries(response.headers));
                            if (!response.ok) {
                                return response.json().then(err => {
                                    console.error(`Error details for ${item.QuoteItemId || 'new'}:`, err);
                                    throw new Error(`Failed to ${isNew ? 'create' : 'update'} item ${item.QuoteItemId || 'new'}: ${response.status} "${err.title || JSON.stringify(err.errors) || 'Request failed'}"`);
                                });
                            }
                            return response.json();
                        });
                    });

                    Promise.all(itemPromises)
                        .then(savedItems => {
                            console.log('All items saved for quoteId:', quoteId, savedItems.map(i => ({ QuoteItemId: i.quoteItemId || i.QuoteItemId, ProductId: i.productId || i.ProductId })));
                            console.log(`Updating quote: /api/Quotes/${quoteId}, Payload:`, quoteDto);
                            return fetch(`/api/Quotes/${quoteId}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(quoteDto)
                            });
                        })
                        .then(response => {
                            console.log(`Quote update response for quoteId: ${quoteId}, Status ${response.status}, Headers:`, Object.fromEntries(response.headers));
                            if (!response.ok) {
                                return response.json().then(err => {
                                    console.error(`Quote error details:`, err);
                                    throw new Error(`Failed to update quote: ${response.status} "${err.title || JSON.stringify(err.errors) || 'Request failed'}"`);
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('Quote saved successfully for quoteId:', quoteId, data);
                            alert('Árajánlat sikeresen mentve!');
                            const modal = document.getElementById(`editQuoteModal_${quoteId}`);
                            bootstrap.Modal.getInstance(modal).hide();
                            window.location.reload();
                        })
                        .catch(error => {
                            console.error('Save error for quoteId:', quoteId, error);
                            alert('Hiba történt az árajánlat mentése közben: ' + error.message);
                        });
                }
            }

            // Initialize Event Listeners for a Quote
            function initializeEventListeners(quoteId) {
                // Add Row
                const addButtons = document.querySelectorAll(`.add-item-row[data-quote-id="${quoteId}"]`);
                console.log('Found add-item-row buttons for quoteId:', quoteId, addButtons.length, 'Selectors:', Array.from(addButtons).map(b => b.outerHTML));
                if (addButtons.length === 0) {
                    console.error('No add-item-row buttons found for quoteId:', quoteId);
                }
                addButtons.forEach((button, index) => {
                    button.removeEventListener('click', () => addItemRow(quoteId));
                    button.addEventListener('click', () => {
                        console.log(`Add item button ${index} clicked for quoteId: ${quoteId}`);
                        addItemRow(quoteId);
                    });
                });

                // Save Quote
                const saveButtons = document.querySelectorAll(`.save-quote[data-quote-id="${quoteId}"]`);
                console.log('Found save-quote buttons for quoteId:', quoteId, saveButtons.length, 'Selectors:', Array.from(saveButtons).map(b => b.outerHTML));
                saveButtons.forEach((button, index) => {
                    button.removeEventListener('click', () => saveQuote(quoteId));
                    button.addEventListener('click', () => {
                        console.log(`Save quote button ${index} clicked for quoteId: ${quoteId}`);
                        saveQuote(quoteId);
                    });
                });

                // Initialize existing rows
                const productSelects = document.querySelectorAll(`#items-tbody_${quoteId} .tom-select-product`);
                console.log('Found tom-select-product selects for quoteId:', quoteId, productSelects.length);
                productSelects.forEach(select => {
                    initializeProductTomSelect(select, quoteId);
                    const row = select.closest('.quote-item-row');
                    if (row) {
                        initializeRowCalculations(row);
                        initializeDescriptionToggle(row);
                    }
                });

                const partnerSelects = document.querySelectorAll(`#quoteBaseInfoForm_${quoteId} .tom-select`);
                console.log('Found tom-select partner selects for quoteId:', quoteId, partnerSelects.length);
                partnerSelects.forEach(select => {
                    initializePartnerTomSelect(select, quoteId);
                });

                initializeDeleteButtons(quoteId);
                initializeQuoteDiscountCalculations(quoteId);
                calculateQuoteTotals(quoteId);
                console.log('Event listeners initialized for quoteId:', quoteId);
            }

            // Initialize all modals
            document.querySelectorAll('.modal[id^="editQuoteModal_"]').forEach(modal => {
                const quoteId = modal.id.replace('editQuoteModal_', '');
                modal.addEventListener('shown.bs.modal', function () {
                    console.log('Edit modal shown for quoteId:', quoteId);
                    initializeEventListeners(quoteId);
                    calculateQuoteTotals(quoteId);
                });
            });

            // Initialize new quote modal
            const newQuoteModal = document.getElementById('newQuoteModal');
            if (newQuoteModal) {
                newQuoteModal.addEventListener('shown.bs.modal', function () {
                    console.log('New quote modal shown for quoteId: new');
                    initializeEventListeners('new');
                    calculateQuoteTotals('new');
                });
            }
        });
    </script>
}


    <script>
        // Ajánlat másolása. csak külön script-ben működik, ezért kell ide is a showtoast.
            function showToast(type, message) {
                // Create the toast element
                const toast = $(`
                    <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">${message}</div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                `);

                // Append toast to the container
                $('#toastContainer').append(toast);

                // Initialize and show the toast
                const bsToast = new bootstrap.Toast(toast[0]);
                bsToast.show();

                // Remove the toast after 5 seconds
                setTimeout(() => toast.remove(), 5500); // Includes 500ms fade-out
            }

            async function copyQuote(quoteId) {
                try {
                    const response = await fetch(`/api/Quotes/${quoteId}/copy`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        }
                    });

                    const result = await response.json();
                    if (response.ok && result) {
                        showToast('success', `Árajánlat sikeresen másolva! Új szám: ${result.quoteNumber}`);
                        
                        // Delay the reload to let the toast be visible
                        setTimeout(() => location.reload(), 3000); // Reload after 3 seconds
                    } else {
                        showToast('error', result.error || 'Másolás sikertelen.');
                    }
                } catch (error) {
                    showToast('error', 'Hiba történt a másolás során.');
                    console.error('[Error] Copy quote error:', error);
                }
            }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.copy-quote-btn').forEach(button => {
                button.addEventListener('click', function (e) {
                    e.preventDefault();
                    const quoteId = this.getAttribute('data-quote-id');
                    copyQuote(quoteId);
                });
            });
        });
    </script>

}

<style>

    .table .description-row {
        background-color: #f8f9fa; /* Light background for description row */
    }
    .table .description-row td {
        padding: 10px;
    }
    .table .description {
        resize: vertical;
        min-height: 60px;
        max-height: 100px;
        width: 100%;
    }
    .table th:nth-child(1), .table td:nth-child(1) { /* Product column */
        max-width: 200px;
    }
    .btn-link {
        text-decoration: none;
    }
    .nav-tabs {
        margin-bottom: 15px;
    }
    .tab-content {
        min-height: 200px; /* Ensure tab content has enough space */
    }

.drag-handle {
    cursor: move;
    width: 30px;
    text-align: center;
    vertical-align: middle;
}

.drag-handle .bi-grip-vertical {
    font-size: 1.2rem;
    color: #6c757d;
}

#quoteItemsTable tbody tr:hover .drag-handle .bi-grip-vertical {
    color: #007bff;
}

#quoteItemsTable .placeholder {
    background-color: #f8f9fa;
    border: 2px dashed #007bff;
    height: 50px;
}



[data-theme="dark"] .partner-card {
        background-color: #2a2a2a;
        border: 1px solid #444;
    }


/* Badge styling */
.badge-draft { background-color: #6c757d; }
.badge-sent { background-color: #007bff; }
.badge-accepted { background-color: #28a745; }
.badge-rejected { background-color: #dc3545; }

    /* Ensure textarea in Leírás column is wider and readable */
    #quoteItemsTable .itemDescription {
        width: 100%;
        min-width: 200px;
        height: 60px;
        resize: vertical;
    }
    /* Adjust table column widths */
    #quoteItemsTable th:nth-child(2), #quoteItemsTable td:nth-child(2) {
        width: 30%;
    }

        /* Card-based layout matching Leads page */
        .card-grid-header {
            padding: 0 15px 2px 15px;
            margin-top: 0px;
            background-color: #F1EFEC;
            border-bottom: 1px solid #dee2e6;
        }

        .card-grid-row {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
        }

        .card-grid-column {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .card-grid-cell {
            padding: 0 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Column widths */
        .quote-number-col { flex: 1 1 15%; min-width: 120px; }
        .quote-partner-col { flex: 1 1 25%; min-width: 150px; }
        .quote-date-col { flex: 1 1 15%; min-width: 100px; }
        .quote-status-col { flex: 1 1 15%; min-width: 100px; }
        .quote-amount-col { flex: 1 1 15%; min-width: 120px; }
        .actions-column, .actions-cell { flex: 0 0 auto; width: auto; text-align: right; padding-right: 10px; }

        /* Button group styling */
        .btn-group-sm .btn {
            padding: 0.2rem 0.5rem;
            font-size: 0.875rem;
        }

        /* Badge styling */
        .badge-draft { background-color: #6c757d; }
        .badge-sent { background-color: #007bff; }
        .badge-accepted { background-color: #28a745; }
        .badge-rejected { background-color: #dc3545; }

        /* Ensure pagination is centered */
        .fixed-footer .pagination {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-bottom: 0;
        }

        .fixed-footer nav {
            flex-grow: 1;
            text-align: center;
        }

        /* Modal Sizing */
        .modal-lg { max-width: 1000px !important; }

        /* Consistent Tab Content Styling */
        #newQuoteModal .tab-content,
        #newQuoteItemModal .tab-content,
        [id^="editQuoteModal_"] .tab-content,
        [id^="newQuoteItemModal_"] .tab-content,
        [id^="viewQuoteModal_"] .tab-content {
            min-width: 0;
            width: 100%;
            min-height: 450px;
            max-height: 65vh;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 1rem;
            background-color: #fff;
        }

        /* Consistent Tab Pane Styling */
        #newQuoteModal .tab-pane,
        #newQuoteItemModal .tab-pane,
        [id^="editQuoteModal_"] .tab-pane,
        [id^="newQuoteItemModal_"] .tab-pane,
        [id^="viewQuoteModal_"] .tab-pane {
            width: 100%;
        }

        /* Adjust Modal Body Padding */
        #newQuoteModal .modal-body,
        #newQuoteItemModal .modal-body,
        [id^="editQuoteModal_"] .modal-body,
        [id^="newQuoteItemModal_"] .modal-body,
        [id^="viewQuoteModal_"] .modal-body {
            padding: 1rem 1rem 0 1rem;
        }

        /* Remove margin below tabs */
        #newQuoteModal .nav-tabs,
        [id^="editQuoteModal_"] .nav-tabs,
        [id^="viewQuoteModal_"] .nav-tabs {
            margin-bottom: 0 !important;
        }

        /* General Table Cell Styling */
        .table tbody tr td {
            vertical-align: middle;
        }

        /* View Modal Specific Content Styling */
        [id^="viewQuoteModal_"] .table {
            margin-bottom: 0;
        }

        [id^="viewQuoteModal_"] .tab-pane > p {
            padding: 1.5rem;
            text-align: center;
            color: #6c757d;
        }

        /* Select2 styling */
.select2-container {
            width: 100% !important;
        }

        .select2-container {
    z-index: 1060; /* Higher than Bootstrap modal */
}

        .select2-container--bootstrap-5 .select2-selection--single {
            height: 38px;
            padding: 0.375rem 2.25rem 0.375rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            background-color: #fff;
        }

        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
            line-height: 1.5;
            padding-top: 0;
            padding-bottom: 0;
            color: #495057;
        }

        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__arrow {
            height: 38px;
            right: 0.75rem;
        }

        .select2-container--bootstrap-5 .select2-dropdown {
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
        }

        .select2-container-wrapper {
            position: relative;
        }

        [data-theme="dark"] .select2-container--bootstrap-5 .select2-selection--single {
            background-color: #3a3a3a;
            border-color: #666;
            color: #e0e0e0;
        }

        [data-theme="dark"] .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
            color: #e0e0e0;
        }

        [data-theme="dark"] .select2-container--bootstrap-5 .select2-dropdown {
            background-color: #2a2a2a;
            border-color: #666;
            color: #e0e0e0;
        }

        [data-theme="dark"] .select2-container--bootstrap-5 .select2-results__option {
            color: #e0e0e0;
        }

        [data-theme="dark"] .select2-container--bootstrap-5 .select2-results__option--highlighted {
            background-color: #357abd;
            color: #ffffff;
        }

        /* Dark mode overrides */
        [data-theme="dark"] .card-grid-header {
            background-color: #2a2a2a;
            border-bottom: 1px solid #444;
        }

        [data-theme="dark"] .card-grid-column {
            color: #b0b0b0;
        }

        [data-theme="dark"] .quote-card {
            background-color: #2a2a2a;
            border: 1px solid #444;
        }

        [data-theme="dark"] .fixed-footer {
            background-color: #2a2a2a;
            border-top: 1px solid #444;
        }

        [data-theme="dark"] .alert-success {
            background-color: #2e7d32;
            border-color: #1b5e20;
            color: #e0e0e0;
        }

        [data-theme="dark"] .alert-danger {
            background-color: #d32f2f;
            border-color: #b71c1c;
            color: #e0e0e0;
        }

        [data-theme="dark"] #newQuoteModal .tab-content,
        [data-theme="dark"] #newQuoteItemModal .tab-content,
        [data-theme="dark"] [id^="editQuoteModal_"] .tab-content,
        [data-theme="dark"] [id^="newQuoteItemModal_"] .tab-content,
        [data-theme="dark"] [id^="viewQuoteModal_"] .tab-content,
        [data-theme="dark"] [id^="deleteQuoteModal_"] .tab-content {
            background-color: #2a2a2a !important;
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] #newQuoteModal .tab-pane,
        [data-theme="dark"] #newQuoteItemModal .tab-pane,
        [data-theme="dark"] [id^="editQuoteModal_"] .tab-pane,
        [data-theme="dark"] [id^="newQuoteItemModal_"] .tab-pane,
        [data-theme="dark"] [id^="viewQuoteModal_"] .tab-pane,
        [data-theme="dark"] [id^="deleteQuoteModal_"] .tab-pane {
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] #newQuoteModal .modal-body,
        [data-theme="dark"] #newQuoteItemModal .modal-body,
        [data-theme="dark"] [id^="editQuoteModal_"] .modal-body,
        [data-theme="dark"] [id^="newQuoteItemModal_"] .modal-body,
        [data-theme="dark"] [id^="viewQuoteModal_"] .modal-body,
        [data-theme="dark"] [id^="deleteQuoteModal_"] .modal-body {
            background-color: #2a2a2a !important;
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] .form-control {
            background-color: #333333 !important;
            border-color: #666 !important;
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] .form-control:focus {
            background-color: #333333 !important;
            border-color: #888 !important;
            color: #e0e0e0 !important;
            box-shadow: 0 0 0 0.2rem rgba(100, 100, 100, 0.25) !important;
        }

        [data-theme="dark"] .form-control::placeholder {
            color: #aaaaaa !important;
        }

        [data-theme="dark"] .form-label {
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] .modal-title {
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] #newQuoteModal .nav-tabs,
        [data-theme="dark"] [id^="editQuoteModal_"] .nav-tabs,
        [data-theme="dark"] [id^="viewQuoteModal_"] .nav-tabs {
            background-color: #2a2a2a !important;
            border-bottom: 1px solid #444 !important;
        }

        [data-theme="dark"] #newQuoteModal .nav-tabs .nav-link,
        [data-theme="dark"] [id^="editQuoteModal_"] .nav-tabs .nav-link,
        [data-theme="dark"] [id^="viewQuoteModal_"] .nav-tabs .nav-link {
            color: #b0b0b0 !important;
        }

        [data-theme="dark"] #newQuoteModal .nav-tabs .nav-link:hover,
        [data-theme="dark"] [id^="editQuoteModal_"] .nav-tabs .nav-link:hover,
        [data-theme="dark"] [id^="viewQuoteModal_"] .nav-tabs .nav-link:hover {
            color: #e0e0e0 !important;
            background-color: #3a3a3a !important;
        }

        [data-theme="dark"] #newQuoteModal .nav-tabs .nav-link.active,
        [data-theme="dark"] [id^="editQuoteModal_"] .nav-tabs .nav-link.active,
        [data-theme="dark"] [id^="viewQuoteModal_"] .nav-tabs .nav-link.active {
            color: #e0e0e0 !important;
            background-color: #3a3a3a !important;
            border-color: #444 #444 #2a2a2a !important;
        }

        [data-theme="dark"] [id^="viewQuoteModal_"] .tab-pane > p {
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] [id^="viewQuoteModal_"] .table {
            color: #e0e0e0 !important;
        }

        [data-theme="dark"] [id^="viewQuoteModal_"] .table th,
        [data-theme="dark"] [id^="viewQuoteModal_"] .table td {
            border-color: #444 !important;
            color: #e0e0e0 !important;
        }
    </style>
